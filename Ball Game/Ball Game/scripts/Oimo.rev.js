var OIMO={REVISION:"REV.1.0.0"};OIMO.SHAPE_NULL=0;OIMO.SHAPE_SPHERE=1;OIMO.SHAPE_BOX=2;OIMO.SHAPE_CYLINDER=3;OIMO.MAX_BODIES=16384;OIMO.WORLD_MAX_SHAPES=32768;OIMO.MAX_CONTACTS=65536;OIMO.MAX_JOINTS=16384;OIMO.MAX_CONSTRAINTS=OIMO.MAX_CONTACTS+OIMO.MAX_JOINTS;OIMO.MAX_SHAPES=64;OIMO.BODY_DYNAMIC=0;OIMO.BODY_STATIC=1;OIMO.WORLD_SCALE=100;OIMO.INV_SCALE=.01;OIMO.TO_RAD=Math.PI/180;OIMO.nextID=0;OIMO.World=function(e,t,n){var r=t||2;this.timeStep=e||1/60;this.iteration=n||8;this.rigidBodies=[];this.rigidBodies.length=OIMO.MAX_BODIES;this.numRigidBodies=0;this.shapes=[];this.shapes.length=OIMO.WORLD_MAX_SHAPES;this.numShapes=0;this.contacts=null;this.prevContacts=null;this.contactPool1=[];this.contactPool2=[];this.contactPool1.length=OIMO.MAX_CONTACTS;this.contactPool2.length=OIMO.MAX_CONTACTS;this.numContacts=0;this.numPrevContacts1=0;this.numPrevContacts2=0;this.joints=[];this.joints.length=OIMO.MAX_JOINTS;this.numJoints=0;this.numIslands=0;this.constraints=[];this.constraints.length=OIMO.MAX_CONSTRAINTS;this.numConstraints=0;this.collisionResult=new OIMO.CollisionResult(OIMO.MAX_CONTACTS);this.islandStack=[];this.islandStack.length=OIMO.MAX_BODIES;this.islandRigidBodies=[];this.islandRigidBodies.length=OIMO.MAX_BODIES;this.islandNumRigidBodies=0;this.islandConstraints=[];this.islandConstraints.length=OIMO.MAX_CONSTRAINTS;this.islandNumConstraints=0;switch(r){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;case 2:default:this.broadPhase=new OIMO.SweepAndPruneBroadPhase;break}this.gravity=new OIMO.Vec3(0,-9.80665,0);this.performance=new OIMO.Performance;var i=4;this.detectors=[];this.detectors.length=i;for(var s=0;s<i;s++){this.detectors[s]=[];this.detectors[s].length=i}this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(false);this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_CYLINDER]=new OIMO.SphereCylinderCollisionDetector(false);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(true);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=new OIMO.BoxBoxCollisionDetector;this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_SPHERE]=new OIMO.SphereCylinderCollisionDetector(true);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_CYLINDER]=new OIMO.BoxCylinderCollisionDetector(false);this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_BOX]=new OIMO.BoxCylinderCollisionDetector(true);this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_CYLINDER]=new OIMO.CylinderCylinderCollisionDetector;this.contacts=this.contactPool1;this.prevContacts=this.contactPool2;this.randX=65535;this.randA=98765;this.randB=123456789};OIMO.World.prototype={constructor:OIMO.World,clear:function(){this.randX=65535;var e,t;t=this.numRigidBodies;for(e=t-1;e>=0;e--)this.removeRigidBody(this.rigidBodies[e]);t=this.numJoints;for(e=t-1;e>=0;e--)this.removeJoint(this.joints[e])},addRigidBody:function(e){if(this.numRigidBodies==OIMO.MAX_BODIES){throw new Error("It is not possible to add a rigid body to the world any more")}if(e.parent){throw new Error("It is not possible to be added to more than one world one of the rigid body")}e.awake();var t=e.numShapes;for(var n=0;n<t;n++){this.addShape(e.shapes[n])}this.rigidBodies[this.numRigidBodies++]=e;e.parent=this},removeRigidBody:function(e){var t=null;for(var n=0;n<this.numRigidBodies;n++){if(this.rigidBodies[n]==e){t=e;this.rigidBodies[n]=this.rigidBodies[--this.numRigidBodies];this.rigidBodies[this.numRigidBodies]=null;break}}if(t==null)return;t.awake();var r=t.jointList;while(r!=null){var i=r.parent;r=r.next;this.removeJoint(i)}var s=t.numShapes;for(n=0;n<s;n++){this.removeShape(t.shapes[n])}t.parent=null},addShape:function(e){if(this.numShapes==OIMO.WORLD_MAX_SHAPES){throw new Error("It is not possible to add a shape to the world any more")}if(!e.parent){throw new Error("It is not possible to be added alone to shape world")}if(e.parent.parent){throw new Error("It is not possible to be added to multiple world the shape of one")}this.broadPhase.addProxy(e.proxy);this.shapes[this.numShapes++]=e},removeShape:function(e){var t=null;for(var n=0;n<this.numShapes;n++){if(this.shapes[n]==e){t=e;this.shapes[n]=this.shapes[--this.numShapes];this.shapes[this.numShapes]=null;break}}if(t==null)return;this.broadPhase.removeProxy(t.proxy)},addJoint:function(e){if(this.numJoints==OIMO.World.MAX_JOINTS){throw new Error("It is not possible to add a joint to the world any more")}if(e.parent){throw new Error("It is not possible to be added to more than one world one of the joint")}var t=e.body1;var n=e.connection1;t.awake();t.numJoints++;n.next=t.jointList;if(t.jointList!=null){t.jointList.prev=n}t.jointList=n;t=e.body2;n=e.connection2;t.awake();t.numJoints++;n.next=t.jointList;if(t.jointList!=null){t.jointList.prev=n}t.jointList=n;this.joints[this.numJoints++]=e;e.parent=this},removeJoint:function(e){var t=null;for(var n=0;n<this.numJoints;n++){if(this.joints[n]==e){t=e;this.joints[n]=this.joints[--this.numJoints];this.joints[this.numJoints]=null;break}}if(t==null)return;t.body1.awake();t.body1.numJoints--;t.body2.awake();t.body2.numJoints--;var r=t.connection1;if(r.prev!=null){r.prev.next=r.next;r.prev=null}if(r.next!=null){r.next.prev=r.prev;r.next=null}r=t.connection2;if(r.prev!=null){r.prev.next=r.next;r.prev=null}if(r.next!=null){r.next.prev=r.prev;r.next=null}t.parent=null},getByName:function(e){var t=null;var n,r,i,s;r=this.numRigidBodies;for(n=r-1;n>=0;n--){i=this.rigidBodies[n];if(i.name!==""&&i.name===e)t=i}r=this.numJoints;for(n=r-1;n>=0;n--){s=this.joints[n];if(s.name!==""&&s.name===e)t=s}return t},step:function(){var e=Date.now();var t=this.contacts;this.contacts=this.prevContacts;this.prevContacts=t;var n=this.numRigidBodies;while(n--){var r=this.rigidBodies[n];if(r.sleeping){var i=r.linearVelocity;var s=r.linearVelocity;var o=r.position;var u=r.sleepPosition;var a=r.orientation;var f=r.sleepOrientation;if(i.x!=0||i.y!=0||i.z!=0||s.x!=0||s.y!=0||s.z!=0||o.x!=u.x||o.y!=u.y||o.z!=u.z||a.s!=f.s||a.x!=f.x||a.y!=f.y||a.z!=f.z){r.awake();continue}}}this.detectCollisions();this.updateIslands();var l=Date.now();if(l-1e3>this.performance.time_prev){this.performance.time_prev=l;this.performance.fpsint=this.performance.fps;this.performance.fps=0}this.performance.fps++;this.performance.solvingTime=l-this.performance.solvingTime;this.performance.totalTime=l-e},detectCollisions:function(){this.collectContactInfos();this.setupContacts()},collectContactInfos:function(){var e=Date.now();this.broadPhase.detectPairs();var t=Date.now();this.performance.broadPhaseTime=t-e;this.collisionResult.numContactInfos=0;var n=this.broadPhase.pairs;var r=this.broadPhase.numPairs;for(var i=0;i<r;i++){var s=n[i];var o=s.shape1;var u=s.shape2;var a=this.detectors[o.type][u.type];if(a){a.detectCollision(o,u,this.collisionResult);if(this.collisionResult.numContactInfos==OIMO.MAX_CONTACTS){return}}}var f=Date.now();this.performance.narrowPhaseTime=f-t;this.performance.updatingTime=f},setupContacts:function(){this.numPrevContacts2=this.numPrevContacts1;this.numPrevContacts1=this.numContacts;var e=0;for(var t=0;t<this.numPrevContacts1;t++){var n=this.prevContacts[t];if(n.sleeping){this.prevContacts[t]=this.contacts[e];this.contacts[e++]=n}}var r=this.collisionResult.contactInfos;this.numContacts=e+this.collisionResult.numContactInfos;for(t=e;t<this.numContacts;t++){if(!this.contacts[t]){this.contacts[t]=new OIMO.Contact}n=this.contacts[t];n.setupFromContactInfo(r[t-e]);var i=n.shape1;var s=n.shape2;var o;if(i.numContacts<s.numContacts)o=i.contactList;else o=s.contactList;while(o!=null){var u=o.parent;if((u.shape1==n.shape1&&u.shape2==n.shape2||u.shape1==n.shape2&&u.shape2==n.shape1)&&u.id.equals(n.id)){n.normalImpulse=u.normalImpulse;n.tangentImpulse=u.tangentImpulse;n.binormalImpulse=u.binormalImpulse;n.warmStarted=true;break}o=o.next}}for(t=this.numContacts;t<this.numPrevContacts2;t++){this.contacts[t].removeReferences()}},updateIslands:function(){var e=1/this.timeStep;var t;var n;var r;var i;for(var s=0;s<this.numShapes;s++){r=this.shapes[s];r.contactList=null;r.numContacts=0}for(s=0;s<this.numRigidBodies;s++){n=this.rigidBodies[s];n.contactList=null;n.addedToIsland=false}this.numConstraints=0;for(s=0;s<this.numContacts;s++){var o=this.contacts[s];o.addedToIsland=false;var u=o.shapeConnection1;r=o.shape1;u.prev=null;u.next=r.contactList;if(r.contactList!=null){r.contactList.prev=u}r.contactList=u;r.numContacts++;u=o.shapeConnection2;r=o.shape2;u.prev=null;u.next=r.contactList;if(r.contactList!=null){r.contactList.prev=u}r.contactList=u;r.numContacts++;u=o.bodyConnection1;n=o.body1;u.prev=null;u.next=n.contactList;if(n.contactList!=null){n.contactList.prev=u}n.contactList=u;u=o.bodyConnection2;n=o.body2;u.prev=null;u.next=n.contactList;if(n.contactList!=null){n.contactList.prev=u}n.contactList=u;this.constraints[this.numConstraints++]=o}for(s=0;s<this.numJoints;s++){t=this.joints[s];t.addedToIsland=false;this.constraints[this.numConstraints++]=t}for(s=1;s<this.numConstraints;s++){var a=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*s|0;t=this.constraints[s];this.constraints[s]=this.constraints[a];this.constraints[a]=t}var f=Date.now();this.performance.updatingTime=f-this.performance.updatingTime;this.performance.solvingTime=f;this.numIslands=0;for(s=0;s<this.numRigidBodies;s++){var l=this.rigidBodies[s];if(l.addedToIsland||l.type==OIMO.BODY_STATIC||l.sleeping)continue;this.islandNumRigidBodies=0;this.islandNumConstraints=0;var c=1;this.islandStack[0]=l;l.addedToIsland=true;while(c>0){n=this.islandStack[--c];n.sleeping=false;this.islandRigidBodies[this.islandNumRigidBodies++]=n;u=n.contactList;while(u!=null){t=u.parent;if(t.addedToIsland){u=u.next;continue}this.islandConstraints[this.islandNumConstraints++]=t;t.addedToIsland=true;t.sleeping=false;var h=u.connectedBody;if(h.addedToIsland||h.type==OIMO.BODY_STATIC){u=u.next;continue}this.islandStack[c++]=h;h.addedToIsland=true;u=u.next}var p=n.jointList;while(p!=null){t=p.parent;if(t.addedToIsland){p=p.next;continue}this.islandConstraints[this.islandNumConstraints++]=t;t.addedToIsland=true;t.sleeping=false;h=p.connected;if(h.addedToIsland||h.type==OIMO.BODY_STATIC){p=p.next;continue}this.islandStack[c++]=h;h.addedToIsland=true;p=p.next}}for(var d=0;d<this.islandNumRigidBodies;d++){n=this.islandRigidBodies[d];n.updateVelocity(this.timeStep,this.gravity)}for(d=0;d<this.islandNumConstraints;d++){this.islandConstraints[d].preSolve(this.timeStep,e)}for(d=0;d<this.iteration;d++){for(var v=0;v<this.islandNumConstraints;v++){this.islandConstraints[v].solve()}}for(d=0;d<this.islandNumConstraints;d++){this.islandConstraints[d].postSolve()}var m=1e3;for(d=0;d<this.islandNumRigidBodies;d++){n=this.islandRigidBodies[d];if(!n.allowSleep){n.sleepTime=0;m=0;continue}var g=n.linearVelocity.x;var y=n.linearVelocity.y;var b=n.linearVelocity.z;if(g*g+y*y+b*b>.01){n.sleepTime=0;m=0;continue}g=n.angularVelocity.x;y=n.angularVelocity.y;b=n.angularVelocity.z;if(g*g+y*y+b*b>.04){n.sleepTime=0;m=0;continue}n.sleepTime+=this.timeStep;if(n.sleepTime<m)m=n.sleepTime}if(m>.5){for(d=0;d<this.islandNumRigidBodies;d++){n=this.islandRigidBodies[d];n.linearVelocity.init();n.angularVelocity.init();n.sleepPosition.copy(n.position);n.sleepOrientation.copy(n.orientation);n.sleepTime=0;n.sleeping=true}for(d=0;d<this.islandNumConstraints;d++){this.islandConstraints[d].sleeping=true}}else{for(d=0;d<this.islandNumRigidBodies;d++){this.islandRigidBodies[d].updatePosition(this.timeStep)}}this.numIslands++}}};OIMO.RigidBody=function(e,t,n,r){var i=e||0;var s=t||0;var o=n||0;var u=r||0;this.name="";this.type=0;this.position=null;this.mass=NaN;this.invertMass=NaN;this.shapes=[];this.shapes.length=OIMO.MAX_SHAPES;this.numShapes=0;this.parent=null;this.contactList=null;this.jointList=null;this.numJoints=0;this.addedToIsland=false;this.sleeping=false;var a=s*s+o*o+u*u;this.position=new OIMO.Vec3;if(a>0){a=1/Math.sqrt(a);s*=a;o*=a;u*=a}var f=Math.sin(i*.5);var l=Math.cos(i*.5);this.orientation=new OIMO.Quat(l,f*s,f*o,f*u);this.linearVelocity=new OIMO.Vec3;this.angularVelocity=new OIMO.Vec3;this.sleepPosition=new OIMO.Vec3;this.sleepOrientation=new OIMO.Quat;this.rotation=new OIMO.Mat33;this.invertInertia=new OIMO.Mat33;this.localInertia=new OIMO.Mat33;this.invertLocalInertia=new OIMO.Mat33;this.matrix=new OIMO.Mat44;this.allowSleep=true;this.sleepTime=0};OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(e){if(this.numShapes==OIMO.MAX_SHAPES){throw new Error("It is not possible to add more shape to the rigid")}if(e.parent){throw new Error("It is not possible that you add to the multi-rigid body the shape of one")}this.shapes[this.numShapes++]=e;e.parent=this;if(this.parent)this.parent.addShape(e)},removeShape:function(e,t){if(arguments.length<2){t=-1}if(t<0){for(var n=0;n<this.numShapes;n++){if(e==this.shapes[n]){t=n;break}}if(t==-1){return}}else if(t>=this.numShapes){throw new Error("The index of the shape you want to delete is out of range")}var r=this.shapes[t];r.parent=null;if(this.parent)this.parent.removeShape(r);this.numShapes--;for(var i=t;i<this.numShapes;i++){this.shapes[i]=this.shapes[i+1]}this.shapes[this.numShapes]=null},setupMass:function(e){this.type=e||OIMO.BODY_DYNAMIC;this.position.init();this.mass=0;this.localInertia.init(0,0,0,0,0,0,0,0,0);var t=this.localInertia.elements;var n=new OIMO.Mat33;n.transpose(this.rotation);var r=new OIMO.Mat33;var i=new OIMO.Vec3;var s=0;for(var o=0;o<this.numShapes;o++){var u=this.shapes[o];u.relativeRotation.mul(n,u.rotation);this.position.add(this.position,i.scale(u.position,u.mass));s+=u.mass;this.mass+=u.mass;r.mul(u.relativeRotation,r.mul(u.localInertia,r.transpose(u.relativeRotation)));this.localInertia.add(this.localInertia,r)}this.position.scale(this.position,1/s);this.invertMass=1/this.mass;var a=0;var f=0;var l=0;for(var c=0;c<this.numShapes;c++){u=this.shapes[c];var h=u.localRelativePosition;h.sub(u.position,this.position).mulMat(n,h);u.updateProxy();t[0]+=u.mass*(h.y*h.y+h.z*h.z);t[4]+=u.mass*(h.x*h.x+h.z*h.z);t[8]+=u.mass*(h.x*h.x+h.y*h.y);a-=u.mass*h.x*h.y;f-=u.mass*h.y*h.z;l-=u.mass*h.z*h.x}t[1]=a;t[3]=a;t[2]=l;t[6]=l;t[5]=f;t[7]=f;this.invertLocalInertia.invert(this.localInertia);if(e==OIMO.BODY_STATIC){this.invertMass=0;this.invertLocalInertia.init(0,0,0,0,0,0,0,0,0)}var p=this.rotation.elements;var d=this.invertLocalInertia.elements;var v=p[0];var m=p[1];var g=p[2];var y=p[3];var b=p[4];var w=p[5];var E=p[6];var S=p[7];var x=p[8];var T=d[0];var N=d[1];var C=d[2];var k=d[3];var L=d[4];var A=d[5];var O=d[6];var M=d[7];var _=d[8];var D=v*T+m*k+g*O;var P=v*N+m*L+g*M;var H=v*C+m*A+g*_;var B=y*T+b*k+w*O;var j=y*N+b*L+w*M;var F=y*C+b*A+w*_;var I=E*T+S*k+x*O;var q=E*N+S*L+x*M;var R=E*C+S*A+x*_;var U=this.invertInertia.elements;U[0]=D*v+P*m+H*g;U[1]=D*y+P*b+H*w;U[2]=D*E+P*S+H*x;U[3]=B*v+j*m+F*g;U[4]=B*y+j*b+F*w;U[5]=B*E+j*S+F*x;U[6]=I*v+q*m+R*g;U[7]=I*y+q*b+R*w;U[8]=I*E+q*S+R*x;this.syncShapes();this.awake()},awake:function(){if(!this.allowSleep)return;this.sleepTime=0;if(this.sleeping){var e=this.contactList;while(e!=null){e.connectedBody.sleepTime=0;e.connectedBody.sleeping=false;e.parent.sleeping=false;e=e.next}var t=this.jointList;while(t!=null){t.connected.sleepTime=0;t.connected.sleeping=false;t.parent.sleeping=false;t=t.next}}this.sleeping=false},sleep:function(){if(!this.allowSleep)return;this.linearVelocity.init();this.angularVelocity.init();this.sleepPosition.copy(this.position);this.sleepOrientation.copy(this.orientation);this.sleepTime=0;this.sleeping=true},updateVelocity:function(e,t){if(this.type==OIMO.BODY_DYNAMIC){this.linearVelocity.x+=t.x*e;this.linearVelocity.y+=t.y*e;this.linearVelocity.z+=t.z*e}},updatePosition:function(e){if(!this.allowSleep)this.sleepTime=0;if(this.type==OIMO.BODY_STATIC){this.linearVelocity.x=0;this.linearVelocity.y=0;this.linearVelocity.z=0;this.angularVelocity.x=0;this.angularVelocity.y=0;this.angularVelocity.z=0}else if(this.type==OIMO.BODY_DYNAMIC){var t=this.linearVelocity.x;var n=this.linearVelocity.y;var r=this.linearVelocity.z;if(t*t+n*n+r*r>.01)this.sleepTime=0;this.position.x+=t*e;this.position.y+=n*e;this.position.z+=r*e;t=this.angularVelocity.x;n=this.angularVelocity.y;r=this.angularVelocity.z;if(t*t+n*n+r*r>.025)this.sleepTime=0;var i=this.orientation.s;var s=this.orientation.x;var o=this.orientation.y;var u=this.orientation.z;e*=.5;var a=(-t*s-n*o-r*u)*e;var f=(t*i+n*u-r*o)*e;var l=(-t*u+n*i+r*s)*e;var c=(t*o-n*s+r*i)*e;i+=a;s+=f;o+=l;u+=c;a=1/Math.sqrt(i*i+s*s+o*o+u*u);this.orientation.s=i*a;this.orientation.x=s*a;this.orientation.y=o*a;this.orientation.z=u*a}else{throw new Error("The type of rigid body of undefined")}this.syncShapes()},syncShapes:function(){var e=this.orientation.s;var t=this.orientation.x;var n=this.orientation.y;var r=this.orientation.z;var i=2*t;var s=2*n;var o=2*r;var u=t*i;var a=n*s;var f=r*o;var l=t*s;var c=n*o;var h=t*o;var p=e*i;var d=e*s;var v=e*o;var m=this.rotation.elements;var g=this.invertLocalInertia.elements;m[0]=1-a-f;m[1]=l-v;m[2]=h+d;m[3]=l+v;m[4]=1-u-f;m[5]=c-p;m[6]=h-d;m[7]=c+p;m[8]=1-u-a;var y=m[0];var b=m[1];var w=m[2];var E=m[3];var S=m[4];var x=m[5];var T=m[6];var N=m[7];var C=m[8];var k=g[0];var L=g[1];var A=g[2];var O=g[3];var M=g[4];var _=g[5];var D=g[6];var P=g[7];var H=g[8];var B=y*k+b*O+w*D;var j=y*L+b*M+w*P;var F=y*A+b*_+w*H;var I=E*k+S*O+x*D;var q=E*L+S*M+x*P;var R=E*A+S*_+x*H;var U=T*k+N*O+C*D;var z=T*L+N*M+C*P;var W=T*A+N*_+C*H;var X=this.invertInertia.elements;X[0]=B*y+j*b+F*w;X[1]=B*E+j*S+F*x;X[2]=B*T+j*N+F*C;X[3]=I*y+q*b+R*w;X[4]=I*E+q*S+R*x;X[5]=I*T+q*N+R*C;X[6]=U*y+z*b+W*w;X[7]=U*E+z*S+W*x;X[8]=U*T+z*N+W*C;for(var V=0;V<this.numShapes;V++){var $=this.shapes[V];var J=$.relativePosition;var K=$.localRelativePosition;var Q=$.relativeRotation.elements;var G=$.rotation.elements;var Y=K.x;var Z=K.y;var et=K.z;J.x=Y*y+Z*b+et*w;J.y=Y*E+Z*S+et*x;J.z=Y*T+Z*N+et*C;$.position.x=this.position.x+J.x;$.position.y=this.position.y+J.y;$.position.z=this.position.z+J.z;B=Q[0];j=Q[1];F=Q[2];I=Q[3];q=Q[4];R=Q[5];U=Q[6];z=Q[7];W=Q[8];G[0]=y*B+b*I+w*U;G[1]=y*j+b*q+w*z;G[2]=y*F+b*R+w*W;G[3]=E*B+S*I+x*U;G[4]=E*j+S*q+x*z;G[5]=E*F+S*R+x*W;G[6]=T*B+N*I+C*U;G[7]=T*j+N*q+C*z;G[8]=T*F+N*R+C*W;$.updateProxy()}},applyImpulse:function(e,t){this.linearVelocity.x+=t.x*this.invertMass;this.linearVelocity.y+=t.y*this.invertMass;this.linearVelocity.z+=t.z*this.invertMass;var n=new OIMO.Vec3;n.sub(e,this.position).cross(n,t).mulMat(this.invertInertia,n);this.angularVelocity.x+=n.x;this.angularVelocity.y+=n.y;this.angularVelocity.z+=n.z},setPosition:function(e,t,n){this.position.init(e*OIMO.INV_SCALE,t*OIMO.INV_SCALE,n*OIMO.INV_SCALE);this.linearVelocity.init();this.angularVelocity.init()},setOrientation:function(e,t,n){var r=OIMO.EulerToAxis(e,t,n);var i=r[0],s=r[1],o=r[2],u=r[3];var a=s*s+o*o+u*u;if(a>0){a=1/Math.sqrt(a);s*=a;o*=a;u*=a}var f=Math.sin(i*.5);var l=Math.cos(i*.5);this.orientation=new OIMO.Quat(l,f*s,f*o,f*u);this.angularVelocity.init()},setRotation:function(e,t,n){},getMatrix:function(){var e=this.matrix.elements;var t,n;if(!this.sleeping){t=this.rotation.elements;e[0]=t[0];e[1]=t[3];e[2]=t[6];e[3]=0;e[4]=t[1];e[5]=t[4];e[6]=t[7];e[7]=0;e[8]=t[2];e[9]=t[5];e[10]=t[8];e[11]=0;n=this.position;e[12]=n.x*OIMO.WORLD_SCALE;e[13]=n.y*OIMO.WORLD_SCALE;e[14]=n.z*OIMO.WORLD_SCALE;e[15]=0}else{e[15]=1}return e}};OIMO.Body=function(e){var t=e||{};if(!t.world)return;this.name=t.name||"";var n=t.move||false;var r=t.noSleep||false;var i=t.pos||[0,0,0];i=i.map(function(e){return e*OIMO.INV_SCALE});var s=t.size||[1,1,1];s=s.map(function(e){return e*OIMO.INV_SCALE});var o=t.rot||[0,0,0];o=o.map(function(e){return e*OIMO.TO_RAD});var u=[];for(var a=0;a<o.length/3;a++){var f=OIMO.EulerToAxis(o[a+0],o[a+1],o[a+2]);u.push(f[0]);u.push(f[1]);u.push(f[2]);u.push(f[3])}var l=t.sc||new OIMO.ShapeConfig;if(t.config){l.density=t.config[0]||1;l.friction=t.config[1]||.5;l.restitution=t.config[2]||.5}l.position.init(i[0],i[1],i[2]);this.body=new OIMO.RigidBody(u[0],u[1],u[2],u[3]);var c=[];var h=t.type||"box";if(typeof h==="string")h=[h];var p,d;for(var a=0;a<h.length;a++){p=a*3;d=a*4;switch(h[a]){case"sphere":c[a]=new OIMO.SphereShape(l,s[p+0]);break;case"cylinder":c[a]=new OIMO.CylinderShape(l,s[p+0],s[p+1]);break;case"box":c[a]=new OIMO.BoxShape(l,s[p+0],s[p+1],s[p+2]);break}this.body.addShape(c[a]);if(a>0){c[a].position.init(i[0]+i[p+0],i[1]+i[p+1],i[2]+i[p+2])}}if(n){this.body.setupMass(OIMO.BODY_DYNAMIC);if(r)this.body.allowSleep=false;else this.body.allowSleep=true}else{this.body.setupMass(OIMO.BODY_STATIC)}this.body.name=this.name;t.world.addRigidBody(this.body)};OIMO.Link=function(e){var t=e||{};if(!t.world)return;this.name=t.name||"";var n=t.type||"jointHinge";var r=t.axe1||[1,0,0];var i=t.axe2||[1,0,0];var s=t.pos1||[0,0,0];var o=t.pos2||[0,0,0];s=s.map(function(e){return e*OIMO.INV_SCALE});o=o.map(function(e){return e*OIMO.INV_SCALE});var u=t.max||10;u=u*OIMO.INV_SCALE;var a=new OIMO.JointConfig;a.allowCollision=t.collision||false;a.localAxis1.init(r[0],r[1],r[2]);a.localAxis2.init(i[0],i[1],i[2]);a.localRelativeAnchorPosition1.init(s[0],s[1],s[2]);a.localRelativeAnchorPosition2.init(o[0],o[1],o[2]);if(typeof t.body1=="string"||t.body1 instanceof String)t.body1=t.world.getByName(t.body1);if(typeof t.body2=="string"||t.body2 instanceof String)t.body2=t.world.getByName(t.body2);switch(n){case"jointBall":this.joint=new OIMO.BallJoint(a,t.body1,t.body2);break;case"jointDistance":this.joint=new OIMO.DistanceJoint(a,t.body1,t.body2,u);break;case"jointHinge":this.joint=new OIMO.HingeJoint(a,t.body1,t.body2);break;case"jointHinge2":this.joint=new OIMO.Hinge2Joint(a,t.body1,t.body2);break}this.joint.name=this.name;t.world.addJoint(this.joint)};OIMO.Performance=function(){this.time_prev=0;this.fpsint=0;this.fps=0;this.broadPhaseTime=0;this.narrowPhaseTime=0;this.solvingTime=0;this.updatingTime=0;this.totalTime=0};OIMO.Mat44=function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){this.elements=new Float32Array(16);var m=this.elements;m[0]=e!==undefined?e:1;m[4]=t||0;m[8]=n||0;m[12]=r||0;m[1]=i||0;m[5]=s!==undefined?s:1;m[9]=o||0;m[13]=u||0;m[2]=a||0;m[6]=f||0;m[10]=l!==undefined?l:1;m[14]=c||0;m[3]=h||0;m[7]=p||0;m[11]=d||0;m[15]=v!==undefined?v:1};OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=this.elements;m[0]=e;m[4]=t;m[8]=n;m[12]=r;m[1]=i;m[5]=s;m[9]=o;m[13]=u;m[2]=a;m[6]=f;m[10]=l;m[14]=c;m[3]=h;m[7]=p;m[11]=d;m[15]=v;return this}};OIMO.Mat33=function(e,t,n,r,i,s,o,u,a){this.elements=new Float32Array(9);var f=this.elements;this.init(e!==undefined?e:1,t||0,n||0,r||0,i!==undefined?i:1,s||0,o||0,u||0,a!==undefined?a:1)};OIMO.Mat33.prototype={constructor:OIMO.Mat33,init:function(e,t,n,r,i,s,o,u,a){var f=this.elements;f[0]=e!==undefined?e:1;f[1]=t||0;f[2]=n||0;f[3]=r||0;f[4]=i!==undefined?i:1;f[5]=s||0;f[6]=o||0;f[7]=u||0;f[8]=a!==undefined?a:1;return this},add:function(e,t){var n=this.elements;var r=e.elements;var i=t.elements;n[0]=r[0]+i[0];n[1]=r[1]+i[1];n[2]=r[2]+i[2];n[3]=r[3]+i[3];n[4]=r[4]+i[4];n[5]=r[5]+i[5];n[6]=r[6]+i[6];n[7]=r[7]+i[7];n[8]=r[8]+i[8];return this},addEqual:function(e){var t=this.elements;var n=e.elements;t[0]+=n[0];t[1]+=n[1];t[2]+=n[2];t[3]+=n[3];t[4]+=n[4];t[5]+=n[5];t[6]+=n[6];t[7]+=n[7];t[8]+=n[8];return this},sub:function(e,t){var n=this.elements;var r=e.elements;var i=t.elements;n[0]=r[0]-i[0];n[1]=r[1]-i[1];n[2]=r[2]-i[2];n[3]=r[3]-i[3];n[4]=r[4]-i[4];n[5]=r[5]-i[5];n[6]=r[6]-i[6];n[7]=r[7]-i[7];n[8]=r[8]-i[8];return this},subEqual:function(e){var t=this.elements;var n=e.elements;t[0]-=n[0];t[1]-=n[1];t[2]-=n[2];t[3]-=n[3];t[4]-=n[4];t[5]-=n[5];t[6]-=n[6];t[7]-=n[7];t[8]-=n[8];return this},scale:function(e,t){var n=this.elements;var r=e.elements;n[0]=r[0]*t;n[1]=r[1]*t;n[2]=r[2]*t;n[3]=r[3]*t;n[4]=r[4]*t;n[5]=r[5]*t;n[6]=r[6]*t;n[7]=r[7]*t;n[8]=r[8]*t;return this},scaleEqual:function(e){var t=this.elements;t[0]*=e;t[1]*=e;t[2]*=e;t[3]*=e;t[4]*=e;t[5]*=e;t[6]*=e;t[7]*=e;t[8]*=e;return this},mul:function(e,t){var n=this.elements;var r=e.elements;var i=t.elements;var s=r[0],o=r[3],u=r[6];var a=r[1],f=r[4],l=r[7];var c=r[2],h=r[5],p=r[8];var d=i[0],v=i[3],m=i[6];var g=i[1],y=i[4],b=i[7];var w=i[2],E=i[5],S=i[8];n[0]=s*d+a*v+c*m;n[1]=s*g+a*y+c*b;n[2]=s*w+a*E+c*S;n[3]=o*d+f*v+h*m;n[4]=o*g+f*y+h*b;n[5]=o*w+f*E+h*S;n[6]=u*d+l*v+p*m;n[7]=u*g+l*y+p*b;n[8]=u*w+l*E+p*S;return this},mulScale:function(e,t,n,r,i){var s=i||false;var o=this.elements;var u=e.elements;if(s){o[0]=t*u[0];o[1]=t*u[1];o[2]=t*u[2];o[3]=n*u[3];o[4]=n*u[4];o[5]=n*u[5];o[6]=r*u[6];o[7]=r*u[7];o[8]=r*u[8]}else{o[0]=u[0]*t;o[1]=u[1]*n;o[2]=u[2]*r;o[3]=u[3]*t;o[4]=u[4]*n;o[5]=u[5]*r;o[6]=u[6]*t;o[7]=u[7]*n;o[8]=u[8]*r}return this},mulRotate:function(e,t,n,r,i,s){var o=s||false;var u=Math.sin(t);var a=Math.cos(t);var f=1-a;var l=n*n*f+a;var c=n*r*f-i*u;var h=n*i*f+r*u;var p=r*n*f+i*u;var d=r*r*f+a;var v=r*i*f-n*u;var m=i*n*f-r*u;var g=i*r*f+n*u;var y=i*i*f+a;var b=e.elements;var w=b[0],E=b[3],S=b[6];var x=b[1],T=b[4],N=b[7];var C=b[2],k=b[5],L=b[8];var A=this.elements;if(o){A[0]=l*w+c*E+h*S;A[1]=l*x+c*T+h*N;A[2]=l*C+c*k+h*L;A[3]=p*w+d*E+v*S;A[4]=p*x+d*T+v*N;A[5]=p*C+d*k+v*L;A[6]=m*w+g*E+y*S;A[7]=m*x+g*T+y*N;A[8]=m*C+g*k+y*L}else{A[0]=w*l+x*p+C*m;A[1]=w*c+x*d+C*g;A[2]=w*h+x*v+C*y;A[3]=E*l+T*p+k*m;A[4]=E*c+T*d+k*g;A[5]=E*h+T*v+k*y;A[6]=S*l+N*p+L*m;A[7]=S*c+N*d+L*g;A[8]=S*h+N*v+L*y}return this},transpose:function(e){var t=this.elements;var n=e.elements;t[0]=n[0];t[1]=n[3];t[2]=n[6];t[3]=n[1];t[4]=n[4];t[5]=n[7];t[6]=n[2];t[7]=n[5];t[8]=n[8];return this},setQuat:function(e){var t=2*e.x;var n=2*e.y;var r=2*e.z;var i=e.x*t;var s=e.y*n;var o=e.z*r;var u=e.x*n;var a=e.y*r;var f=e.x*r;var l=e.s*t;var c=e.s*n;var h=e.s*r;var p=this.elements;p[0]=1-s-o;p[1]=u-h;p[2]=f+c;p[3]=u+h;p[4]=1-i-o;p[5]=a-l;p[6]=f-c;p[7]=a+l;p[8]=1-i-s;return this},invert:function(e){var t=this.elements;var n=e.elements;var r=n[0],i=n[3],s=n[6];var o=n[1],u=n[4],a=n[7];var f=n[2],l=n[5],c=n[8];var h=r*(u*c-a*l)+i*(a*f-o*c)+s*(o*l-u*f);if(h!==0)h=1/h;t[0]=h*(u*c-l*a);t[1]=h*(f*a-o*c);t[2]=h*(o*l-f*u);t[3]=h*(l*s-i*c);t[4]=h*(r*c-f*s);t[5]=h*(f*i-r*l);t[6]=h*(i*a-u*s);t[7]=h*(o*s-r*a);t[8]=h*(r*u-o*i);return this},copy:function(e){var t=this.elements;var n=e.elements;t[0]=n[0];t[1]=n[1];t[2]=n[2];t[3]=n[3];t[4]=n[4];t[5]=n[5];t[6]=n[6];t[7]=n[7];t[8]=n[8];return this},toEuler:function(){function e(e){return Math.min(Math.max(e,-1),1)}var t=this.elements;var n=t[0],r=t[3],i=t[6];var s=t[1],o=t[4],u=t[7];var a=t[2],f=t[5],l=t[8];var c=new OIMO.Vec3;var h=new OIMO.Quat;var p;c.y=Math.asin(e(i));if(Math.abs(i)<.99999){c.x=Math.atan2(-u,l);c.z=Math.atan2(-r,n)}else{c.x=Math.atan2(f,o);c.z=0}return c},clone:function(){var e=this.elements;return new OIMO.Mat33(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},toString:function(){var e=this.elements;var t="Mat33|"+e[0].toFixed(4)+", "+e[1].toFixed(4)+", "+e[2].toFixed(4)+"|\n"+"     |"+e[3].toFixed(4)+", "+e[4].toFixed(4)+", "+e[5].toFixed(4)+"|\n"+"     |"+e[6].toFixed(4)+", "+e[7].toFixed(4)+", "+e[8].toFixed(4)+"|";return t}};OIMO.Quat=function(e,t,n,r){this.s=e!==undefined?e:1;this.x=t||0;this.y=n||0;this.z=r||0};OIMO.Quat.prototype={constructor:OIMO.Quat,init:function(e,t,n,r){this.s=e!==undefined?e:1;this.x=t||0;this.y=n||0;this.z=r||0;return this},add:function(e,t){this.s=e.s+t.s;this.x=e.x+t.x;this.y=e.y+t.y;this.z=e.z+t.z;return this},sub:function(e,t){this.s=e.s-t.s;this.x=e.x-t.x;this.y=e.y-t.y;this.z=e.z-t.z;return this},scale:function(e,t){this.s=e.s*t;this.x=e.x*t;this.y=e.y*t;this.z=e.z*t;return this},mul:function(e,t){var n=e.s*t.s-e.x*t.x-e.y*t.y-e.z*t.z;var r=e.s*t.x+e.x*t.s+e.y*t.z-e.z*t.y;var i=e.s*t.y-e.x*t.z+e.y*t.s+e.z*t.x;var s=e.s*t.z+e.x*t.y-e.y*t.x+e.z*t.s;this.s=n;this.x=r;this.y=i;this.z=s;return this},normalize:function(e){var t=Math.sqrt(e.s*e.s+e.x*e.x+e.y*e.y+e.z*e.z);if(t>0)t=1/t;this.s=e.s*t;this.x=e.x*t;this.y=e.y*t;this.z=e.z*t;return this},invert:function(e){this.s=-e.s;this.x=-e.x;this.y=-e.y;this.z=-e.z;return this},length:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(e){this.s=e.s;this.x=e.x;this.y=e.y;this.z=e.z;return this},clone:function(e){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}};OIMO.Vec3=function(e,t,n){this.x=e||0;this.y=t||0;this.z=n||0};OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(e,t,n){this.x=e||0;this.y=t||0;this.z=n||0;return this},add:function(e,t){this.x=e.x+t.x;this.y=e.y+t.y;this.z=e.z+t.z;return this},sub:function(e,t){this.x=e.x-t.x;this.y=e.y-t.y;this.z=e.z-t.z;return this},scale:function(e,t){this.x=e.x*t;this.y=e.y*t;this.z=e.z*t;return this},scaleEqual:function(e){this.x*=e;this.y*=e;this.z*=e;return this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},cross:function(e,t){var n=e.y*t.z-e.z*t.y;var r=e.z*t.x-e.x*t.z;var i=e.x*t.y-e.y*t.x;this.x=n;this.y=r;this.z=i;return this},mulMat:function(e,t){var n=e.elements;var r=n[0]*t.x+n[1]*t.y+n[2]*t.z;var i=n[3]*t.x+n[4]*t.y+n[5]*t.z;var s=n[6]*t.x+n[7]*t.y+n[8]*t.z;this.x=r;this.y=i;this.z=s;return this},normalize:function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);if(t>0)t=1/t;this.x=e.x*t;this.y=e.y*t;this.z=e.z*t;return this},invert:function(e){this.x=-e.x;this.y=-e.y;this.z=-e.z;return this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(e){this.x=e.x;this.y=e.y;this.z=e.z;return this},clone:function(){return new OIMO.Vec3(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"}};OIMO.EulerToAxis=function(e,t,n){var r=Math.cos(t*.5);var i=Math.sin(t*.5);var s=Math.cos(n*.5);var o=Math.sin(n*.5);var u=Math.cos(e*.5);var a=Math.sin(e*.5);var f=r*s;var l=i*o;var c=f*u-l*a;var h=f*a+l*u;var p=i*s*u+r*o*a;var d=r*o*u-i*s*a;var v=2*Math.acos(c);var m=h*h+p*p+d*d;if(m<.001){h=1;p=d=0}else{m=Math.sqrt(m);h/=m;p/=m;d/=m}return[v,h,p,d]};OIMO.EulerToMatrix=function(e,t,n){var r=Math.cos(t);var i=Math.sin(t);var s=Math.cos(n);var o=Math.sin(n);var u=Math.cos(e);var a=Math.sin(e);var f=new OIMO.Mat33;var l=f.elements;l[0]=r*s;l[1]=i*a-r*o*u;l[2]=r*o*a+i*u;l[3]=o;l[4]=s*u;l[5]=-s*a;l[6]=-i*s;l[7]=i*o*u+r*a;l[8]=-i*o*a+r*u;return f};OIMO.MatrixToEuler=function(e){var t=e.elements;var n,r,i;if(t[3]>.998){r=Math.atan2(t[2],t[8]);i=Math.PI/2;n=0}else if(t[3]<-.998){r=Math.atan2(t[2],t[8]);i=-Math.PI/2;n=0}else{r=Math.atan2(-t[6],t[0]);n=Math.atan2(-t[5],t[4]);i=Math.asin(t[3])}return[n,r,i]};OIMO.Distance3d=function(e,t){var n=t[0]-e[0];var r=t[1]-e[1];var i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)};OIMO.Constraint=function(){this.parent=null;this.body1=null;this.body2=null;this.addedToIsland=false;this.sleeping=false};OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(e,t){throw new Error("preSolve Method is not inherited")},solve:function(){throw new Error("solve Method is not inherited")},postSolve:function(){throw new Error("postSolve Method is not inherited")}};OIMO.Joint=function(){OIMO.Constraint.call(this);this.JOINT_NULL=0;this.JOINT_DISTANCE=1;this.JOINT_BALL=2;this.JOINT_HINGE=3;this.JOINT_HINGE2=4;this.name="";this.type=0;this.allowCollision=false;this.localRelativeAnchorPosition1=new OIMO.Vec3;this.localRelativeAnchorPosition2=new OIMO.Vec3;this.relativeAnchorPosition1=new OIMO.Vec3;this.relativeAnchorPosition2=new OIMO.Vec3;this.anchorPosition1=new OIMO.Vec3;this.anchorPosition2=new OIMO.Vec3;this.connection1=new OIMO.JointConnection(this);this.connection2=new OIMO.JointConnection(this);this.matrix=new OIMO.Mat44};OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype);OIMO.Joint.prototype.preSolve=function(e,t){};OIMO.Joint.prototype.solve=function(){};OIMO.Joint.prototype.postSolve=function(){};OIMO.Joint.prototype.getMatrix=function(){var e=this.matrix.elements;var t=this.anchorPosition1;var n=this.anchorPosition2;e[0]=t.x*OIMO.WORLD_SCALE;e[1]=t.y*OIMO.WORLD_SCALE;e[2]=t.z*OIMO.WORLD_SCALE;e[3]=0;e[4]=n.x*OIMO.WORLD_SCALE;e[5]=n.y*OIMO.WORLD_SCALE;e[6]=n.z*OIMO.WORLD_SCALE;e[7]=0;return e};OIMO.JointConfig=function(){this.localRelativeAnchorPosition1=new OIMO.Vec3;this.localRelativeAnchorPosition2=new OIMO.Vec3;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.allowCollision=false};OIMO.JointConnection=function(e){this.prev=null;this.next=null;this.connected=null;this.parent=e};OIMO.BallJoint=function(e,t,n){OIMO.Joint.call(this);this.relPos1X=NaN;this.relPos1Y=NaN;this.relPos1Z=NaN;this.relPos2X=NaN;this.relPos2Y=NaN;this.relPos2Z=NaN;this.xTorqueUnit1X=NaN;this.xTorqueUnit1Y=NaN;this.xTorqueUnit1Z=NaN;this.xTorqueUnit2X=NaN;this.xTorqueUnit2Y=NaN;this.xTorqueUnit2Z=NaN;this.yTorqueUnit1X=NaN;this.yTorqueUnit1Y=NaN;this.yTorqueUnit1Z=NaN;this.yTorqueUnit2X=NaN;this.yTorqueUnit2Y=NaN;this.yTorqueUnit2Z=NaN;this.zTorqueUnit1X=NaN;this.zTorqueUnit1Y=NaN;this.zTorqueUnit1Z=NaN;this.zTorqueUnit2X=NaN;this.zTorqueUnit2Y=NaN;this.zTorqueUnit2Z=NaN;this.invI1e00=NaN;this.invI1e01=NaN;this.invI1e02=NaN;this.invI1e10=NaN;this.invI1e11=NaN;this.invI1e12=NaN;this.invI1e20=NaN;this.invI1e21=NaN;this.invI1e22=NaN;this.invI2e00=NaN;this.invI2e01=NaN;this.invI2e02=NaN;this.invI2e10=NaN;this.invI2e11=NaN;this.invI2e12=NaN;this.invI2e20=NaN;this.invI2e21=NaN;this.invI2e22=NaN;this.d00=NaN;this.d01=NaN;this.d02=NaN;this.d10=NaN;this.d11=NaN;this.d12=NaN;this.d20=NaN;this.d21=NaN;this.d22=NaN;this.targetVelX=NaN;this.targetVelY=NaN;this.targetVelZ=NaN;this.type=this.JOINT_BALL;this.body1=t;this.body2=n;this.connection1.connected=n;this.connection2.connected=t;this.allowCollision=e.allowCollision;this.localRelativeAnchorPosition1.copy(e.localRelativeAnchorPosition1);this.localRelativeAnchorPosition2.copy(e.localRelativeAnchorPosition2);this.lVel1=this.body1.linearVelocity;this.lVel2=this.body2.linearVelocity;this.aVel1=this.body1.angularVelocity;this.aVel2=this.body2.angularVelocity;this.invM1=this.body1.invertMass;this.invM2=this.body2.invertMass;this.impulse=new OIMO.Vec3;this.impulseX=0;this.impulseY=0;this.impulseZ=0};OIMO.BallJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.BallJoint.prototype.preSolve=function(e,t){var n;var r;var i;var s;var o;var u;var a;var f;var l;var c;var h;var p;var d;var v;var m;var g;var y;var b;var w;var E;var S;var x;var T;var N;var C;n=this.body1.rotation.elements;r=this.localRelativeAnchorPosition1.x;i=this.localRelativeAnchorPosition1.y;s=this.localRelativeAnchorPosition1.z;this.relPos1X=this.relativeAnchorPosition1.x=r*n[0]+i*n[1]+s*n[2];this.relPos1Y=this.relativeAnchorPosition1.y=r*n[3]+i*n[4]+s*n[5];this.relPos1Z=this.relativeAnchorPosition1.z=r*n[6]+i*n[7]+s*n[8];n=this.body2.rotation.elements;r=this.localRelativeAnchorPosition2.x;i=this.localRelativeAnchorPosition2.y;s=this.localRelativeAnchorPosition2.z;this.relPos2X=this.relativeAnchorPosition2.x=r*n[0]+i*n[1]+s*n[2];this.relPos2Y=this.relativeAnchorPosition2.y=r*n[3]+i*n[4]+s*n[5];this.relPos2Z=this.relativeAnchorPosition2.z=r*n[6]+i*n[7]+s*n[8];this.anchorPosition1.x=this.relPos1X+this.body1.position.x;this.anchorPosition1.y=this.relPos1Y+this.body1.position.y;this.anchorPosition1.z=this.relPos1Z+this.body1.position.z;this.anchorPosition2.x=this.relPos2X+this.body2.position.x;this.anchorPosition2.y=this.relPos2Y+this.body2.position.y;this.anchorPosition2.z=this.relPos2Z+this.body2.position.z;n=this.body1.invertInertia.elements;this.invI1e00=n[0];this.invI1e01=n[1];this.invI1e02=n[2];this.invI1e10=n[3];this.invI1e11=n[4];this.invI1e12=n[5];this.invI1e20=n[6];this.invI1e21=n[7];this.invI1e22=n[8];n=this.body2.invertInertia.elements;this.invI2e00=n[0];this.invI2e01=n[1];this.invI2e02=n[2];this.invI2e10=n[3];this.invI2e11=n[4];this.invI2e12=n[5];this.invI2e20=n[6];this.invI2e21=n[7];this.invI2e22=n[8];this.xTorqueUnit1X=this.relPos1Z*this.invI1e01-this.relPos1Y*this.invI1e02;this.xTorqueUnit1Y=this.relPos1Z*this.invI1e11-this.relPos1Y*this.invI1e12;this.xTorqueUnit1Z=this.relPos1Z*this.invI1e21-this.relPos1Y*this.invI1e22;this.xTorqueUnit2X=this.relPos2Z*this.invI2e01-this.relPos2Y*this.invI2e02;this.xTorqueUnit2Y=this.relPos2Z*this.invI2e11-this.relPos2Y*this.invI2e12;this.xTorqueUnit2Z=this.relPos2Z*this.invI2e21-this.relPos2Y*this.invI2e22;this.yTorqueUnit1X=-this.relPos1Z*this.invI1e00+this.relPos1X*this.invI1e02;this.yTorqueUnit1Y=-this.relPos1Z*this.invI1e10+this.relPos1X*this.invI1e12;this.yTorqueUnit1Z=-this.relPos1Z*this.invI1e20+this.relPos1X*this.invI1e22;this.yTorqueUnit2X=-this.relPos2Z*this.invI2e00+this.relPos2X*this.invI2e02;this.yTorqueUnit2Y=-this.relPos2Z*this.invI2e10+this.relPos2X*this.invI2e12;this.yTorqueUnit2Z=-this.relPos2Z*this.invI2e20+this.relPos2X*this.invI2e22;this.zTorqueUnit1X=this.relPos1Y*this.invI1e00-this.relPos1X*this.invI1e01;this.zTorqueUnit1Y=this.relPos1Y*this.invI1e10-this.relPos1X*this.invI1e11;this.zTorqueUnit1Z=this.relPos1Y*this.invI1e20-this.relPos1X*this.invI1e21;this.zTorqueUnit2X=this.relPos2Y*this.invI2e00-this.relPos2X*this.invI2e01;this.zTorqueUnit2Y=this.relPos2Y*this.invI2e10-this.relPos2X*this.invI2e11;this.zTorqueUnit2Z=this.relPos2Y*this.invI2e20-this.relPos2X*this.invI2e21;this.d00=this.invM1+this.invM2;this.d01=0;this.d02=0;this.d10=0;this.d11=this.d00;this.d12=0;this.d20=0;this.d21=0;this.d22=this.d00;l=-this.relPos1Z;c=this.relPos1Y;h=this.relPos1Z;d=-this.relPos1X;v=-this.relPos1Y;m=this.relPos1X;y=this.invI1e01*h+this.invI1e02*v;b=this.invI1e00*l+this.invI1e02*m;w=this.invI1e00*c+this.invI1e01*d;E=this.invI1e11*h+this.invI1e12*v;S=this.invI1e10*l+this.invI1e12*m;x=this.invI1e10*c+this.invI1e11*d;T=this.invI1e21*h+this.invI1e22*v;N=this.invI1e20*l+this.invI1e22*m;C=this.invI1e20*c+this.invI1e21*d;this.d00-=l*E+c*T;this.d01-=l*S+c*N;this.d02-=l*x+c*C;this.d10-=h*y+d*T;this.d11-=h*b+d*N;this.d12-=h*w+d*C;this.d20-=v*y+m*E;this.d21-=v*b+m*S;this.d22-=v*w+m*x;l=-this.relPos2Z;c=this.relPos2Y;h=this.relPos2Z;d=-this.relPos2X;v=-this.relPos2Y;m=this.relPos2X;y=this.invI2e01*h+this.invI2e02*v;b=this.invI2e00*l+this.invI2e02*m;w=this.invI2e00*c+this.invI2e01*d;E=this.invI2e11*h+this.invI2e12*v;S=this.invI2e10*l+this.invI2e12*m;x=this.invI2e10*c+this.invI2e11*d;T=this.invI2e21*h+this.invI2e22*v;N=this.invI2e20*l+this.invI2e22*m;C=this.invI2e20*c+this.invI2e21*d;this.d00-=l*E+c*T;this.d01-=l*S+c*N;this.d02-=l*x+c*C;this.d10-=h*y+d*T;this.d11-=h*b+d*N;this.d12-=h*w+d*C;this.d20-=v*y+m*E;this.d21-=v*b+m*S;this.d22-=v*w+m*x;r=1/(this.d00*(this.d11*this.d22-this.d21*this.d12)+this.d10*(this.d21*this.d02-this.d01*this.d22)+this.d20*(this.d01*this.d12-this.d11*this.d02));f=(this.d11*this.d22-this.d12*this.d21)*r;l=(this.d02*this.d21-this.d01*this.d22)*r;c=(this.d01*this.d12-this.d02*this.d11)*r;h=(this.d12*this.d20-this.d10*this.d22)*r;p=(this.d00*this.d22-this.d02*this.d20)*r;d=(this.d02*this.d10-this.d00*this.d12)*r;v=(this.d10*this.d21-this.d11*this.d20)*r;m=(this.d01*this.d20-this.d00*this.d21)*r;g=(this.d00*this.d11-this.d01*this.d10)*r;this.d00=f;this.d01=l;this.d02=c;this.d10=h;this.d11=p;this.d12=d;this.d20=v;this.d21=m;this.d22=g;this.lVel1.x+=this.impulseX*this.invM1;this.lVel1.y+=this.impulseY*this.invM1;this.lVel1.z+=this.impulseZ*this.invM1;this.aVel1.x+=this.xTorqueUnit1X*this.impulseX+this.yTorqueUnit1X*this.impulseY+this.zTorqueUnit1X*this.impulseZ;this.aVel1.y+=this.xTorqueUnit1Y*this.impulseX+this.yTorqueUnit1Y*this.impulseY+this.zTorqueUnit1Y*this.impulseZ;this.aVel1.z+=this.xTorqueUnit1Z*this.impulseX+this.yTorqueUnit1Z*this.impulseY+this.zTorqueUnit1Z*this.impulseZ;this.lVel2.x-=this.impulseX*this.invM2;this.lVel2.y-=this.impulseY*this.invM2;this.lVel2.z-=this.impulseZ*this.invM2;this.aVel2.x-=this.xTorqueUnit2X*this.impulseX+this.yTorqueUnit2X*this.impulseY+this.zTorqueUnit2X*this.impulseZ;this.aVel2.y-=this.xTorqueUnit2Y*this.impulseX+this.yTorqueUnit2Y*this.impulseY+this.zTorqueUnit2Y*this.impulseZ;this.aVel2.z-=this.xTorqueUnit2Z*this.impulseX+this.yTorqueUnit2Z*this.impulseY+this.zTorqueUnit2Z*this.impulseZ;this.targetVelX=this.anchorPosition2.x-this.anchorPosition1.x;this.targetVelY=this.anchorPosition2.y-this.anchorPosition1.y;this.targetVelZ=this.anchorPosition2.z-this.anchorPosition1.z;r=Math.sqrt(this.targetVelX*this.targetVelX+this.targetVelY*this.targetVelY+this.targetVelZ*this.targetVelZ);if(r<.005){this.targetVelX=0;this.targetVelY=0;this.targetVelZ=0}else{r=(.005-r)/r*t*.05;this.targetVelX*=r;this.targetVelY*=r;this.targetVelZ*=r}};OIMO.BallJoint.prototype.solve=function(){var e;var t;var n;var r;var i;var s;e=this.lVel2.x-this.lVel1.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-this.aVel1.y*this.relPos1Z+this.aVel1.z*this.relPos1Y-this.targetVelX;t=this.lVel2.y-this.lVel1.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-this.aVel1.z*this.relPos1X+this.aVel1.x*this.relPos1Z-this.targetVelY;n=this.lVel2.z-this.lVel1.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-this.aVel1.x*this.relPos1Y+this.aVel1.y*this.relPos1X-this.targetVelZ;r=e*this.d00+t*this.d01+n*this.d02;i=e*this.d10+t*this.d11+n*this.d12;s=e*this.d20+t*this.d21+n*this.d22;this.impulseX+=r;this.impulseY+=i;this.impulseZ+=s;this.lVel1.x+=r*this.invM1;this.lVel1.y+=i*this.invM1;this.lVel1.z+=s*this.invM1;this.aVel1.x+=this.xTorqueUnit1X*r+this.yTorqueUnit1X*i+this.zTorqueUnit1X*s;this.aVel1.y+=this.xTorqueUnit1Y*r+this.yTorqueUnit1Y*i+this.zTorqueUnit1Y*s;this.aVel1.z+=this.xTorqueUnit1Z*r+this.yTorqueUnit1Z*i+this.zTorqueUnit1Z*s;this.lVel2.x-=r*this.invM2;this.lVel2.y-=i*this.invM2;this.lVel2.z-=s*this.invM2;this.aVel2.x-=this.xTorqueUnit2X*r+this.yTorqueUnit2X*i+this.zTorqueUnit2X*s;this.aVel2.y-=this.xTorqueUnit2Y*r+this.yTorqueUnit2Y*i+this.zTorqueUnit2Y*s;this.aVel2.z-=this.xTorqueUnit2Z*r+this.yTorqueUnit2Z*i+this.zTorqueUnit2Z*s};OIMO.BallJoint.prototype.postSolve=function(){this.impulse.x=this.impulseX;this.impulse.y=this.impulseY;this.impulse.z=this.impulseZ};OIMO.DistanceJoint=function(e,t,n,r){OIMO.Joint.call(this);this.posError=NaN;this.norX=NaN;this.norY=NaN;this.norZ=NaN;this.relPos1X=NaN;this.relPos1Y=NaN;this.relPos1Z=NaN;this.relPos2X=NaN;this.relPos2Y=NaN;this.relPos2Z=NaN;this.norTorque1X=NaN;this.norTorque1Y=NaN;this.norTorque1Z=NaN;this.norTorque2X=NaN;this.norTorque2Y=NaN;this.norTorque2Z=NaN;this.norTorqueUnit1X=NaN;this.norTorqueUnit1Y=NaN;this.norTorqueUnit1Z=NaN;this.norTorqueUnit2X=NaN;this.norTorqueUnit2Y=NaN;this.norTorqueUnit2Z=NaN;this.invI1e00=NaN;this.invI1e01=NaN;this.invI1e02=NaN;this.invI1e10=NaN;this.invI1e11=NaN;this.invI1e12=NaN;this.invI1e20=NaN;this.invI1e21=NaN;this.invI1e22=NaN;this.invI2e00=NaN;this.invI2e01=NaN;this.invI2e02=NaN;this.invI2e10=NaN;this.invI2e11=NaN;this.invI2e12=NaN;this.invI2e20=NaN;this.invI2e21=NaN;this.invI2e22=NaN;this.normalDenominator=NaN;this.targetNormalVelocity=NaN;this.body1=t;this.body2=n;this.connection1.connected=n;this.connection2.connected=t;this.distance=r;this.allowCollision=e.allowCollision;this.localRelativeAnchorPosition1.copy(e.localRelativeAnchorPosition1);this.localRelativeAnchorPosition2.copy(e.localRelativeAnchorPosition2);this.type=this.JOINT_DISTANCE;this.lVel1=this.body1.linearVelocity;this.lVel2=this.body2.linearVelocity;this.aVel1=this.body1.angularVelocity;this.aVel2=this.body2.angularVelocity;this.invM1=this.body1.invertMass;this.invM2=this.body2.invertMass;this.impulse=0};OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.DistanceJoint.prototype.preSolve=function(e,t){var n;var r;var i;var s;var o;var u;var a;n=this.body1.rotation.elements;r=this.localRelativeAnchorPosition1.x;i=this.localRelativeAnchorPosition1.y;s=this.localRelativeAnchorPosition1.z;this.relPos1X=this.relativeAnchorPosition1.x=r*n[0]+i*n[1]+s*n[2];this.relPos1Y=this.relativeAnchorPosition1.y=r*n[3]+i*n[4]+s*n[5];this.relPos1Z=this.relativeAnchorPosition1.z=r*n[6]+i*n[7]+s*n[8];n=this.body2.rotation.elements;r=this.localRelativeAnchorPosition2.x;i=this.localRelativeAnchorPosition2.y;s=this.localRelativeAnchorPosition2.z;this.relPos2X=this.relativeAnchorPosition2.x=r*n[0]+i*n[1]+s*n[2];this.relPos2Y=this.relativeAnchorPosition2.y=r*n[3]+i*n[4]+s*n[5];this.relPos2Z=this.relativeAnchorPosition2.z=r*n[6]+i*n[7]+s*n[8];this.norX=(this.anchorPosition2.x=this.relPos2X+this.body2.position.x)-(this.anchorPosition1.x=this.relPos1X+this.body1.position.x);this.norY=(this.anchorPosition2.y=this.relPos2Y+this.body2.position.y)-(this.anchorPosition1.y=this.relPos1Y+this.body1.position.y);this.norZ=(this.anchorPosition2.z=this.relPos2Z+this.body2.position.z)-(this.anchorPosition1.z=this.relPos1Z+this.body1.position.z);r=Math.sqrt(this.norX*this.norX+this.norY*this.norY+this.norZ*this.norZ);this.posError=this.distance-r;if(r>0)r=1/r;this.norX*=r;this.norY*=r;this.norZ*=r;n=this.body1.invertInertia.elements;this.invI1e00=n[0];this.invI1e01=n[1];this.invI1e02=n[2];this.invI1e10=n[3];this.invI1e11=n[4];this.invI1e12=n[5];this.invI1e20=n[6];this.invI1e21=n[7];this.invI1e22=n[8];n=this.body2.invertInertia.elements;this.invI2e00=n[0];this.invI2e01=n[1];this.invI2e02=n[2];this.invI2e10=n[3];this.invI2e11=n[4];this.invI2e12=n[5];this.invI2e20=n[6];this.invI2e21=n[7];this.invI2e22=n[8];this.norTorque1X=this.relPos1Y*this.norZ-this.relPos1Z*this.norY;this.norTorque1Y=this.relPos1Z*this.norX-this.relPos1X*this.norZ;this.norTorque1Z=this.relPos1X*this.norY-this.relPos1Y*this.norX;this.norTorque2X=this.relPos2Y*this.norZ-this.relPos2Z*this.norY;this.norTorque2Y=this.relPos2Z*this.norX-this.relPos2X*this.norZ;this.norTorque2Z=this.relPos2X*this.norY-this.relPos2Y*this.norX;this.norTorqueUnit1X=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02;this.norTorqueUnit1Y=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12;this.norTorqueUnit1Z=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22;this.norTorqueUnit2X=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02;this.norTorqueUnit2Y=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12;this.norTorqueUnit2Z=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22;r=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02;i=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12;s=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22;o=i*this.relPos1Z-s*this.relPos1Y;u=s*this.relPos1X-r*this.relPos1Z;a=r*this.relPos1Y-i*this.relPos1X;r=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02;i=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12;s=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22;o+=i*this.relPos2Z-s*this.relPos2Y;u+=s*this.relPos2X-r*this.relPos2Z;a+=r*this.relPos2Y-i*this.relPos2X;this.normalDenominator=1/(this.invM1+this.invM2+this.norX*o+this.norY*u+this.norZ*a);r=this.norX*this.impulse;i=this.norY*this.impulse;s=this.norZ*this.impulse;this.lVel1.x+=r*this.invM1;this.lVel1.y+=i*this.invM1;this.lVel1.z+=s*this.invM1;this.aVel1.x+=this.norTorqueUnit1X*this.impulse;this.aVel1.y+=this.norTorqueUnit1Y*this.impulse;this.aVel1.z+=this.norTorqueUnit1Z*this.impulse;this.lVel2.x-=r*this.invM2;this.lVel2.y-=i*this.invM2;this.lVel2.z-=s*this.invM2;this.aVel2.x-=this.norTorqueUnit2X*this.impulse;this.aVel2.y-=this.norTorqueUnit2Y*this.impulse;this.aVel2.z-=this.norTorqueUnit2Z*this.impulse;if(this.posError<-.005)this.posError+=.005;else if(this.posError>.005)this.posError-=.005;else this.posError=0;this.targetNormalVelocity=this.posError*t*.05};OIMO.DistanceJoint.prototype.solve=function(){var e;var t;var n;var r;var i;var s;var o;var u;t=(this.lVel2.x-this.lVel1.x)*this.norX+(this.lVel2.y-this.lVel1.y)*this.norY+(this.lVel2.z-this.lVel1.z)*this.norZ+this.aVel2.x*this.norTorque2X+this.aVel2.y*this.norTorque2Y+this.aVel2.z*this.norTorque2Z-this.aVel1.x*this.norTorque1X-this.aVel1.y*this.norTorque1Y-this.aVel1.z*this.norTorque1Z;e=(t-this.targetNormalVelocity)*this.normalDenominator;this.impulse+=e;n=this.norX*e;r=this.norY*e;i=this.norZ*e;this.lVel1.x+=n*this.invM1;this.lVel1.y+=r*this.invM1;this.lVel1.z+=i*this.invM1;this.aVel1.x+=this.norTorqueUnit1X*e;this.aVel1.y+=this.norTorqueUnit1Y*e;this.aVel1.z+=this.norTorqueUnit1Z*e;this.lVel2.x-=n*this.invM2;this.lVel2.y-=r*this.invM2;this.lVel2.z-=i*this.invM2;this.aVel2.x-=this.norTorqueUnit2X*e;this.aVel2.y-=this.norTorqueUnit2Y*e;this.aVel2.z-=this.norTorqueUnit2Z*e};OIMO.DistanceJoint.prototype.postSolve=function(){};OIMO.HingeJoint=function(e,t,n){OIMO.Joint.call(this);this.enableLimits=false;this.lowerLimit=NaN;this.upperLimit=NaN;this.limitSign=0;this.enableMotor=false;this.motorSpeed=NaN;this.maxMotorTorque=NaN;this.stepMotorTorque=NaN;this.axis1X=NaN;this.axis1Y=NaN;this.axis1Z=NaN;this.axis2X=NaN;this.axis2Y=NaN;this.axis2Z=NaN;this.angAxis1X=NaN;this.angAxis1Y=NaN;this.angAxis1Z=NaN;this.angAxis2X=NaN;this.angAxis2Y=NaN;this.angAxis2Z=NaN;this.norX=NaN;this.norY=NaN;this.norZ=NaN;this.tanX=NaN;this.tanY=NaN;this.tanZ=NaN;this.binX=NaN;this.binY=NaN;this.binZ=NaN;this.hingeAngle=NaN;this.relPos1X=NaN;this.relPos1Y=NaN;this.relPos1Z=NaN;this.relPos2X=NaN;this.relPos2Y=NaN;this.relPos2Z=NaN;this.xTorqueUnit1X=NaN;this.xTorqueUnit1Y=NaN;this.xTorqueUnit1Z=NaN;this.xTorqueUnit2X=NaN;this.xTorqueUnit2Y=NaN;this.xTorqueUnit2Z=NaN;this.yTorqueUnit1X=NaN;this.yTorqueUnit1Y=NaN;this.yTorqueUnit1Z=NaN;this.yTorqueUnit2X=NaN;this.yTorqueUnit2Y=NaN;this.yTorqueUnit2Z=NaN;this.zTorqueUnit1X=NaN;this.zTorqueUnit1Y=NaN;this.zTorqueUnit1Z=NaN;this.zTorqueUnit2X=NaN;this.zTorqueUnit2Y=NaN;this.zTorqueUnit2Z=NaN;this.invI1e00=NaN;this.invI1e01=NaN;this.invI1e02=NaN;this.invI1e10=NaN;this.invI1e11=NaN;this.invI1e12=NaN;this.invI1e20=NaN;this.invI1e21=NaN;this.invI1e22=NaN;this.invI2e00=NaN;this.invI2e01=NaN;this.invI2e02=NaN;this.invI2e10=NaN;this.invI2e11=NaN;this.invI2e12=NaN;this.invI2e20=NaN;this.invI2e21=NaN;this.invI2e22=NaN;this.d00=NaN;this.d01=NaN;this.d02=NaN;this.d10=NaN;this.d11=NaN;this.d12=NaN;this.d20=NaN;this.d21=NaN;this.d22=NaN;this.norDenominator=NaN;this.tanDenominator=NaN;this.binDenominator=NaN;this.invNorDenominator=NaN;this.targetVelX=NaN;this.targetVelY=NaN;this.targetVelZ=NaN;this.targetAngVelNor=NaN;this.targetAngVelTan=NaN;this.targetAngVelBin=NaN;this.body1=t;this.body2=n;this.connection1.connected=n;this.connection2.connected=t;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.localAxis1.normalize(e.localAxis1);this.localAxis2.normalize(e.localAxis2);var r;this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;r=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=r;this.localAngAxis1Y*=r;this.localAngAxis1Z*=r;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;this.localAngAxis2X=this.localAxis2Y*this.localAxis2X-this.localAxis2Z*this.localAxis2Z;this.localAngAxis2Y=-this.localAxis2Z*this.localAxis2Y-this.localAxis2X*this.localAxis2X;this.localAngAxis2Z=this.localAxis2X*this.localAxis2Z+this.localAxis2Y*this.localAxis2Y;r=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z);this.localAngAxis2X*=r;this.localAngAxis2Y*=r;this.localAngAxis2Z*=r;this.allowCollision=e.allowCollision;this.localRelativeAnchorPosition1.copy(e.localRelativeAnchorPosition1);this.localRelativeAnchorPosition2.copy(e.localRelativeAnchorPosition2);this.type=this.JOINT_HINGE;this.lVel1=this.body1.linearVelocity;this.lVel2=this.body2.linearVelocity;this.aVel1=this.body1.angularVelocity;this.aVel2=this.body2.angularVelocity;this.invM1=this.body1.invertMass;this.invM2=this.body2.invertMass;this.impulse=new OIMO.Vec3;this.torque=new OIMO.Vec3;this.impulseX=0;this.impulseY=0;this.impulseZ=0;this.limitTorque=0;this.motorTorque=0;this.torqueX=0;this.torqueY=0;this.torqueZ=0;this.torqueTan=0;this.torqueBin=0};OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.HingeJoint.prototype.preSolve=function(e,t){var n;var r;var i;var s;var o;var u;var a;var f;var l;var c;var h;var p;var d;var v;var m;var g;var y;var b;var w;var E;var S;var x;var T;var N;var C;n=this.body1.rotation.elements;this.axis1X=this.localAxis1X*n[0]+this.localAxis1Y*n[1]+this.localAxis1Z*n[2];this.axis1Y=this.localAxis1X*n[3]+this.localAxis1Y*n[4]+this.localAxis1Z*n[5];this.axis1Z=this.localAxis1X*n[6]+this.localAxis1Y*n[7]+this.localAxis1Z*n[8];this.angAxis1X=this.localAngAxis1X*n[0]+this.localAngAxis1Y*n[1]+this.localAngAxis1Z*n[2];this.angAxis1Y=this.localAngAxis1X*n[3]+this.localAngAxis1Y*n[4]+this.localAngAxis1Z*n[5];this.angAxis1Z=this.localAngAxis1X*n[6]+this.localAngAxis1Y*n[7]+this.localAngAxis1Z*n[8];r=this.localRelativeAnchorPosition1.x;i=this.localRelativeAnchorPosition1.y;s=this.localRelativeAnchorPosition1.z;this.relPos1X=this.relativeAnchorPosition1.x=r*n[0]+i*n[1]+s*n[2];this.relPos1Y=this.relativeAnchorPosition1.y=r*n[3]+i*n[4]+s*n[5];this.relPos1Z=this.relativeAnchorPosition1.z=r*n[6]+i*n[7]+s*n[8];n=this.body2.rotation.elements;this.axis2X=this.localAxis2X*n[0]+this.localAxis2Y*n[1]+this.localAxis2Z*n[2];this.axis2Y=this.localAxis2X*n[3]+this.localAxis2Y*n[4]+this.localAxis2Z*n[5];this.axis2Z=this.localAxis2X*n[6]+this.localAxis2Y*n[7]+this.localAxis2Z*n[8];this.angAxis2X=this.localAngAxis2X*n[0]+this.localAngAxis2Y*n[1]+this.localAngAxis2Z*n[2];this.angAxis2Y=this.localAngAxis2X*n[3]+this.localAngAxis2Y*n[4]+this.localAngAxis2Z*n[5];this.angAxis2Z=this.localAngAxis2X*n[6]+this.localAngAxis2Y*n[7]+this.localAngAxis2Z*n[8];r=this.localRelativeAnchorPosition2.x;i=this.localRelativeAnchorPosition2.y;s=this.localRelativeAnchorPosition2.z;this.relPos2X=this.relativeAnchorPosition2.x=r*n[0]+i*n[1]+s*n[2];this.relPos2Y=this.relativeAnchorPosition2.y=r*n[3]+i*n[4]+s*n[5];this.relPos2Z=this.relativeAnchorPosition2.z=r*n[6]+i*n[7]+s*n[8];this.anchorPosition1.x=this.relPos1X+this.body1.position.x;this.anchorPosition1.y=this.relPos1Y+this.body1.position.y;this.anchorPosition1.z=this.relPos1Z+this.body1.position.z;this.anchorPosition2.x=this.relPos2X+this.body2.position.x;this.anchorPosition2.y=this.relPos2Y+this.body2.position.y;this.anchorPosition2.z=this.relPos2Z+this.body2.position.z;r=1/(this.invM1+this.invM2);this.norX=(this.axis1X*this.invM1+this.axis2X*this.invM2)*r;this.norY=(this.axis1Y*this.invM1+this.axis2Y*this.invM2)*r;this.norZ=(this.axis1Z*this.invM1+this.axis2Z*this.invM2)*r;r=Math.sqrt(this.norX*this.norX+this.norY*this.norY+this.norZ*this.norZ);if(r>0)r=1/r;this.norX*=r;this.norY*=r;this.norZ*=r;this.tanX=this.norY*this.norX-this.norZ*this.norZ;this.tanY=-this.norZ*this.norY-this.norX*this.norX;this.tanZ=this.norX*this.norZ+this.norY*this.norY;r=1/Math.sqrt(this.tanX*this.tanX+this.tanY*this.tanY+this.tanZ*this.tanZ);this.tanX*=r;this.tanY*=r;this.tanZ*=r;this.binX=this.norY*this.tanZ-this.norZ*this.tanY;this.binY=this.norZ*this.tanX-this.norX*this.tanZ;this.binZ=this.norX*this.tanY-this.norY*this.tanX;if(this.norX*(this.angAxis1Y*this.angAxis2Z-this.angAxis1Z*this.angAxis2Y)+this.norY*(this.angAxis1Z*this.angAxis2X-this.angAxis1X*this.angAxis2Z)+this.norZ*(this.angAxis1X*this.angAxis2Y-this.angAxis1Y*this.angAxis2X)<0){this.hingeAngle=-Math.acos(this.angAxis1X*this.angAxis2X+this.angAxis1Y*this.angAxis2Y+this.angAxis1Z*this.angAxis2Z)}else{this.hingeAngle=Math.acos(this.angAxis1X*this.angAxis2X+this.angAxis1Y*this.angAxis2Y+this.angAxis1Z*this.angAxis2Z)}n=this.body1.invertInertia.elements;this.invI1e00=n[0];this.invI1e01=n[1];this.invI1e02=n[2];this.invI1e10=n[3];this.invI1e11=n[4];this.invI1e12=n[5];this.invI1e20=n[6];this.invI1e21=n[7];this.invI1e22=n[8];n=this.body2.invertInertia.elements;this.invI2e00=n[0];this.invI2e01=n[1];this.invI2e02=n[2];this.invI2e10=n[3];this.invI2e11=n[4];this.invI2e12=n[5];this.invI2e20=n[6];this.invI2e21=n[7];this.invI2e22=n[8];this.xTorqueUnit1X=this.relPos1Z*this.invI1e01-this.relPos1Y*this.invI1e02;this.xTorqueUnit1Y=this.relPos1Z*this.invI1e11-this.relPos1Y*this.invI1e12;this.xTorqueUnit1Z=this.relPos1Z*this.invI1e21-this.relPos1Y*this.invI1e22;this.xTorqueUnit2X=this.relPos2Z*this.invI2e01-this.relPos2Y*this.invI2e02;this.xTorqueUnit2Y=this.relPos2Z*this.invI2e11-this.relPos2Y*this.invI2e12;this.xTorqueUnit2Z=this.relPos2Z*this.invI2e21-this.relPos2Y*this.invI2e22;this.yTorqueUnit1X=-this.relPos1Z*this.invI1e00+this.relPos1X*this.invI1e02;this.yTorqueUnit1Y=-this.relPos1Z*this.invI1e10+this.relPos1X*this.invI1e12;this.yTorqueUnit1Z=-this.relPos1Z*this.invI1e20+this.relPos1X*this.invI1e22;this.yTorqueUnit2X=-this.relPos2Z*this.invI2e00+this.relPos2X*this.invI2e02;this.yTorqueUnit2Y=-this.relPos2Z*this.invI2e10+this.relPos2X*this.invI2e12;this.yTorqueUnit2Z=-this.relPos2Z*this.invI2e20+this.relPos2X*this.invI2e22;this.zTorqueUnit1X=this.relPos1Y*this.invI1e00-this.relPos1X*this.invI1e01;this.zTorqueUnit1Y=this.relPos1Y*this.invI1e10-this.relPos1X*this.invI1e11;this.zTorqueUnit1Z=this.relPos1Y*this.invI1e20-this.relPos1X*this.invI1e21;this.zTorqueUnit2X=this.relPos2Y*this.invI2e00-this.relPos2X*this.invI2e01;this.zTorqueUnit2Y=this.relPos2Y*this.invI2e10-this.relPos2X*this.invI2e11;this.zTorqueUnit2Z=this.relPos2Y*this.invI2e20-this.relPos2X*this.invI2e21;this.d00=this.invM1+this.invM2;this.d01=0;this.d02=0;this.d10=0;this.d11=this.d00;this.d12=0;this.d20=0;this.d21=0;this.d22=this.d00;l=-this.relPos1Z;c=this.relPos1Y;h=this.relPos1Z;d=-this.relPos1X;v=-this.relPos1Y;m=this.relPos1X;y=this.invI1e01*h+this.invI1e02*v;b=this.invI1e00*l+this.invI1e02*m;w=this.invI1e00*c+this.invI1e01*d;E=this.invI1e11*h+this.invI1e12*v;S=this.invI1e10*l+this.invI1e12*m;x=this.invI1e10*c+this.invI1e11*d;T=this.invI1e21*h+this.invI1e22*v;N=this.invI1e20*l+this.invI1e22*m;C=this.invI1e20*c+this.invI1e21*d;this.d00-=l*E+c*T;this.d01-=l*S+c*N;this.d02-=l*x+c*C;this.d10-=h*y+d*T;this.d11-=h*b+d*N;this.d12-=h*w+d*C;this.d20-=v*y+m*E;this.d21-=v*b+m*S;this.d22-=v*w+m*x;l=-this.relPos2Z;c=this.relPos2Y;h=this.relPos2Z;d=-this.relPos2X;v=-this.relPos2Y;m=this.relPos2X;y=this.invI2e01*h+this.invI2e02*v;b=this.invI2e00*l+this.invI2e02*m;w=this.invI2e00*c+this.invI2e01*d;E=this.invI2e11*h+this.invI2e12*v;S=this.invI2e10*l+this.invI2e12*m;x=this.invI2e10*c+this.invI2e11*d;T=this.invI2e21*h+this.invI2e22*v;N=this.invI2e20*l+this.invI2e22*m;C=this.invI2e20*c+this.invI2e21*d;this.d00-=l*E+c*T;this.d01-=l*S+c*N;this.d02-=l*x+c*C;this.d10-=h*y+d*T;this.d11-=h*b+d*N;this.d12-=h*w+d*C;this.d20-=v*y+m*E;this.d21-=v*b+m*S;this.d22-=v*w+m*x;r=1/(this.d00*(this.d11*this.d22-this.d21*this.d12)+this.d10*(this.d21*this.d02-this.d01*this.d22)+this.d20*(this.d01*this.d12-this.d11*this.d02));f=(this.d11*this.d22-this.d12*this.d21)*r;l=(this.d02*this.d21-this.d01*this.d22)*r;c=(this.d01*this.d12-this.d02*this.d11)*r;h=(this.d12*this.d20-this.d10*this.d22)*r;p=(this.d00*this.d22-this.d02*this.d20)*r;d=(this.d02*this.d10-this.d00*this.d12)*r;v=(this.d10*this.d21-this.d11*this.d20)*r;m=(this.d01*this.d20-this.d00*this.d21)*r;g=(this.d00*this.d11-this.d01*this.d10)*r;this.d00=f;this.d01=l;this.d02=c;this.d10=h;this.d11=p;this.d12=d;this.d20=v;this.d21=m;this.d22=g;f=this.invI1e00+this.invI2e00;l=this.invI1e01+this.invI2e01;c=this.invI1e02+this.invI2e02;h=this.invI1e10+this.invI2e10;p=this.invI1e11+this.invI2e11;d=this.invI1e12+this.invI2e12;v=this.invI1e20+this.invI2e20;m=this.invI1e21+this.invI2e21;g=this.invI1e22+this.invI2e22;this.invNorDenominator=this.norX*(this.norX*f+this.norY*l+this.norZ*c)+this.norY*(this.norX*h+this.norY*p+this.norZ*d)+this.norZ*(this.norX*v+this.norY*m+this.norZ*g);this.norDenominator=1/this.invNorDenominator;this.tanDenominator=1/(this.tanX*(this.tanX*f+this.tanY*l+this.tanZ*c)+this.tanY*(this.tanX*h+this.tanY*p+this.tanZ*d)+this.tanZ*(this.tanX*v+this.tanY*m+this.tanZ*g));this.binDenominator=1/(this.binX*(this.binX*f+this.binY*l+this.binZ*c)+this.binY*(this.binX*h+this.binY*p+this.binZ*d)+this.binZ*(this.binX*v+this.binY*m+this.binZ*g));if(this.enableLimits){if(this.hingeAngle<this.lowerLimit){if(this.limitSign!=-1)this.limitTorque=0;this.limitSign=-1}else if(this.hingeAngle>this.upperLimit){if(this.limitSign!=1)this.limitTorque=0;this.limitSign=1}else{this.limitSign=0;this.limitTorque=0}}else{this.limitSign=0;this.limitTorque=0}if(this.enableMotor){this.stepMotorTorque=e*this.maxMotorTorque}this.torqueTan*=.95;this.torqueBin*=.95;this.motorTorque*=.95;this.limitTorque*=.95;r=this.limitTorque+this.motorTorque;this.torqueX=r*this.norX+this.torqueTan*this.tanX+this.torqueBin*this.binX;this.torqueY=r*this.norY+this.torqueTan*this.tanY+this.torqueBin*this.binY;this.torqueZ=r*this.norZ+this.torqueTan*this.tanZ+this.torqueBin*this.binZ;this.lVel1.x+=this.impulseX*this.invM1;this.lVel1.y+=this.impulseY*this.invM1;this.lVel1.z+=this.impulseZ*this.invM1;this.aVel1.x+=this.xTorqueUnit1X*this.impulseX+this.yTorqueUnit1X*this.impulseY+this.zTorqueUnit1X*this.impulseZ+this.torqueX*this.invI1e00+this.torqueY*this.invI1e01+this.torqueZ*this.invI1e02;this.aVel1.y+=this.xTorqueUnit1Y*this.impulseX+this.yTorqueUnit1Y*this.impulseY+this.zTorqueUnit1Y*this.impulseZ+this.torqueX*this.invI1e10+this.torqueY*this.invI1e11+this.torqueZ*this.invI1e12;this.aVel1.z+=this.xTorqueUnit1Z*this.impulseX+this.yTorqueUnit1Z*this.impulseY+this.zTorqueUnit1Z*this.impulseZ+this.torqueX*this.invI1e20+this.torqueY*this.invI1e21+this.torqueZ*this.invI1e22;this.lVel2.x-=this.impulseX*this.invM2;this.lVel2.y-=this.impulseY*this.invM2;this.lVel2.z-=this.impulseZ*this.invM2;this.aVel2.x-=this.xTorqueUnit2X*this.impulseX+this.yTorqueUnit2X*this.impulseY+this.zTorqueUnit2X*this.impulseZ+this.torqueX*this.invI2e00+this.torqueY*this.invI2e01+this.torqueZ*this.invI2e02;this.aVel2.y-=this.xTorqueUnit2Y*this.impulseX+this.yTorqueUnit2Y*this.impulseY+this.zTorqueUnit2Y*this.impulseZ+this.torqueX*this.invI2e10+this.torqueY*this.invI2e11+this.torqueZ*this.invI2e12;this.aVel2.z-=this.xTorqueUnit2Z*this.impulseX+this.yTorqueUnit2Z*this.impulseY+this.zTorqueUnit2Z*this.impulseZ+this.torqueX*this.invI2e20+this.torqueY*this.invI2e21+this.torqueZ*this.invI2e22;this.targetVelX=this.anchorPosition2.x-this.anchorPosition1.x;this.targetVelY=this.anchorPosition2.y-this.anchorPosition1.y;this.targetVelZ=this.anchorPosition2.z-this.anchorPosition1.z;r=Math.sqrt(this.targetVelX*this.targetVelX+this.targetVelY*this.targetVelY+this.targetVelZ*this.targetVelZ);if(r<.005){this.targetVelX=0;this.targetVelY=0;this.targetVelZ=0}else{r=(.005-r)/r*t*.05;this.targetVelX*=r;this.targetVelY*=r;this.targetVelZ*=r}r=this.axis2Y*this.axis1Z-this.axis2Z*this.axis1Y;i=this.axis2Z*this.axis1X-this.axis2X*this.axis1Z;s=this.axis2X*this.axis1Y-this.axis2Y*this.axis1X;this.targetAngVelTan=this.tanX*r+this.tanY*i+this.tanZ*s;if(this.targetAngVelTan>.02)this.targetAngVelTan=(this.targetAngVelTan-.02)*t*.05;else if(this.targetAngVelTan<-.02)this.targetAngVelTan=(this.targetAngVelTan+.02)*t*.05;else this.targetAngVelTan=0;this.targetAngVelBin=this.binX*r+this.binY*i+this.binZ*s;if(this.targetAngVelBin>.02)this.targetAngVelBin=(this.targetAngVelBin-.02)*t*.05;else if(this.targetAngVelBin<-.02)this.targetAngVelBin=(this.targetAngVelBin+.02)*t*.05;else this.targetAngVelBin=0;if(this.limitSign==-1){this.targetAngVelNor=this.lowerLimit-this.hingeAngle;if(this.targetAngVelNor<.02)this.targetAngVelNor=0;else this.targetAngVelNor=(this.targetAngVelNor-.02)*t*.05}else if(this.limitSign==1){this.targetAngVelNor=this.upperLimit-this.hingeAngle;if(this.targetAngVelNor>-.02)this.targetAngVelNor=0;else this.targetAngVelNor=(this.targetAngVelNor+.02)*t*.05}else{this.targetAngVelNor=0}};OIMO.HingeJoint.prototype.solve=function(){var e;var t;var n;var r;var i;var s;var o;var u;var a;var f;var l;var c;var h;e=this.lVel2.x-this.lVel1.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-this.aVel1.y*this.relPos1Z+this.aVel1.z*this.relPos1Y-this.targetVelX;t=this.lVel2.y-this.lVel1.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-this.aVel1.z*this.relPos1X+this.aVel1.x*this.relPos1Z-this.targetVelY;n=this.lVel2.z-this.lVel1.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-this.aVel1.x*this.relPos1Y+this.aVel1.y*this.relPos1X-this.targetVelZ;i=e*this.d00+t*this.d01+n*this.d02;s=e*this.d10+t*this.d11+n*this.d12;o=e*this.d20+t*this.d21+n*this.d22;this.impulseX+=i;this.impulseY+=s;this.impulseZ+=o;this.lVel1.x+=i*this.invM1;this.lVel1.y+=s*this.invM1;this.lVel1.z+=o*this.invM1;this.aVel1.x+=this.xTorqueUnit1X*i+this.yTorqueUnit1X*s+this.zTorqueUnit1X*o;this.aVel1.y+=this.xTorqueUnit1Y*i+this.yTorqueUnit1Y*s+this.zTorqueUnit1Y*o;this.aVel1.z+=this.xTorqueUnit1Z*i+this.yTorqueUnit1Z*s+this.zTorqueUnit1Z*o;this.lVel2.x-=i*this.invM2;this.lVel2.y-=s*this.invM2;this.lVel2.z-=o*this.invM2;this.aVel2.x-=this.xTorqueUnit2X*i+this.yTorqueUnit2X*s+this.zTorqueUnit2X*o;this.aVel2.y-=this.xTorqueUnit2Y*i+this.yTorqueUnit2Y*s+this.zTorqueUnit2Y*o;this.aVel2.z-=this.xTorqueUnit2Z*i+this.yTorqueUnit2Z*s+this.zTorqueUnit2Z*o;e=this.aVel2.x-this.aVel1.x;t=this.aVel2.y-this.aVel1.y;n=this.aVel2.z-this.aVel1.z;r=e*this.norX+t*this.norY+n*this.norZ;if(this.enableMotor){l=(r-this.motorSpeed)*this.norDenominator;f=this.motorTorque;this.motorTorque+=l;if(this.motorTorque>this.stepMotorTorque)this.motorTorque=this.stepMotorTorque;else if(this.motorTorque<-this.stepMotorTorque)this.motorTorque=-this.stepMotorTorque;l=this.motorTorque-f;r-=l*this.invNorDenominator}else l=0;if(this.limitSign!=0){h=(r-this.targetAngVelNor)*this.norDenominator;c=this.limitTorque;this.limitTorque+=h;if(this.limitTorque*this.limitSign<0)this.limitTorque=0;h=this.limitTorque-c}else h=0;r=l+h;u=(e*this.tanX+t*this.tanY+n*this.tanZ-this.targetAngVelTan)*this.tanDenominator;a=(e*this.binX+t*this.binY+n*this.binZ-this.targetAngVelBin)*this.binDenominator;this.torqueTan+=u;this.torqueBin+=a;i=r*this.norX+u*this.tanX+a*this.binX;s=r*this.norY+u*this.tanY+a*this.binY;o=r*this.norZ+u*this.tanZ+a*this.binZ;this.aVel1.x+=this.invI1e00*i+this.invI1e01*s+this.invI1e02*o;this.aVel1.y+=this.invI1e10*i+this.invI1e11*s+this.invI1e12*o;this.aVel1.z+=this.invI1e20*i+this.invI1e21*s+this.invI1e22*o;this.aVel2.x-=this.invI2e00*i+this.invI2e01*s+this.invI2e02*o;this.aVel2.y-=this.invI2e10*i+this.invI2e11*s+this.invI2e12*o;this.aVel2.z-=this.invI2e20*i+this.invI2e21*s+this.invI2e22*o};OIMO.HingeJoint.prototype.postSolve=function(){this.impulse.x=this.impulseX;this.impulse.y=this.impulseY;this.impulse.z=this.impulseZ;this.torque.x=this.torqueX;this.torque.y=this.torqueY;this.torque.z=this.torqueZ};OIMO.HingeJoint.prototype.acosClamp=function(e){if(e>1)return 0;else if(e<-1)return Math.PI;else return Math.acos(e)};OIMO.Hinge2Joint=function(e,t,n){OIMO.Joint.call(this);this.limitTorque1=NaN;this.motorTorque1=NaN;this.limitTorque2=NaN;this.motorTorque2=NaN;this.enableLimits1=false;this.lowerLimit1=NaN;this.upperLimit1=NaN;this.limitSign1=0;this.enableLimits2=false;this.lowerLimit2=NaN;this.upperLimit2=NaN;this.limitSign2=0;this.enableMotor1=false;this.motorSpeed1=NaN;this.maxMotorTorque1=NaN;this.stepMotorTorque1=NaN;this.enableMotor2=false;this.motorSpeed2=NaN;this.maxMotorTorque2=NaN;this.stepMotorTorque2=NaN;this.tanX=NaN;this.tanY=NaN;this.tanZ=NaN;this.binX=NaN;this.binY=NaN;this.binZ=NaN;this.angAxis1X=NaN;this.angAxis1Y=NaN;this.angAxis1Z=NaN;this.angAxis2X=NaN;this.angAxis2Y=NaN;this.angAxis2Z=NaN;this.norX=NaN;this.norY=NaN;this.norZ=NaN;this.angle1=NaN;this.angle2=NaN;this.relPos1X=NaN;this.relPos1Y=NaN;this.relPos1Z=NaN;this.relPos2X=NaN;this.relPos2Y=NaN;this.relPos2Z=NaN;this.xTorqueUnit1X=NaN;this.xTorqueUnit1Y=NaN;this.xTorqueUnit1Z=NaN;this.xTorqueUnit2X=NaN;this.xTorqueUnit2Y=NaN;this.xTorqueUnit2Z=NaN;this.yTorqueUnit1X=NaN;this.yTorqueUnit1Y=NaN;this.yTorqueUnit1Z=NaN;this.yTorqueUnit2X=NaN;this.yTorqueUnit2Y=NaN;this.yTorqueUnit2Z=NaN;this.zTorqueUnit1X=NaN;this.zTorqueUnit1Y=NaN;this.zTorqueUnit1Z=NaN;this.zTorqueUnit2X=NaN;this.zTorqueUnit2Y=NaN;this.zTorqueUnit2Z=NaN;this.invI1e00=NaN;this.invI1e01=NaN;this.invI1e02=NaN;this.invI1e10=NaN;this.invI1e11=NaN;this.invI1e12=NaN;this.invI1e20=NaN;this.invI1e21=NaN;this.invI1e22=NaN;this.invI2e00=NaN;this.invI2e01=NaN;this.invI2e02=NaN;this.invI2e10=NaN;this.invI2e11=NaN;this.invI2e12=NaN;this.invI2e20=NaN;this.invI2e21=NaN;this.invI2e22=NaN;this.d00=NaN;this.d01=NaN;this.d02=NaN;this.d10=NaN;this.d11=NaN;this.d12=NaN;this.d20=NaN;this.d21=NaN;this.d22=NaN;this.norDenominator=NaN;this.tanDenominator=NaN;this.binDenominator=NaN;this.invTanDenominator=NaN;this.invBinDenominator=NaN;this.targetVelX=NaN;this.targetVelY=NaN;this.targetVelZ=NaN;this.targetAngVelNor=NaN;this.targetAngVelTan=NaN;this.targetAngVelBin=NaN;this.body1=t;this.body2=n;this.connection1.connected=n;this.connection2.connected=t;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.localAxis1.normalize(e.localAxis1);this.localAxis2.normalize(e.localAxis2);var r;this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;r=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=r;this.localAngAxis1Y*=r;this.localAngAxis1Z*=r;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;this.localAngAxis2X=this.localAxis2Y*this.localAxis2X-this.localAxis2Z*this.localAxis2Z;this.localAngAxis2Y=-this.localAxis2Z*this.localAxis2Y-this.localAxis2X*this.localAxis2X;this.localAngAxis2Z=this.localAxis2X*this.localAxis2Z+this.localAxis2Y*this.localAxis2Y;r=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z);this.localAngAxis2X*=r;this.localAngAxis2Y*=r;this.localAngAxis2Z*=r;this.allowCollision=e.allowCollision;this.localRelativeAnchorPosition1.copy(e.localRelativeAnchorPosition1);this.localRelativeAnchorPosition2.copy(e.localRelativeAnchorPosition2);this.type=this.JOINT_HINGE2;this.lVel1=this.body1.linearVelocity;this.lVel2=this.body2.linearVelocity;this.aVel1=this.body1.angularVelocity;this.aVel2=this.body2.angularVelocity;this.invM1=this.body1.invertMass;this.invM2=this.body2.invertMass;this.impulse=new OIMO.Vec3;this.torque=new OIMO.Vec3;this.impulseX=0;this.impulseY=0;this.impulseZ=0;this.limitTorque1=0;this.motorTorque1=0;this.limitTorque2=0;this.motorTorque2=0;this.torqueX=0;this.torqueY=0;this.torqueZ=0;this.torqueNor=0};OIMO.Hinge2Joint.prototype=Object.create(OIMO.Joint.prototype);OIMO.Hinge2Joint.prototype.preSolve=function(e,t){var n;var r;var i;var s;var o;var u;var a;var f;var l;var c;var h;var p;var d;var v;var m;var g;var y;var b;var w;var E;var S;var x;var T;var N;var C;n=this.body1.rotation.elements;this.tanX=this.localAxis1X*n[0]+this.localAxis1Y*n[1]+this.localAxis1Z*n[2];this.tanY=this.localAxis1X*n[3]+this.localAxis1Y*n[4]+this.localAxis1Z*n[5];this.tanZ=this.localAxis1X*n[6]+this.localAxis1Y*n[7]+this.localAxis1Z*n[8];this.angAxis1X=this.localAngAxis1X*n[0]+this.localAngAxis1Y*n[1]+this.localAngAxis1Z*n[2];this.angAxis1Y=this.localAngAxis1X*n[3]+this.localAngAxis1Y*n[4]+this.localAngAxis1Z*n[5];this.angAxis1Z=this.localAngAxis1X*n[6]+this.localAngAxis1Y*n[7]+this.localAngAxis1Z*n[8];r=this.localRelativeAnchorPosition1.x;i=this.localRelativeAnchorPosition1.y;s=this.localRelativeAnchorPosition1.z;this.relPos1X=this.relativeAnchorPosition1.x=r*n[0]+i*n[1]+s*n[2];this.relPos1Y=this.relativeAnchorPosition1.y=r*n[3]+i*n[4]+s*n[5];this.relPos1Z=this.relativeAnchorPosition1.z=r*n[6]+i*n[7]+s*n[8];n=this.body2.rotation.elements;this.binX=this.localAxis2X*n[0]+this.localAxis2Y*n[1]+this.localAxis2Z*n[2];this.binY=this.localAxis2X*n[3]+this.localAxis2Y*n[4]+this.localAxis2Z*n[5];this.binZ=this.localAxis2X*n[6]+this.localAxis2Y*n[7]+this.localAxis2Z*n[8];this.angAxis2X=this.localAngAxis2X*n[0]+this.localAngAxis2Y*n[1]+this.localAngAxis2Z*n[2];this.angAxis2Y=this.localAngAxis2X*n[3]+this.localAngAxis2Y*n[4]+this.localAngAxis2Z*n[5];this.angAxis2Z=this.localAngAxis2X*n[6]+this.localAngAxis2Y*n[7]+this.localAngAxis2Z*n[8];r=this.localRelativeAnchorPosition2.x;i=this.localRelativeAnchorPosition2.y;s=this.localRelativeAnchorPosition2.z;this.relPos2X=this.relativeAnchorPosition2.x=r*n[0]+i*n[1]+s*n[2];this.relPos2Y=this.relativeAnchorPosition2.y=r*n[3]+i*n[4]+s*n[5];this.relPos2Z=this.relativeAnchorPosition2.z=r*n[6]+i*n[7]+s*n[8];this.anchorPosition1.x=this.relPos1X+this.body1.position.x;this.anchorPosition1.y=this.relPos1Y+this.body1.position.y;this.anchorPosition1.z=this.relPos1Z+this.body1.position.z;this.anchorPosition2.x=this.relPos2X+this.body2.position.x;this.anchorPosition2.y=this.relPos2Y+this.body2.position.y;this.anchorPosition2.z=this.relPos2Z+this.body2.position.z;this.norX=this.binY*this.tanZ-this.binZ*this.tanY;this.norY=this.binZ*this.tanX-this.binX*this.tanZ;this.norZ=this.binX*this.tanY-this.binY*this.tanX;r=Math.sqrt(this.norX*this.norX+this.norY*this.norY+this.norZ*this.norZ);if(r>0)r=1/r;this.norX*=r;this.norY*=r;this.norZ*=r;if(this.tanX*(this.angAxis1Y*this.binZ-this.angAxis1Z*this.binY)+this.tanY*(this.angAxis1Z*this.binX-this.angAxis1X*this.binZ)+this.tanZ*(this.angAxis1X*this.binY-this.angAxis1Y*this.binX)<0){this.angle1=-Math.acos(this.angAxis1X*this.binX+this.angAxis1Y*this.binY+this.angAxis1Z*this.binZ)}else{this.angle1=Math.acos(this.angAxis1X*this.binX+this.angAxis1Y*this.binY+this.angAxis1Z*this.binZ)}if(this.binX*(this.angAxis2Y*this.tanZ-this.angAxis2Z*this.tanY)+this.binY*(this.angAxis2Z*this.tanX-this.angAxis2X*this.tanZ)+this.binZ*(this.angAxis2X*this.tanY-this.angAxis2Y*this.tanX)<0){this.angle2=Math.acos(this.angAxis2X*this.tanX+this.angAxis2Y*this.tanY+this.angAxis2Z*this.tanZ)}else{this.angle2=-Math.acos(this.angAxis2X*this.tanX+this.angAxis2Y*this.tanY+this.angAxis2Z*this.tanZ)}n=this.body1.invertInertia.elements;this.invI1e00=n[0];this.invI1e01=n[1];this.invI1e02=n[2];this.invI1e10=n[3];this.invI1e11=n[4];this.invI1e12=n[5];this.invI1e20=n[6];this.invI1e21=n[7];this.invI1e22=n[8];n=this.body2.invertInertia.elements;this.invI2e00=n[0];this.invI2e01=n[1];this.invI2e02=n[2];this.invI2e10=n[3];this.invI2e11=n[4];this.invI2e12=n[5];this.invI2e20=n[6];this.invI2e21=n[7];this.invI2e22=n[8];this.xTorqueUnit1X=this.relPos1Z*this.invI1e01-this.relPos1Y*this.invI1e02;this.xTorqueUnit1Y=this.relPos1Z*this.invI1e11-this.relPos1Y*this.invI1e12;this.xTorqueUnit1Z=this.relPos1Z*this.invI1e21-this.relPos1Y*this.invI1e22;this.xTorqueUnit2X=this.relPos2Z*this.invI2e01-this.relPos2Y*this.invI2e02;this.xTorqueUnit2Y=this.relPos2Z*this.invI2e11-this.relPos2Y*this.invI2e12;this.xTorqueUnit2Z=this.relPos2Z*this.invI2e21-this.relPos2Y*this.invI2e22;this.yTorqueUnit1X=-this.relPos1Z*this.invI1e00+this.relPos1X*this.invI1e02;this.yTorqueUnit1Y=-this.relPos1Z*this.invI1e10+this.relPos1X*this.invI1e12;this.yTorqueUnit1Z=-this.relPos1Z*this.invI1e20+this.relPos1X*this.invI1e22;this.yTorqueUnit2X=-this.relPos2Z*this.invI2e00+this.relPos2X*this.invI2e02;this.yTorqueUnit2Y=-this.relPos2Z*this.invI2e10+this.relPos2X*this.invI2e12;this.yTorqueUnit2Z=-this.relPos2Z*this.invI2e20+this.relPos2X*this.invI2e22;this.zTorqueUnit1X=this.relPos1Y*this.invI1e00-this.relPos1X*this.invI1e01;this.zTorqueUnit1Y=this.relPos1Y*this.invI1e10-this.relPos1X*this.invI1e11;this.zTorqueUnit1Z=this.relPos1Y*this.invI1e20-this.relPos1X*this.invI1e21;this.zTorqueUnit2X=this.relPos2Y*this.invI2e00-this.relPos2X*this.invI2e01;this.zTorqueUnit2Y=this.relPos2Y*this.invI2e10-this.relPos2X*this.invI2e11;this.zTorqueUnit2Z=this.relPos2Y*this.invI2e20-this.relPos2X*this.invI2e21;this.d00=this.invM1+this.invM2;this.d01=0;this.d02=0;this.d10=0;this.d11=this.d00;this.d12=0;this.d20=0;this.d21=0;this.d22=this.d00;l=-this.relPos1Z;c=this.relPos1Y;h=this.relPos1Z;d=-this.relPos1X;v=-this.relPos1Y;m=this.relPos1X;y=this.invI1e01*h+this.invI1e02*v;b=this.invI1e00*l+this.invI1e02*m;w=this.invI1e00*c+this.invI1e01*d;E=this.invI1e11*h+this.invI1e12*v;S=this.invI1e10*l+this.invI1e12*m;x=this.invI1e10*c+this.invI1e11*d;T=this.invI1e21*h+this.invI1e22*v;N=this.invI1e20*l+this.invI1e22*m;C=this.invI1e20*c+this.invI1e21*d;this.d00-=l*E+c*T;this.d01-=l*S+c*N;this.d02-=l*x+c*C;this.d10-=h*y+d*T;this.d11-=h*b+d*N;this.d12-=h*w+d*C;this.d20-=v*y+m*E;this.d21-=v*b+m*S;this.d22-=v*w+m*x;l=-this.relPos2Z;c=this.relPos2Y;h=this.relPos2Z;d=-this.relPos2X;v=-this.relPos2Y;m=this.relPos2X;y=this.invI2e01*h+this.invI2e02*v;b=this.invI2e00*l+this.invI2e02*m;w=this.invI2e00*c+this.invI2e01*d;E=this.invI2e11*h+this.invI2e12*v;S=this.invI2e10*l+this.invI2e12*m;x=this.invI2e10*c+this.invI2e11*d;T=this.invI2e21*h+this.invI2e22*v;N=this.invI2e20*l+this.invI2e22*m;C=this.invI2e20*c+this.invI2e21*d;this.d00-=l*E+c*T;this.d01-=l*S+c*N;this.d02-=l*x+c*C;this.d10-=h*y+d*T;this.d11-=h*b+d*N;this.d12-=h*w+d*C;this.d20-=v*y+m*E;this.d21-=v*b+m*S;this.d22-=v*w+m*x;r=1/(this.d00*(this.d11*this.d22-this.d21*this.d12)+this.d10*(this.d21*this.d02-this.d01*this.d22)+this.d20*(this.d01*this.d12-this.d11*this.d02));f=(this.d11*this.d22-this.d12*this.d21)*r;l=(this.d02*this.d21-this.d01*this.d22)*r;c=(this.d01*this.d12-this.d02*this.d11)*r;h=(this.d12*this.d20-this.d10*this.d22)*r;p=(this.d00*this.d22-this.d02*this.d20)*r;d=(this.d02*this.d10-this.d00*this.d12)*r;v=(this.d10*this.d21-this.d11*this.d20)*r;m=(this.d01*this.d20-this.d00*this.d21)*r;g=(this.d00*this.d11-this.d01*this.d10)*r;this.d00=f;this.d01=l;this.d02=c;this.d10=h;this.d11=p;this.d12=d;this.d20=v;this.d21=m;this.d22=g;f=this.invI1e00+this.invI2e00;l=this.invI1e01+this.invI2e01;c=this.invI1e02+this.invI2e02;h=this.invI1e10+this.invI2e10;p=this.invI1e11+this.invI2e11;d=this.invI1e12+this.invI2e12;v=this.invI1e20+this.invI2e20;m=this.invI1e21+this.invI2e21;g=this.invI1e22+this.invI2e22;this.norDenominator=1/(this.norX*(this.norX*f+this.norY*l+this.norZ*c)+this.norY*(this.norX*h+this.norY*p+this.norZ*d)+this.norZ*(this.norX*v+this.norY*m+this.norZ*g));this.invTanDenominator=this.tanX*(this.tanX*f+this.tanY*l+this.tanZ*c)+this.tanY*(this.tanX*h+this.tanY*p+this.tanZ*d)+this.tanZ*(this.tanX*v+this.tanY*m+this.tanZ*g);this.tanDenominator=1/this.invTanDenominator;this.invBinDenominator=this.binX*(this.binX*f+this.binY*l+this.binZ*c)+this.binY*(this.binX*h+this.binY*p+this.binZ*d)+this.binZ*(this.binX*v+this.binY*m+this.binZ*g);this.binDenominator=1/this.invBinDenominator;if(this.enableLimits1){if(this.angle1<this.lowerLimit1){if(this.limitSign1!=-1)this.limitTorque1=0;this.limitSign1=-1}else if(this.angle1>this.upperLimit1){if(this.limitSign1!=1)this.limitTorque1=0;this.limitSign1=1}else{this.limitSign1=0;this.limitTorque1=0}}else{this.limitSign1=0;this.limitTorque1=0}if(this.enableLimits2){if(this.angle2<this.lowerLimit2){if(this.limitSign2!=-1)this.limitTorque2=0;this.limitSign2=-1}else if(this.angle2>this.upperLimit2){if(this.limitSign2!=1)this.limitTorque2=0;this.limitSign2=1}else{this.limitSign2=0;this.limitTorque2=0}}else{this.limitSign2=0;this.limitTorque2=0}if(this.enableMotor1){this.stepMotorTorque1=e*this.maxMotorTorque1}if(this.enableMotor2){this.stepMotorTorque2=e*this.maxMotorTorque2}this.torqueNor*=.95;this.motorTorque1*=.95;this.limitTorque1*=.95;this.motorTorque2*=.95;this.limitTorque2*=.95;r=this.motorTorque1+this.limitTorque1;i=this.motorTorque2+this.limitTorque2;this.torqueX=this.torqueNor*this.norX+r*this.tanX+i*this.binX;this.torqueY=this.torqueNor*this.norY+r*this.tanY+i*this.binY;this.torqueZ=this.torqueNor*this.norZ+r*this.tanZ+i*this.binZ;this.lVel1.x+=this.impulseX*this.invM1;this.lVel1.y+=this.impulseY*this.invM1;this.lVel1.z+=this.impulseZ*this.invM1;this.aVel1.x+=this.xTorqueUnit1X*this.impulseX+this.yTorqueUnit1X*this.impulseY+this.zTorqueUnit1X*this.impulseZ+this.torqueX*this.invI1e00+this.torqueY*this.invI1e01+this.torqueZ*this.invI1e02;this.aVel1.y+=this.xTorqueUnit1Y*this.impulseX+this.yTorqueUnit1Y*this.impulseY+this.zTorqueUnit1Y*this.impulseZ+this.torqueX*this.invI1e10+this.torqueY*this.invI1e11+this.torqueZ*this.invI1e12;this.aVel1.z+=this.xTorqueUnit1Z*this.impulseX+this.yTorqueUnit1Z*this.impulseY+this.zTorqueUnit1Z*this.impulseZ+this.torqueX*this.invI1e20+this.torqueY*this.invI1e21+this.torqueZ*this.invI1e22;this.lVel2.x-=this.impulseX*this.invM2;this.lVel2.y-=this.impulseY*this.invM2;this.lVel2.z-=this.impulseZ*this.invM2;this.aVel2.x-=this.xTorqueUnit2X*this.impulseX+this.yTorqueUnit2X*this.impulseY+this.zTorqueUnit2X*this.impulseZ+this.torqueX*this.invI2e00+this.torqueY*this.invI2e01+this.torqueZ*this.invI2e02;this.aVel2.y-=this.xTorqueUnit2Y*this.impulseX+this.yTorqueUnit2Y*this.impulseY+this.zTorqueUnit2Y*this.impulseZ+this.torqueX*this.invI2e10+this.torqueY*this.invI2e11+this.torqueZ*this.invI2e12;this.aVel2.z-=this.xTorqueUnit2Z*this.impulseX+this.yTorqueUnit2Z*this.impulseY+this.zTorqueUnit2Z*this.impulseZ+this.torqueX*this.invI2e20+this.torqueY*this.invI2e21+this.torqueZ*this.invI2e22;this.targetVelX=this.anchorPosition2.x-this.anchorPosition1.x;this.targetVelY=this.anchorPosition2.y-this.anchorPosition1.y;this.targetVelZ=this.anchorPosition2.z-this.anchorPosition1.z;r=Math.sqrt(this.targetVelX*this.targetVelX+this.targetVelY*this.targetVelY+this.targetVelZ*this.targetVelZ);if(r<.005){this.targetVelX=0;this.targetVelY=0;this.targetVelZ=0}else{r=(.005-r)/r*t*.05;this.targetVelX*=r;this.targetVelY*=r;this.targetVelZ*=r}this.targetAngVelNor=-(this.tanX*this.binX+this.tanY*this.binY+this.tanZ*this.binZ);if(this.targetAngVelNor>.02)this.targetAngVelNor=(this.targetAngVelNor-.02)*t*.05;else if(this.targetAngVelNor<-.02)this.targetAngVelNor=(this.targetAngVelNor+.02)*t*.05;else this.targetAngVelNor=0;if(this.limitSign1==-1){this.targetAngVelTan=this.lowerLimit1-this.angle1;if(this.targetAngVelTan<.02)this.targetAngVelTan=0;else this.targetAngVelTan=(this.targetAngVelTan-.02)*t*.05}else if(this.limitSign1==1){this.targetAngVelTan=this.upperLimit1-this.angle1;if(this.targetAngVelTan>-.02)this.targetAngVelTan=0;else this.targetAngVelTan=(this.targetAngVelTan+.02)*t*.05}else{this.targetAngVelTan=0}if(this.limitSign2==-1){this.targetAngVelBin=this.lowerLimit2-this.angle2;if(this.targetAngVelBin<.02)this.targetAngVelBin=0;else this.targetAngVelBin=(this.targetAngVelBin-.02)*t*.05}else if(this.limitSign2==1){this.targetAngVelBin=this.upperLimit2-this.angle2;if(this.targetAngVelBin>-.02)this.targetAngVelBin=0;else this.targetAngVelBin=(this.targetAngVelBin+.02)*t*.05}else{this.targetAngVelBin=0}};OIMO.Hinge2Joint.prototype.solve=function(){var e;var t;var n;var r;var i;var s;var o;var u;var a;var f;var l;var c;var h;var p;var d;var v;var m;var g;e=this.lVel2.x-this.lVel1.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-this.aVel1.y*this.relPos1Z+this.aVel1.z*this.relPos1Y-this.targetVelX;t=this.lVel2.y-this.lVel1.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-this.aVel1.z*this.relPos1X+this.aVel1.x*this.relPos1Z-this.targetVelY;n=this.lVel2.z-this.lVel1.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-this.aVel1.x*this.relPos1Y+this.aVel1.y*this.relPos1X-this.targetVelZ;i=e*this.d00+t*this.d01+n*this.d02;s=e*this.d10+t*this.d11+n*this.d12;o=e*this.d20+t*this.d21+n*this.d22;this.impulseX+=i;this.impulseY+=s;this.impulseZ+=o;this.lVel1.x+=i*this.invM1;this.lVel1.y+=s*this.invM1;this.lVel1.z+=o*this.invM1;this.aVel1.x+=this.xTorqueUnit1X*i+this.yTorqueUnit1X*s+this.zTorqueUnit1X*o;this.aVel1.y+=this.xTorqueUnit1Y*i+this.yTorqueUnit1Y*s+this.zTorqueUnit1Y*o;this.aVel1.z+=this.xTorqueUnit1Z*i+this.yTorqueUnit1Z*s+this.zTorqueUnit1Z*o;this.lVel2.x-=i*this.invM2;this.lVel2.y-=s*this.invM2;this.lVel2.z-=o*this.invM2;this.aVel2.x-=this.xTorqueUnit2X*i+this.yTorqueUnit2X*s+this.zTorqueUnit2X*o;this.aVel2.y-=this.xTorqueUnit2Y*i+this.yTorqueUnit2Y*s+this.zTorqueUnit2Y*o;this.aVel2.z-=this.xTorqueUnit2Z*i+this.yTorqueUnit2Z*s+this.zTorqueUnit2Z*o;e=this.aVel2.x-this.aVel1.x;t=this.aVel2.y-this.aVel1.y;n=this.aVel2.z-this.aVel1.z;r=e*this.tanX+t*this.tanY+n*this.tanZ;if(this.enableMotor1){c=(r-this.motorSpeed1)*this.tanDenominator;l=this.motorTorque1;this.motorTorque1+=c;if(this.motorTorque1>this.stepMotorTorque1)this.motorTorque1=this.stepMotorTorque1;else if(this.motorTorque1<-this.stepMotorTorque1)this.motorTorque1=-this.stepMotorTorque1;c=this.motorTorque1-l;r-=c*this.invTanDenominator}else c=0;if(this.limitSign1!=0){p=(r-this.targetAngVelTan)*this.tanDenominator;h=this.limitTorque1;this.limitTorque1+=p;if(this.limitTorque1*this.limitSign1<0)this.limitTorque1=0;p=this.limitTorque1-h}else p=0;r=e*this.binX+t*this.binY+n*this.binZ;if(this.enableMotor2){v=(r-this.motorSpeed2)*this.binDenominator;d=this.motorTorque2;this.motorTorque2+=v;if(this.motorTorque2>this.stepMotorTorque2)this.motorTorque2=this.stepMotorTorque2;else if(this.motorTorque2<-this.stepMotorTorque2)this.motorTorque2=-this.stepMotorTorque2;v=this.motorTorque2-d;r-=v*this.invBinDenominator}else v=0;if(this.limitSign2!=0){g=(r-this.targetAngVelBin)*this.binDenominator;m=this.limitTorque2;this.limitTorque2+=g;if(this.limitTorque2*this.limitSign2<0)this.limitTorque2=0;g=this.limitTorque2-m}else g=0;u=(e*this.norX+t*this.norY+n*this.norZ-this.targetAngVelNor)*this.norDenominator;a=c+p;f=v+g;this.torqueNor+=u;i=u*this.norX+a*this.tanX+f*this.binX;s=u*this.norY+a*this.tanY+f*this.binY;o=u*this.norZ+a*this.tanZ+f*this.binZ;this.aVel1.x+=this.invI1e00*i+this.invI1e01*s+this.invI1e02*o;this.aVel1.y+=this.invI1e10*i+this.invI1e11*s+this.invI1e12*o;this.aVel1.z+=this.invI1e20*i+this.invI1e21*s+this.invI1e22*o;this.aVel2.x-=this.invI2e00*i+this.invI2e01*s+this.invI2e02*o;this.aVel2.y-=this.invI2e10*i+this.invI2e11*s+this.invI2e12*o;this.aVel2.z-=this.invI2e20*i+this.invI2e21*s+this.invI2e22*o};OIMO.Hinge2Joint.prototype.postSolve=function(){this.impulse.x=this.impulseX;this.impulse.y=this.impulseY;this.impulse.z=this.impulseZ;this.torque.x=this.torqueX;this.torque.y=this.torqueY;this.torque.z=this.torqueZ};OIMO.Contact=function(e){OIMO.Constraint.call(this);this.overlap=NaN;this.normalDenominator=NaN;this.tangentDenominator=NaN;this.binormalDenominator=NaN;this.shape1=null;this.shape2=null;this.warmStarted=false;this.lVel1=null;this.lVel2=null;this.aVel1=null;this.aVel2=null;this.relPos1X=NaN;this.relPos1Y=NaN;this.relPos1Z=NaN;this.relPos2X=NaN;this.relPos2Y=NaN;this.relPos2Z=NaN;this.relVelX=NaN;this.relVelY=NaN;this.relVelZ=NaN;this.norX=NaN;this.norY=NaN;this.norZ=NaN;this.tanX=NaN;this.tanY=NaN;this.tanZ=NaN;this.binX=NaN;this.binY=NaN;this.binZ=NaN;this.norTorque1X=NaN;this.norTorque1Y=NaN;this.norTorque1Z=NaN;this.norTorque2X=NaN;this.norTorque2Y=NaN;this.norTorque2Z=NaN;this.tanTorque1X=NaN;this.tanTorque1Y=NaN;this.tanTorque1Z=NaN;this.tanTorque2X=NaN;this.tanTorque2Y=NaN;this.tanTorque2Z=NaN;this.binTorque1X=NaN;this.binTorque1Y=NaN;this.binTorque1Z=NaN;this.binTorque2X=NaN;this.binTorque2Y=NaN;this.binTorque2Z=NaN;this.norTorqueUnit1X=NaN;this.norTorqueUnit1Y=NaN;this.norTorqueUnit1Z=NaN;this.norTorqueUnit2X=NaN;this.norTorqueUnit2Y=NaN;this.norTorqueUnit2Z=NaN;this.tanTorqueUnit1X=NaN;this.tanTorqueUnit1Y=NaN;this.tanTorqueUnit1Z=NaN;this.tanTorqueUnit2X=NaN;this.tanTorqueUnit2Y=NaN;this.tanTorqueUnit2Z=NaN;this.binTorqueUnit1X=NaN;this.binTorqueUnit1Y=NaN;this.binTorqueUnit1Z=NaN;this.binTorqueUnit2X=NaN;this.binTorqueUnit2Y=NaN;this.binTorqueUnit2Z=NaN;this.invM1=NaN;this.invM2=NaN;this.invI1e00=NaN;this.invI1e01=NaN;this.invI1e02=NaN;this.invI1e10=NaN;this.invI1e11=NaN;this.invI1e12=NaN;this.invI1e20=NaN;this.invI1e21=NaN;this.invI1e22=NaN;this.invI2e00=NaN;this.invI2e01=NaN;this.invI2e02=NaN;this.invI2e10=NaN;this.invI2e11=NaN;this.invI2e12=NaN;this.invI2e20=NaN;this.invI2e21=NaN;this.invI2e22=NaN;this.targetNormalVelocity=NaN;this.targetSeparateVelocity=NaN;this.friction=NaN;this.restitution=NaN;this.position=new OIMO.Vec3;this.relativePosition1=new OIMO.Vec3;this.relativePosition2=new OIMO.Vec3;this.normal=new OIMO.Vec3;this.tangent=new OIMO.Vec3;this.binormal=new OIMO.Vec3;this.shapeConnection1=new OIMO.ContactConnection(this);this.shapeConnection2=new OIMO.ContactConnection(this);this.bodyConnection1=new OIMO.ContactConnection(this);this.bodyConnection2=new OIMO.ContactConnection(this);this.id=new OIMO.ContactID;this.normalImpulse=0;this.tangentImpulse=0;this.binormalImpulse=0};OIMO.Contact.prototype=Object.create(OIMO.Constraint.prototype);OIMO.Contact.prototype.setupFromContactInfo=function(e){this.position.x=e.position.x;this.position.y=e.position.y;this.position.z=e.position.z;this.norX=e.normal.x;this.norY=e.normal.y;this.norZ=e.normal.z;this.overlap=e.overlap;this.shape1=e.shape1;this.shape2=e.shape2;this.body1=this.shape1.parent;this.body2=this.shape2.parent;this.bodyConnection1.connectedBody=this.body2;this.bodyConnection1.connectedShape=this.shape2;this.shapeConnection1.connectedBody=this.body2;this.shapeConnection1.connectedShape=this.shape2;this.bodyConnection2.connectedBody=this.body1;this.bodyConnection2.connectedShape=this.shape1;this.shapeConnection2.connectedBody=this.body1;this.shapeConnection2.connectedShape=this.shape1;this.relPos1X=this.position.x-this.body1.position.x;this.relPos1Y=this.position.y-this.body1.position.y;this.relPos1Z=this.position.z-this.body1.position.z;this.relPos2X=this.position.x-this.body2.position.x;this.relPos2Y=this.position.y-this.body2.position.y;this.relPos2Z=this.position.z-this.body2.position.z;this.lVel1=this.body1.linearVelocity;this.lVel2=this.body2.linearVelocity;this.aVel1=this.body1.angularVelocity;this.aVel2=this.body2.angularVelocity;this.invM1=this.body1.invertMass;this.invM2=this.body2.invertMass;var t;t=this.body1.invertInertia.elements;this.invI1e00=t[0];this.invI1e01=t[1];this.invI1e02=t[2];this.invI1e10=t[3];this.invI1e11=t[4];this.invI1e12=t[5];this.invI1e20=t[6];this.invI1e21=t[7];this.invI1e22=t[8];t=this.body2.invertInertia.elements;this.invI2e00=t[0];this.invI2e01=t[1];this.invI2e02=t[2];this.invI2e10=t[3];this.invI2e11=t[4];this.invI2e12=t[5];this.invI2e20=t[6];this.invI2e21=t[7];this.invI2e22=t[8];this.id.data1=e.id.data1;this.id.data2=e.id.data2;this.id.flip=e.id.flip;this.friction=this.shape1.friction*this.shape2.friction;this.restitution=this.shape1.restitution*this.shape2.restitution;this.overlap=e.overlap;this.normalImpulse=0;this.tangentImpulse=0;this.binormalImpulse=0;this.warmStarted=false};OIMO.Contact.prototype.removeReferences=function(){this.shape1=null;this.shape2=null;this.body1=null;this.body2=null;this.bodyConnection1.connectedBody=null;this.bodyConnection1.connectedShape=null;this.shapeConnection1.connectedBody=null;this.shapeConnection1.connectedShape=null;this.bodyConnection2.connectedBody=null;this.bodyConnection2.connectedShape=null;this.shapeConnection2.connectedBody=null;this.shapeConnection2.connectedShape=null};OIMO.Contact.prototype.preSolve=function(e,t){this.relVelX=this.lVel2.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-(this.lVel1.x+this.aVel1.y*this.relPos1Z-this.aVel1.z*this.relPos1Y);this.relVelY=this.lVel2.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-(this.lVel1.y+this.aVel1.z*this.relPos1X-this.aVel1.x*this.relPos1Z);this.relVelZ=this.lVel2.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-(this.lVel1.z+this.aVel1.x*this.relPos1Y-this.aVel1.y*this.relPos1X);var n=this.norX*this.relVelX+this.norY*this.relVelY+this.norZ*this.relVelZ;this.tanX=this.relVelX-n*this.norX;this.tanY=this.relVelY-n*this.norY;this.tanZ=this.relVelZ-n*this.norZ;var r=this.tanX*this.tanX+this.tanY*this.tanY+this.tanZ*this.tanZ;if(r>.01){r=1/Math.sqrt(r)}else{this.tanX=this.norY*this.norX-this.norZ*this.norZ;this.tanY=-this.norZ*this.norY-this.norX*this.norX;this.tanZ=this.norX*this.norZ+this.norY*this.norY;r=1/Math.sqrt(this.tanX*this.tanX+this.tanY*this.tanY+this.tanZ*this.tanZ)}this.tanX*=r;this.tanY*=r;this.tanZ*=r;this.binX=this.norY*this.tanZ-this.norZ*this.tanY;this.binY=this.norZ*this.tanX-this.norX*this.tanZ;this.binZ=this.norX*this.tanY-this.norY*this.tanX;this.norTorque1X=this.relPos1Y*this.norZ-this.relPos1Z*this.norY;this.norTorque1Y=this.relPos1Z*this.norX-this.relPos1X*this.norZ;this.norTorque1Z=this.relPos1X*this.norY-this.relPos1Y*this.norX;this.norTorque2X=this.relPos2Y*this.norZ-this.relPos2Z*this.norY;this.norTorque2Y=this.relPos2Z*this.norX-this.relPos2X*this.norZ;this.norTorque2Z=this.relPos2X*this.norY-this.relPos2Y*this.norX;this.tanTorque1X=this.relPos1Y*this.tanZ-this.relPos1Z*this.tanY;this.tanTorque1Y=this.relPos1Z*this.tanX-this.relPos1X*this.tanZ;this.tanTorque1Z=this.relPos1X*this.tanY-this.relPos1Y*this.tanX;this.tanTorque2X=this.relPos2Y*this.tanZ-this.relPos2Z*this.tanY;this.tanTorque2Y=this.relPos2Z*this.tanX-this.relPos2X*this.tanZ;this.tanTorque2Z=this.relPos2X*this.tanY-this.relPos2Y*this.tanX;this.binTorque1X=this.relPos1Y*this.binZ-this.relPos1Z*this.binY;this.binTorque1Y=this.relPos1Z*this.binX-this.relPos1X*this.binZ;this.binTorque1Z=this.relPos1X*this.binY-this.relPos1Y*this.binX;this.binTorque2X=this.relPos2Y*this.binZ-this.relPos2Z*this.binY;this.binTorque2Y=this.relPos2Z*this.binX-this.relPos2X*this.binZ;this.binTorque2Z=this.relPos2X*this.binY-this.relPos2Y*this.binX;this.norTorqueUnit1X=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02;this.norTorqueUnit1Y=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12;this.norTorqueUnit1Z=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22;this.norTorqueUnit2X=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02;this.norTorqueUnit2Y=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12;this.norTorqueUnit2Z=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22;this.tanTorqueUnit1X=this.tanTorque1X*this.invI1e00+this.tanTorque1Y*this.invI1e01+this.tanTorque1Z*this.invI1e02;this.tanTorqueUnit1Y=this.tanTorque1X*this.invI1e10+this.tanTorque1Y*this.invI1e11+this.tanTorque1Z*this.invI1e12;this.tanTorqueUnit1Z=this.tanTorque1X*this.invI1e20+this.tanTorque1Y*this.invI1e21+this.tanTorque1Z*this.invI1e22;this.tanTorqueUnit2X=this.tanTorque2X*this.invI2e00+this.tanTorque2Y*this.invI2e01+this.tanTorque2Z*this.invI2e02;this.tanTorqueUnit2Y=this.tanTorque2X*this.invI2e10+this.tanTorque2Y*this.invI2e11+this.tanTorque2Z*this.invI2e12;this.tanTorqueUnit2Z=this.tanTorque2X*this.invI2e20+this.tanTorque2Y*this.invI2e21+this.tanTorque2Z*this.invI2e22;this.binTorqueUnit1X=this.binTorque1X*this.invI1e00+this.binTorque1Y*this.invI1e01+this.binTorque1Z*this.invI1e02;this.binTorqueUnit1Y=this.binTorque1X*this.invI1e10+this.binTorque1Y*this.invI1e11+this.binTorque1Z*this.invI1e12;this.binTorqueUnit1Z=this.binTorque1X*this.invI1e20+this.binTorque1Y*this.invI1e21+this.binTorque1Z*this.invI1e22;this.binTorqueUnit2X=this.binTorque2X*this.invI2e00+this.binTorque2Y*this.invI2e01+this.binTorque2Z*this.invI2e02;this.binTorqueUnit2Y=this.binTorque2X*this.invI2e10+this.binTorque2Y*this.invI2e11+this.binTorque2Z*this.invI2e12;this.binTorqueUnit2Z=this.binTorque2X*this.invI2e20+this.binTorque2Y*this.invI2e21+this.binTorque2Z*this.invI2e22;var i;var s;var o;var u;var a;var f;i=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02;s=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12;o=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22;u=s*this.relPos1Z-o*this.relPos1Y;a=o*this.relPos1X-i*this.relPos1Z;f=i*this.relPos1Y-s*this.relPos1X;i=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02;s=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12;o=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22;u+=s*this.relPos2Z-o*this.relPos2Y;a+=o*this.relPos2X-i*this.relPos2Z;f+=i*this.relPos2Y-s*this.relPos2X;this.normalDenominator=1/(this.invM1+this.invM2+this.norX*u+this.norY*a+this.norZ*f);i=this.tanTorque1X*this.invI1e00+this.tanTorque1Y*this.invI1e01+this.tanTorque1Z*this.invI1e02;s=this.tanTorque1X*this.invI1e10+this.tanTorque1Y*this.invI1e11+this.tanTorque1Z*this.invI1e12;o=this.tanTorque1X*this.invI1e20+this.tanTorque1Y*this.invI1e21+this.tanTorque1Z*this.invI1e22;u=s*this.relPos1Z-o*this.relPos1Y;a=o*this.relPos1X-i*this.relPos1Z;f=i*this.relPos1Y-s*this.relPos1X;i=this.tanTorque2X*this.invI2e00+this.tanTorque2Y*this.invI2e01+this.tanTorque2Z*this.invI2e02;s=this.tanTorque2X*this.invI2e10+this.tanTorque2Y*this.invI2e11+this.tanTorque2Z*this.invI2e12;o=this.tanTorque2X*this.invI2e20+this.tanTorque2Y*this.invI2e21+this.tanTorque2Z*this.invI2e22;u+=s*this.relPos2Z-o*this.relPos2Y;a+=o*this.relPos2X-i*this.relPos2Z;f+=i*this.relPos2Y-s*this.relPos2X;this.tangentDenominator=1/(this.invM1+this.invM2+this.tanX*u+this.tanY*a+this.tanZ*f);i=this.binTorque1X*this.invI1e00+this.binTorque1Y*this.invI1e01+this.binTorque1Z*this.invI1e02;s=this.binTorque1X*this.invI1e10+this.binTorque1Y*this.invI1e11+this.binTorque1Z*this.invI1e12;o=this.binTorque1X*this.invI1e20+this.binTorque1Y*this.invI1e21+this.binTorque1Z*this.invI1e22;u=s*this.relPos1Z-o*this.relPos1Y;a=o*this.relPos1X-i*this.relPos1Z;f=i*this.relPos1Y-s*this.relPos1X;i=this.binTorque2X*this.invI2e00+this.binTorque2Y*this.invI2e01+this.binTorque2Z*this.invI2e02;s=this.binTorque2X*this.invI2e10+this.binTorque2Y*this.invI2e11+this.binTorque2Z*this.invI2e12;o=this.binTorque2X*this.invI2e20+this.binTorque2Y*this.invI2e21+this.binTorque2Z*this.invI2e22;u+=s*this.relPos2Z-o*this.relPos2Y;a+=o*this.relPos2X-i*this.relPos2Z;f+=i*this.relPos2Y-s*this.relPos2X;this.binormalDenominator=1/(this.invM1+this.invM2+this.binX*u+this.binY*a+this.binZ*f);if(this.warmStarted){this.tangentImpulse*=.95;this.binormalImpulse*=.95;i=this.norX*this.normalImpulse+this.tanX*this.tangentImpulse+this.binX*this.binormalImpulse;s=this.norY*this.normalImpulse+this.tanY*this.tangentImpulse+this.binY*this.binormalImpulse;o=this.norZ*this.normalImpulse+this.tanZ*this.tangentImpulse+this.binZ*this.binormalImpulse;this.lVel1.x+=i*this.invM1;this.lVel1.y+=s*this.invM1;this.lVel1.z+=o*this.invM1;this.aVel1.x+=this.norTorqueUnit1X*this.normalImpulse+this.tanTorqueUnit1X*this.tangentImpulse+this.binTorqueUnit1X*this.binormalImpulse;this.aVel1.y+=this.norTorqueUnit1Y*this.normalImpulse+this.tanTorqueUnit1Y*this.tangentImpulse+this.binTorqueUnit1Y*this.binormalImpulse;this.aVel1.z+=this.norTorqueUnit1Z*this.normalImpulse+this.tanTorqueUnit1Z*this.tangentImpulse+this.binTorqueUnit1Z*this.binormalImpulse;this.lVel2.x-=i*this.invM2;this.lVel2.y-=s*this.invM2;this.lVel2.z-=o*this.invM2;this.aVel2.x-=this.norTorqueUnit2X*this.normalImpulse+this.tanTorqueUnit2X*this.tangentImpulse+this.binTorqueUnit2X*this.binormalImpulse;this.aVel2.y-=this.norTorqueUnit2Y*this.normalImpulse+this.tanTorqueUnit2Y*this.tangentImpulse+this.binTorqueUnit2Y*this.binormalImpulse;this.aVel2.z-=this.norTorqueUnit2Z*this.normalImpulse+this.tanTorqueUnit2Z*this.tangentImpulse+this.binTorqueUnit2Z*this.binormalImpulse;n=0}if(n>-1){n=0}this.targetNormalVelocity=this.restitution*-n;var l=-this.overlap-.005;if(l>0){l*=t*.05;if(this.targetNormalVelocity<l){this.targetNormalVelocity=l}}};OIMO.Contact.prototype.solve=function(){var e;var t;var n;var r;var i;var s;var o;var u;var a;var f;var l;var c;s=(this.lVel2.x-this.lVel1.x)*this.norX+(this.lVel2.y-this.lVel1.y)*this.norY+(this.lVel2.z-this.lVel1.z)*this.norZ+this.aVel2.x*this.norTorque2X+this.aVel2.y*this.norTorque2Y+this.aVel2.z*this.norTorque2Z-this.aVel1.x*this.norTorque1X-this.aVel1.y*this.norTorque1Y-this.aVel1.z*this.norTorque1Z;t=this.normalImpulse;n=(s-this.targetNormalVelocity)*this.normalDenominator*1.4;this.normalImpulse+=n;if(this.normalImpulse>0)this.normalImpulse=0;n=this.normalImpulse-t;o=this.norX*n;u=this.norY*n;a=this.norZ*n;this.lVel1.x+=o*this.invM1;this.lVel1.y+=u*this.invM1;this.lVel1.z+=a*this.invM1;this.aVel1.x+=this.norTorqueUnit1X*n;this.aVel1.y+=this.norTorqueUnit1Y*n;this.aVel1.z+=this.norTorqueUnit1Z*n;this.lVel2.x-=o*this.invM2;this.lVel2.y-=u*this.invM2;this.lVel2.z-=a*this.invM2;this.aVel2.x-=this.norTorqueUnit2X*n;this.aVel2.y-=this.norTorqueUnit2Y*n;this.aVel2.z-=this.norTorqueUnit2Z*n;var h=-this.normalImpulse*this.friction;this.relVelX=this.lVel2.x-this.lVel1.x;this.relVelY=this.lVel2.y-this.lVel1.y;this.relVelZ=this.lVel2.z-this.lVel1.z;s=this.relVelX*this.tanX+this.relVelY*this.tanY+this.relVelZ*this.tanZ+this.aVel2.x*this.tanTorque2X+this.aVel2.y*this.tanTorque2Y+this.aVel2.z*this.tanTorque2Z-this.aVel1.x*this.tanTorque1X-this.aVel1.y*this.tanTorque1Y-this.aVel1.z*this.tanTorque1Z;t=this.tangentImpulse;n=s*this.tangentDenominator;this.tangentImpulse+=n;s=this.relVelX*this.binX+this.relVelY*this.binY+this.relVelZ*this.binZ+this.aVel2.x*this.binTorque2X+this.aVel2.y*this.binTorque2Y+this.aVel2.z*this.binTorque2Z-this.aVel1.x*this.binTorque1X-this.aVel1.y*this.binTorque1Y-this.aVel1.z*this.binTorque1Z;r=this.binormalImpulse;i=s*this.binormalDenominator;this.binormalImpulse+=i;var p=this.tangentImpulse*this.tangentImpulse+this.binormalImpulse*this.binormalImpulse;if(p>h*h){p=h/Math.sqrt(p);this.tangentImpulse*=p;this.binormalImpulse*=p}n=this.tangentImpulse-t;i=this.binormalImpulse-r;o=this.tanX*n+this.binX*i;u=this.tanY*n+this.binY*i;a=this.tanZ*n+this.binZ*i;this.lVel1.x+=o*this.invM1;this.lVel1.y+=u*this.invM1;this.lVel1.z+=a*this.invM1;this.aVel1.x+=this.tanTorqueUnit1X*n+this.binTorqueUnit1X*i;this.aVel1.y+=this.tanTorqueUnit1Y*n+this.binTorqueUnit1Y*i;this.aVel1.z+=this.tanTorqueUnit1Z*n+this.binTorqueUnit1Z*i;this.lVel2.x-=o*this.invM2;this.lVel2.y-=u*this.invM2;this.lVel2.z-=a*this.invM2;this.aVel2.x-=this.tanTorqueUnit2X*n+this.binTorqueUnit2X*i;this.aVel2.y-=this.tanTorqueUnit2Y*n+this.binTorqueUnit2Y*i;this.aVel2.z-=this.tanTorqueUnit2Z*n+this.binTorqueUnit2Z*i};OIMO.Contact.prototype.postSolve=function(){this.relativePosition1.x=this.relPos1X;this.relativePosition1.y=this.relPos1Y;this.relativePosition1.z=this.relPos1Z;this.relativePosition2.x=this.relPos2X;this.relativePosition2.y=this.relPos2Y;this.relativePosition2.z=this.relPos2Z;this.normal.x=this.norX;this.normal.y=this.norY;this.normal.z=this.norZ;this.tangent.x=this.tanX;this.tangent.y=this.tanY;this.tangent.z=this.tanZ;this.binormal.x=this.binX;this.binormal.y=this.binY;this.binormal.z=this.binZ};OIMO.ContactConnection=function(e){this.prev=null;this.next=null;this.connectedShape=null;this.connectedBody=null;this.parent=e};OIMO.Shape=function(){this.type=0;this.mass=NaN;this.friction=NaN;this.restitution=NaN;this.parent=null;this.contactList=null;this.numContacts=0;this.id=OIMO.nextID++;this.position=new OIMO.Vec3;this.relativePosition=new OIMO.Vec3;this.localRelativePosition=new OIMO.Vec3;this.rotation=new OIMO.Mat33;this.relativeRotation=new OIMO.Mat33;this.localInertia=new OIMO.Mat33;this.proxy=new OIMO.Proxy;this.proxy.parent=this};OIMO.Shape.prototype={constructor:OIMO.Shape,updateProxy:function(){throw new Error("Inheritance error.")}};OIMO.ShapeConfig=function(){this.position=new OIMO.Vec3;this.rotation=new OIMO.Mat33;this.friction=.5;this.restitution=.5;this.density=1};OIMO.BoxShape=function(e,t,n,r){OIMO.Shape.call(this);this.width=t;this.halfWidth=t*.5;this.height=n;this.halfHeight=n*.5;this.depth=r;this.halfDepth=r*.5;this.position.copy(e.position);this.rotation.copy(e.rotation);this.friction=e.friction;this.restitution=e.restitution;this.mass=t*n*r*e.density;var i=this.mass/12;this.localInertia.init(i*(n*n+r*r),0,0,0,i*(t*t+r*r),0,0,0,i*(t*t+n*n));this.normalDirectionWidth=new OIMO.Vec3;this.normalDirectionHeight=new OIMO.Vec3;this.normalDirectionDepth=new OIMO.Vec3;this.halfDirectionWidth=new OIMO.Vec3;this.halfDirectionHeight=new OIMO.Vec3;this.halfDirectionDepth=new OIMO.Vec3;this.vertex1=new OIMO.Vec3;this.vertex2=new OIMO.Vec3;this.vertex3=new OIMO.Vec3;this.vertex4=new OIMO.Vec3;this.vertex5=new OIMO.Vec3;this.vertex6=new OIMO.Vec3;this.vertex7=new OIMO.Vec3;this.vertex8=new OIMO.Vec3;this.type=OIMO.SHAPE_BOX};OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.BoxShape.prototype.updateProxy=function(){var e=this.rotation.elements;this.normalDirectionWidth.x=e[0];this.normalDirectionWidth.y=e[3];this.normalDirectionWidth.z=e[6];this.normalDirectionHeight.x=e[1];this.normalDirectionHeight.y=e[4];this.normalDirectionHeight.z=e[7];this.normalDirectionDepth.x=e[2];this.normalDirectionDepth.y=e[5];this.normalDirectionDepth.z=e[8];this.halfDirectionWidth.x=e[0]*this.halfWidth;this.halfDirectionWidth.y=e[3]*this.halfWidth;this.halfDirectionWidth.z=e[6]*this.halfWidth;this.halfDirectionHeight.x=e[1]*this.halfHeight;this.halfDirectionHeight.y=e[4]*this.halfHeight;this.halfDirectionHeight.z=e[7]*this.halfHeight;this.halfDirectionDepth.x=e[2]*this.halfDepth;this.halfDirectionDepth.y=e[5]*this.halfDepth;this.halfDirectionDepth.z=e[8]*this.halfDepth;var t=this.halfDirectionWidth.x;var n=this.halfDirectionWidth.y;var r=this.halfDirectionWidth.z;var i=this.halfDirectionHeight.x;var s=this.halfDirectionHeight.y;var o=this.halfDirectionHeight.z;var u=this.halfDirectionDepth.x;var a=this.halfDirectionDepth.y;var f=this.halfDirectionDepth.z;var l=this.position.x;var c=this.position.y;var h=this.position.z;this.vertex1.x=l+t+i+u;this.vertex1.y=c+n+s+a;this.vertex1.z=h+r+o+f;this.vertex2.x=l+t+i-u;this.vertex2.y=c+n+s-a;this.vertex2.z=h+r+o-f;this.vertex3.x=l+t-i+u;this.vertex3.y=c+n-s+a;this.vertex3.z=h+r-o+f;this.vertex4.x=l+t-i-u;this.vertex4.y=c+n-s-a;this.vertex4.z=h+r-o-f;this.vertex5.x=l-t+i+u;this.vertex5.y=c-n+s+a;this.vertex5.z=h-r+o+f;this.vertex6.x=l-t+i-u;this.vertex6.y=c-n+s-a;this.vertex6.z=h-r+o-f;this.vertex7.x=l-t-i+u;this.vertex7.y=c-n-s+a;this.vertex7.z=h-r-o+f;this.vertex8.x=l-t-i-u;this.vertex8.y=c-n-s-a;this.vertex8.z=h-r-o-f;var p;var d;var v;if(this.halfDirectionWidth.x<0){p=-this.halfDirectionWidth.x}else{p=this.halfDirectionWidth.x}if(this.halfDirectionWidth.y<0){d=-this.halfDirectionWidth.y}else{d=this.halfDirectionWidth.y}if(this.halfDirectionWidth.z<0){v=-this.halfDirectionWidth.z}else{v=this.halfDirectionWidth.z}if(this.halfDirectionHeight.x<0){p-=this.halfDirectionHeight.x}else{p+=this.halfDirectionHeight.x}if(this.halfDirectionHeight.y<0){d-=this.halfDirectionHeight.y}else{d+=this.halfDirectionHeight.y}if(this.halfDirectionHeight.z<0){v-=this.halfDirectionHeight.z}else{v+=this.halfDirectionHeight.z}if(this.halfDirectionDepth.x<0){p-=this.halfDirectionDepth.x}else{p+=this.halfDirectionDepth.x}if(this.halfDirectionDepth.y<0){d-=this.halfDirectionDepth.y}else{d+=this.halfDirectionDepth.y}if(this.halfDirectionDepth.z<0){v-=this.halfDirectionDepth.z}else{v+=this.halfDirectionDepth.z}this.proxy.init(this.position.x-p,this.position.x+p,this.position.y-d,this.position.y+d,this.position.z-v,this.position.z+v)};OIMO.CylinderShape=function(e,t,n){OIMO.Shape.call(this);this.radius=t;this.height=n;this.halfHeight=n*.5;this.position.copy(e.position);this.rotation.copy(e.rotation);this.friction=e.friction;this.restitution=e.restitution;this.mass=Math.PI*t*t*n*e.density;var r=(1/4*t*t+1/12*n*n)*this.mass;var i=1/2*t*t;this.localInertia.init(r,0,0,0,i,0,0,0,r);this.normalDirection=new OIMO.Vec3;this.halfDirection=new OIMO.Vec3;this.type=OIMO.SHAPE_CYLINDER};OIMO.CylinderShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.CylinderShape.prototype.updateProxy=function(){var e=this.rotation.elements;var t;var n;var r;var i;var s=e[1];var o=e[4];var u=e[7];var a=s*s;var f=o*o;var l=u*u;this.normalDirection.x=s;this.normalDirection.y=o;this.normalDirection.z=u;this.halfDirection.x=s*this.halfHeight;this.halfDirection.y=o*this.halfHeight;this.halfDirection.z=u*this.halfHeight;n=1-s*s;t=Math.sqrt(n*n+a*f+a*l);if(t>0)t=this.radius/t;n*=t;r=1-o*o;t=Math.sqrt(f*a+r*r+f*l);if(t>0)t=this.radius/t;r*=t;i=1-u*u;t=Math.sqrt(l*a+l*f+i*i);if(t>0)t=this.radius/t;i*=t;var c;var h;var p;if(this.halfDirection.x<0)c=-this.halfDirection.x;else c=this.halfDirection.x;if(this.halfDirection.y<0)h=-this.halfDirection.y;else h=this.halfDirection.y;if(this.halfDirection.z<0)p=-this.halfDirection.z;else p=this.halfDirection.z;if(n<0)c-=n;else c+=n;if(r<0)h-=r;else h+=r;if(i<0)p-=i;else p+=i;this.proxy.init(this.position.x-c,this.position.x+c,this.position.y-h,this.position.y+h,this.position.z-p,this.position.z+p)};OIMO.SphereShape=function(e,t){OIMO.Shape.call(this);this.radius=t;this.position.copy(e.position);this.rotation.copy(e.rotation);this.friction=e.friction;this.restitution=e.restitution;this.mass=4/3*Math.PI*t*t*t*e.density;var n=2/5*t*t*this.mass;this.localInertia.init(n,0,0,0,n,0,0,0,n);this.type=OIMO.SHAPE_SPHERE};OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.SphereShape.prototype.updateProxy=function(){this.proxy.init(this.position.x-this.radius,this.position.x+this.radius,this.position.y-this.radius,this.position.y+this.radius,this.position.z-this.radius,this.position.z+this.radius)};OIMO.ContactID=function(){this.data1=0;this.data2=0;this.flip=false};OIMO.ContactID.prototype={constructor:OIMO.ContactID,equals:function(e){return this.flip==e.flip?this.data1==e.data1&&this.data2==e.data2:this.data2==e.data1&&this.data1==e.data2}};OIMO.ContactInfo=function(){this.overlap=NaN;this.shape1=null;this.shape2=null;this.position=new OIMO.Vec3;this.normal=new OIMO.Vec3;this.id=new OIMO.ContactID};OIMO.CollisionDetector=function(){this.flip=false};OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(e,t,n){throw new Error("detectCollision Function is not inherited")}};OIMO.CollisionResult=function(e){this.numContactInfos=0;this.maxContactInfos=e;this.contactInfos=[]};OIMO.CollisionResult.prototype={constructor:OIMO.CollisionResult,addContactInfo:function(e,t,n,r,i,s,o,u,a,f,l,c){if(this.numContactInfos==this.maxContactInfos)return;if(!this.contactInfos[this.numContactInfos]){this.contactInfos[this.numContactInfos]=new OIMO.ContactInfo}var h=this.contactInfos[this.numContactInfos++];h.position.x=e;h.position.y=t;h.position.z=n;h.normal.x=r;h.normal.y=i;h.normal.z=s;h.overlap=o;h.shape1=u;h.shape2=a;h.id.data1=f;h.id.data2=l;h.id.flip=c}};OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this);this.clipVertices1=[];this.clipVertices2=[];this.clipVertices1.length=24;this.clipVertices2.length=24;this.used=[];this.INF=1/0};OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(e,t,n){var r;var i;if(e.id<t.id){r=e;i=t}else{r=t;i=e}var s=r.position;var o=i.position;var u=s.x;var a=s.y;var f=s.z;var l=o.x;var c=o.y;var h=o.z;var p=l-u;var d=c-a;var v=h-f;var m=r.halfWidth;var g=r.halfHeight;var y=r.halfDepth;var b=i.halfWidth;var w=i.halfHeight;var E=i.halfDepth;var S=r.halfDirectionWidth.x;var x=r.halfDirectionWidth.y;var T=r.halfDirectionWidth.z;var N=r.halfDirectionHeight.x;var C=r.halfDirectionHeight.y;var k=r.halfDirectionHeight.z;var L=r.halfDirectionDepth.x;var A=r.halfDirectionDepth.y;var O=r.halfDirectionDepth.z;var M=i.halfDirectionWidth.x;var _=i.halfDirectionWidth.y;var D=i.halfDirectionWidth.z;var P=i.halfDirectionHeight.x;var H=i.halfDirectionHeight.y;var B=i.halfDirectionHeight.z;var j=i.halfDirectionDepth.x;var F=i.halfDirectionDepth.y;var I=i.halfDirectionDepth.z;var q=r.normalDirectionWidth.x;var R=r.normalDirectionWidth.y;var U=r.normalDirectionWidth.z;var z=r.normalDirectionHeight.x;var W=r.normalDirectionHeight.y;var X=r.normalDirectionHeight.z;var V=r.normalDirectionDepth.x;var $=r.normalDirectionDepth.y;var J=r.normalDirectionDepth.z;var K=i.normalDirectionWidth.x;var Q=i.normalDirectionWidth.y;var G=i.normalDirectionWidth.z;var Y=i.normalDirectionHeight.x;var Z=i.normalDirectionHeight.y;var et=i.normalDirectionHeight.z;var tt=i.normalDirectionDepth.x;var nt=i.normalDirectionDepth.y;var rt=i.normalDirectionDepth.z;var it=R*G-U*Q;var st=U*K-q*G;var ot=q*Q-R*K;var ut=R*et-U*Z;var at=U*Y-q*et;var ft=q*Z-R*Y;var lt=R*rt-U*nt;var ct=U*tt-q*rt;var ht=q*nt-R*tt;var pt=W*G-X*Q;var dt=X*K-z*G;var vt=z*Q-W*K;var mt=W*et-X*Z;var gt=X*Y-z*et;var yt=z*Z-W*Y;var bt=W*rt-X*nt;var wt=X*tt-z*rt;var Et=z*nt-W*tt;var St=$*G-J*Q;var xt=J*K-V*G;var Tt=V*Q-$*K;var Nt=$*et-J*Z;var Ct=J*Y-V*et;var kt=V*Z-$*Y;var Lt=$*rt-J*nt;var At=J*tt-V*rt;var Ot=V*nt-$*tt;var Mt;var _t;var Dt;var Pt;var Ht;var Bt;var jt;var Ft;var It;var qt;var Rt;var Ut;var zt;var Wt;var Xt;var Vt;var $t;var Jt;var Kt;var Qt;var Gt;var Yt;var Zt;var en;var tn;var nn;var rn;var sn;var on;var un;var an=false;var fn=false;var ln=false;var cn=false;var hn=false;var pn=false;var dn=false;var vn=false;var mn=false;var gn;var yn;var bn;var wn;var En;var Sn;gn=q*p+R*d+U*v;Mt=gn>0;if(!Mt)gn=-gn;yn=m;wn=q*K+R*Q+U*G;En=q*Y+R*Z+U*et;Sn=q*tt+R*nt+U*rt;if(wn<0)wn=-wn;if(En<0)En=-En;if(Sn<0)Sn=-Sn;bn=wn*b+En*w+Sn*E;Vt=gn-yn-bn;if(Vt>0)return;gn=z*p+W*d+X*v;_t=gn>0;if(!_t)gn=-gn;yn=g;wn=z*K+W*Q+X*G;En=z*Y+W*Z+X*et;Sn=z*tt+W*nt+X*rt;if(wn<0)wn=-wn;if(En<0)En=-En;if(Sn<0)Sn=-Sn;bn=wn*b+En*w+Sn*E;$t=gn-yn-bn;if($t>0)return;gn=V*p+$*d+J*v;Dt=gn>0;if(!Dt)gn=-gn;yn=y;wn=V*K+$*Q+J*G;En=V*Y+$*Z+J*et;Sn=V*tt+$*nt+J*rt;if(wn<0)wn=-wn;if(En<0)En=-En;if(Sn<0)Sn=-Sn;bn=wn*b+En*w+Sn*E;Jt=gn-yn-bn;if(Jt>0)return;gn=K*p+Q*d+G*v;Pt=gn>0;if(!Pt)gn=-gn;wn=K*q+Q*R+G*U;En=K*z+Q*W+G*X;Sn=K*V+Q*$+G*J;if(wn<0)wn=-wn;if(En<0)En=-En;if(Sn<0)Sn=-Sn;yn=wn*m+En*g+Sn*y;bn=b;Kt=(gn-yn-bn)*1;if(Kt>0)return;gn=Y*p+Z*d+et*v;Ht=gn>0;if(!Ht)gn=-gn;wn=Y*q+Z*R+et*U;En=Y*z+Z*W+et*X;Sn=Y*V+Z*$+et*J;if(wn<0)wn=-wn;if(En<0)En=-En;if(Sn<0)Sn=-Sn;yn=wn*m+En*g+Sn*y;bn=w;Qt=(gn-yn-bn)*1;if(Qt>0)return;gn=tt*p+nt*d+rt*v;Bt=gn>0;if(!Bt)gn=-gn;wn=tt*q+nt*R+rt*U;En=tt*z+nt*W+rt*X;Sn=tt*V+nt*$+rt*J;if(wn<0)wn=-wn;if(En<0)En=-En;if(Sn<0)Sn=-Sn;yn=wn*m+En*g+Sn*y;bn=E;Gt=(gn-yn-bn)*1;if(Gt>0)return;gn=it*it+st*st+ot*ot;if(gn>1e-5){gn=1/Math.sqrt(gn);it*=gn;st*=gn;ot*=gn;gn=it*p+st*d+ot*v;jt=gn>0;if(!jt)gn=-gn;wn=it*z+st*W+ot*X;En=it*V+st*$+ot*J;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*g+En*y;wn=it*Y+st*Z+ot*et;En=it*tt+st*nt+ot*rt;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*w+En*E;Yt=gn-yn-bn;if(Yt>0)return}else{jt=false;Yt=0;an=true}gn=ut*ut+at*at+ft*ft;if(gn>1e-5){gn=1/Math.sqrt(gn);ut*=gn;at*=gn;ft*=gn;gn=ut*p+at*d+ft*v;Ft=gn>0;if(!Ft)gn=-gn;wn=ut*z+at*W+ft*X;En=ut*V+at*$+ft*J;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*g+En*y;wn=ut*K+at*Q+ft*G;En=ut*tt+at*nt+ft*rt;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*b+En*E;Zt=gn-yn-bn;if(Zt>0)return}else{Ft=false;Zt=0;fn=true}gn=lt*lt+ct*ct+ht*ht;if(gn>1e-5){gn=1/Math.sqrt(gn);lt*=gn;ct*=gn;ht*=gn;gn=lt*p+ct*d+ht*v;It=gn>0;if(!It)gn=-gn;wn=lt*z+ct*W+ht*X;En=lt*V+ct*$+ht*J;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*g+En*y;wn=lt*K+ct*Q+ht*G;En=lt*Y+ct*Z+ht*et;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*b+En*w;en=gn-yn-bn;if(en>0)return}else{It=false;en=0;ln=true}gn=pt*pt+dt*dt+vt*vt;if(gn>1e-5){gn=1/Math.sqrt(gn);pt*=gn;dt*=gn;vt*=gn;gn=pt*p+dt*d+vt*v;qt=gn>0;if(!qt)gn=-gn;wn=pt*q+dt*R+vt*U;En=pt*V+dt*$+vt*J;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*m+En*y;wn=pt*Y+dt*Z+vt*et;En=pt*tt+dt*nt+vt*rt;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*w+En*E;tn=gn-yn-bn;if(tn>0)return}else{qt=false;tn=0;cn=true}gn=mt*mt+gt*gt+yt*yt;if(gn>1e-5){gn=1/Math.sqrt(gn);mt*=gn;gt*=gn;yt*=gn;gn=mt*p+gt*d+yt*v;Rt=gn>0;if(!Rt)gn=-gn;wn=mt*q+gt*R+yt*U;En=mt*V+gt*$+yt*J;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*m+En*y;wn=mt*K+gt*Q+yt*G;En=mt*tt+gt*nt+yt*rt;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*b+En*E;nn=gn-yn-bn;if(nn>0)return}else{Rt=false;nn=0;hn=true}gn=bt*bt+wt*wt+Et*Et;if(gn>1e-5){gn=1/Math.sqrt(gn);bt*=gn;wt*=gn;Et*=gn;gn=bt*p+wt*d+Et*v;Ut=gn>0;if(!Ut)gn=-gn;wn=bt*q+wt*R+Et*U;En=bt*V+wt*$+Et*J;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*m+En*y;wn=bt*K+wt*Q+Et*G;En=bt*Y+wt*Z+Et*et;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*b+En*w;rn=gn-yn-bn;if(rn>0)return}else{Ut=false;rn=0;pn=true}gn=St*St+xt*xt+Tt*Tt;if(gn>1e-5){gn=1/Math.sqrt(gn);St*=gn;xt*=gn;Tt*=gn;gn=St*p+xt*d+Tt*v;zt=gn>0;if(!zt)gn=-gn;wn=St*q+xt*R+Tt*U;En=St*z+xt*W+Tt*X;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*m+En*g;wn=St*Y+xt*Z+Tt*et;En=St*tt+xt*nt+Tt*rt;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*w+En*E;sn=gn-yn-bn;if(sn>0)return}else{zt=false;sn=0;dn=true}gn=Nt*Nt+Ct*Ct+kt*kt;if(gn>1e-5){gn=1/Math.sqrt(gn);Nt*=gn;Ct*=gn;kt*=gn;gn=Nt*p+Ct*d+kt*v;Wt=gn>0;if(!Wt)gn=-gn;wn=Nt*q+Ct*R+kt*U;En=Nt*z+Ct*W+kt*X;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*m+En*g;wn=Nt*K+Ct*Q+kt*G;En=Nt*tt+Ct*nt+kt*rt;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*b+En*E;on=gn-yn-bn;if(on>0)return}else{Wt=false;on=0;vn=true}gn=Lt*Lt+At*At+Ot*Ot;if(gn>1e-5){gn=1/Math.sqrt(gn);Lt*=gn;At*=gn;Ot*=gn;gn=Lt*p+At*d+Ot*v;Xt=gn>0;if(!Xt)gn=-gn;wn=Lt*q+At*R+Ot*U;En=Lt*z+At*W+Ot*X;if(wn<0)wn=-wn;if(En<0)En=-En;yn=wn*m+En*g;wn=Lt*K+At*Q+Ot*G;En=Lt*Y+At*Z+Ot*et;if(wn<0)wn=-wn;if(En<0)En=-En;bn=wn*b+En*w;un=gn-yn-bn;if(un>0)return}else{Xt=false;un=0;mn=true}var xn=Vt;var Tn=Vt;var Nn=0;var Cn=Mt;if($t>Tn){xn=$t;Tn=$t;Nn=1;Cn=_t}if(Jt>Tn){xn=Jt;Tn=Jt;Nn=2;Cn=Dt}if(Kt-.005>Tn){xn=Kt;Tn=Kt-.005;Nn=3;Cn=Pt}if(Qt-.005>Tn){xn=Qt;Tn=Qt-.005;Nn=4;Cn=Ht}if(Gt-.005>Tn){xn=Gt;Tn=Gt-.005;Nn=5;Cn=Bt}if(Yt-.01>Tn&&!an){xn=Yt;Tn=Yt-.01;Nn=6;Cn=jt}if(Zt-.01>Tn&&!fn){xn=Zt;Tn=Zt-.01;Nn=7;Cn=Ft}if(en-.01>Tn&&!ln){xn=en;Tn=en-.01;Nn=8;Cn=It}if(tn-.01>Tn&&!cn){xn=tn;Tn=tn-.01;Nn=9;Cn=qt}if(nn-.01>Tn&&!hn){xn=nn;Tn=nn-.01;Nn=10;Cn=Rt}if(rn-.01>Tn&&!pn){xn=rn;Tn=rn-.01;Nn=11;Cn=Ut}if(sn-.01>Tn&&!dn){xn=sn;Tn=sn-.01;Nn=12;Cn=zt}if(on-.01>Tn&&!vn){xn=on;Tn=on-.01;Nn=13;Cn=Wt}if(un-.01>Tn&&!mn){xn=un;Nn=14;Cn=Xt}var kn=0;var Ln=0;var An=0;var On=0;var Mn=0;var _n=0;var Dn=0;var Pn=0;var Hn=0;var Bn=0;var jn=0;var Fn=0;var In=0;var qn=0;var Rn=0;var Un=0;var zn=0;var Wn=0;var Xn=false;switch(Nn){case 0:if(Cn){Bn=u+S;jn=a+x;Fn=f+T;kn=q;Ln=R;An=U}else{Bn=u-S;jn=a-x;Fn=f-T;kn=-q;Ln=-R;An=-U}In=N;qn=C;Rn=k;On=-z;Mn=-W;_n=-X;Un=L;zn=A;Wn=O;Dn=-V;Pn=-$;Hn=-J;break;case 1:if(Cn){Bn=u+N;jn=a+C;Fn=f+k;kn=z;Ln=W;An=X}else{Bn=u-N;jn=a-C;Fn=f-k;kn=-z;Ln=-W;An=-X}In=S;qn=x;Rn=T;On=-q;Mn=-R;_n=-U;Un=L;zn=A;Wn=O;Dn=-V;Pn=-$;Hn=-J;break;case 2:if(Cn){Bn=u+L;jn=a+A;Fn=f+O;kn=V;Ln=$;An=J}else{Bn=u-L;jn=a-A;Fn=f-O;kn=-V;Ln=-$;An=-J}In=S;qn=x;Rn=T;On=-q;Mn=-R;_n=-U;Un=N;zn=C;Wn=k;Dn=-z;Pn=-W;Hn=-X;break;case 3:Xn=true;if(!Cn){Bn=l+M;jn=c+_;Fn=h+D;kn=K;Ln=Q;An=G}else{Bn=l-M;jn=c-_;Fn=h-D;kn=-K;Ln=-Q;An=-G}In=P;qn=H;Rn=B;On=-Y;Mn=-Z;_n=-et;Un=j;zn=F;Wn=I;Dn=-tt;Pn=-nt;Hn=-rt;break;case 4:Xn=true;if(!Cn){Bn=l+P;jn=c+H;Fn=h+B;kn=Y;Ln=Z;An=et}else{Bn=l-P;jn=c-H;Fn=h-B;kn=-Y;Ln=-Z;An=-et}In=M;qn=_;Rn=D;On=-K;Mn=-Q;_n=-G;Un=j;zn=F;Wn=I;Dn=-tt;Pn=-nt;Hn=-rt;break;case 5:Xn=true;if(!Cn){Bn=l+j;jn=c+F;Fn=h+I;kn=tt;Ln=nt;An=rt}else{Bn=l-j;jn=c-F;Fn=h-I;kn=-tt;Ln=-nt;An=-rt}In=M;qn=_;Rn=D;On=-K;Mn=-Q;_n=-G;Un=P;zn=H;Wn=B;Dn=-Y;Pn=-Z;Hn=-et;break;case 6:kn=it;Ln=st;An=ot;On=q;Mn=R;_n=U;Dn=K;Pn=Q;Hn=G;break;case 7:kn=ut;Ln=at;An=ft;On=q;Mn=R;_n=U;Dn=Y;Pn=Z;Hn=et;break;case 8:kn=lt;Ln=ct;An=ht;On=q;Mn=R;_n=U;Dn=tt;Pn=nt;Hn=rt;break;case 9:kn=pt;Ln=dt;An=vt;On=z;Mn=W;_n=X;Dn=K;Pn=Q;Hn=G;break;case 10:kn=mt;Ln=gt;An=yt;On=z;Mn=W;_n=X;Dn=Y;Pn=Z;Hn=et;break;case 11:kn=bt;Ln=wt;An=Et;On=z;Mn=W;_n=X;Dn=tt;Pn=nt;Hn=rt;break;case 12:kn=St;Ln=xt;An=Tt;On=V;Mn=$;_n=J;Dn=K;Pn=Q;Hn=G;break;case 13:kn=Nt;Ln=Ct;An=kt;On=V;Mn=$;_n=J;Dn=Y;Pn=Z;Hn=et;break;case 14:kn=Lt;Ln=At;An=Ot;On=V;Mn=$;_n=J;Dn=tt;Pn=nt;Hn=rt;break}var Vn;if(Nn>5){if(!Cn){kn=-kn;Ln=-Ln;An=-An}var $n;var Jn;var Kn;var Qn;var Gn;var Yn;var Zn;var er;var tr;var nr;var rr;Vn=r.vertex1;Yn=Vn.x;Zn=Vn.y;er=Vn.z;Jn=kn*Yn+Ln*Zn+An*er;Vn=r.vertex2;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n>Jn){Jn=$n;Yn=Kn;Zn=Qn;er=Gn}Vn=r.vertex3;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n>Jn){Jn=$n;Yn=Kn;Zn=Qn;er=Gn}Vn=r.vertex4;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n>Jn){Jn=$n;Yn=Kn;Zn=Qn;er=Gn}Vn=r.vertex5;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n>Jn){Jn=$n;Yn=Kn;Zn=Qn;er=Gn}Vn=r.vertex6;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n>Jn){Jn=$n;Yn=Kn;Zn=Qn;er=Gn}Vn=r.vertex7;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n>Jn){Jn=$n;Yn=Kn;Zn=Qn;er=Gn}Vn=r.vertex8;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n>Jn){Jn=$n;Yn=Kn;Zn=Qn;er=Gn}Vn=i.vertex1;tr=Vn.x;nr=Vn.y;rr=Vn.z;Jn=kn*tr+Ln*nr+An*rr;Vn=i.vertex2;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n<Jn){Jn=$n;tr=Kn;nr=Qn;rr=Gn}Vn=i.vertex3;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n<Jn){Jn=$n;tr=Kn;nr=Qn;rr=Gn}Vn=i.vertex4;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n<Jn){Jn=$n;tr=Kn;nr=Qn;rr=Gn}Vn=i.vertex5;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n<Jn){Jn=$n;tr=Kn;nr=Qn;rr=Gn}Vn=i.vertex6;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n<Jn){Jn=$n;tr=Kn;nr=Qn;rr=Gn}Vn=i.vertex7;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n<Jn){Jn=$n;tr=Kn;nr=Qn;rr=Gn}Vn=i.vertex8;Kn=Vn.x;Qn=Vn.y;Gn=Vn.z;$n=kn*Kn+Ln*Qn+An*Gn;if($n<Jn){Jn=$n;tr=Kn;nr=Qn;rr=Gn}Kn=tr-Yn;Qn=nr-Zn;Gn=rr-er;wn=On*Dn+Mn*Pn+_n*Hn;var ir=(Kn*(On-Dn*wn)+Qn*(Mn-Pn*wn)+Gn*(_n-Hn*wn))/(1-wn*wn);n.addContactInfo(Yn+On*ir+kn*xn*.5,Zn+Mn*ir+Ln*xn*.5,er+_n*ir+An*xn*.5,kn,Ln,An,xn,r,i,0,0,false);return}var sr;var or;var ur;var ar;var fr;var lr;var cr;var hr;var pr;var dr;var vr;var mr;var gr=1;var yr=0;var br=0;if(Xn){yr=q*kn+R*Ln+U*An;if(yr<gr){gr=yr;br=0}if(-yr<gr){gr=-yr;br=1}yr=z*kn+W*Ln+X*An;if(yr<gr){gr=yr;br=2}if(-yr<gr){gr=-yr;br=3}yr=V*kn+$*Ln+J*An;if(yr<gr){gr=yr;br=4}if(-yr<gr){gr=-yr;br=5}switch(br){case 0:Vn=r.vertex1;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=r.vertex3;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=r.vertex4;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=r.vertex2;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 1:Vn=r.vertex6;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=r.vertex8;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=r.vertex7;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=r.vertex5;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 2:Vn=r.vertex5;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=r.vertex1;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=r.vertex2;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=r.vertex6;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 3:Vn=r.vertex8;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=r.vertex4;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=r.vertex3;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=r.vertex7;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 4:Vn=r.vertex5;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=r.vertex7;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=r.vertex3;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=r.vertex1;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 5:Vn=r.vertex2;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=r.vertex4;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=r.vertex8;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=r.vertex6;dr=Vn.x;vr=Vn.y;mr=Vn.z;break}}else{yr=K*kn+Q*Ln+G*An;if(yr<gr){gr=yr;br=0}if(-yr<gr){gr=-yr;br=1}yr=Y*kn+Z*Ln+et*An;if(yr<gr){gr=yr;br=2}if(-yr<gr){gr=-yr;br=3}yr=tt*kn+nt*Ln+rt*An;if(yr<gr){gr=yr;br=4}if(-yr<gr){gr=-yr;br=5}switch(br){case 0:Vn=i.vertex1;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=i.vertex3;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=i.vertex4;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=i.vertex2;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 1:Vn=i.vertex6;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=i.vertex8;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=i.vertex7;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=i.vertex5;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 2:Vn=i.vertex5;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=i.vertex1;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=i.vertex2;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=i.vertex6;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 3:Vn=i.vertex8;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=i.vertex4;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=i.vertex3;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=i.vertex7;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 4:Vn=i.vertex5;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=i.vertex7;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=i.vertex3;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=i.vertex1;dr=Vn.x;vr=Vn.y;mr=Vn.z;break;case 5:Vn=i.vertex2;sr=Vn.x;or=Vn.y;ur=Vn.z;Vn=i.vertex4;ar=Vn.x;fr=Vn.y;lr=Vn.z;Vn=i.vertex8;cr=Vn.x;hr=Vn.y;pr=Vn.z;Vn=i.vertex6;dr=Vn.x;vr=Vn.y;mr=Vn.z;break}}var wr;var Er;var Sr;var xr;var Tr;var Nr;var Cr;var kr;var Lr;this.clipVertices1[0]=sr;this.clipVertices1[1]=or;this.clipVertices1[2]=ur;this.clipVertices1[3]=ar;this.clipVertices1[4]=fr;this.clipVertices1[5]=lr;this.clipVertices1[6]=cr;this.clipVertices1[7]=hr;this.clipVertices1[8]=pr;this.clipVertices1[9]=dr;this.clipVertices1[10]=vr;this.clipVertices1[11]=mr;Er=0;xr=this.clipVertices1[9];Tr=this.clipVertices1[10];Nr=this.clipVertices1[11];wn=(xr-Bn-In)*On+(Tr-jn-qn)*Mn+(Nr-Fn-Rn)*_n;for(var Ar=0;Ar<4;Ar++){Sr=Ar*3;Cr=this.clipVertices1[Sr];kr=this.clipVertices1[Sr+1];Lr=this.clipVertices1[Sr+2];En=(Cr-Bn-In)*On+(kr-jn-qn)*Mn+(Lr-Fn-Rn)*_n;if(wn>0){if(En>0){Sr=Er*3;Er++;this.clipVertices2[Sr]=Cr;this.clipVertices2[Sr+1]=kr;this.clipVertices2[Sr+2]=Lr}else{Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices2[Sr]=xr+(Cr-xr)*ir;this.clipVertices2[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices2[Sr+2]=Nr+(Lr-Nr)*ir}}else{if(En>0){Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices2[Sr]=xr+(Cr-xr)*ir;this.clipVertices2[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices2[Sr+2]=Nr+(Lr-Nr)*ir;Sr=Er*3;Er++;this.clipVertices2[Sr]=Cr;this.clipVertices2[Sr+1]=kr;this.clipVertices2[Sr+2]=Lr}}xr=Cr;Tr=kr;Nr=Lr;wn=En}wr=Er;if(wr==0)return;Er=0;Sr=(wr-1)*3;xr=this.clipVertices2[Sr];Tr=this.clipVertices2[Sr+1];Nr=this.clipVertices2[Sr+2];wn=(xr-Bn-Un)*Dn+(Tr-jn-zn)*Pn+(Nr-Fn-Wn)*Hn;for(Ar=0;Ar<wr;Ar++){Sr=Ar*3;Cr=this.clipVertices2[Sr];kr=this.clipVertices2[Sr+1];Lr=this.clipVertices2[Sr+2];En=(Cr-Bn-Un)*Dn+(kr-jn-zn)*Pn+(Lr-Fn-Wn)*Hn;if(wn>0){if(En>0){Sr=Er*3;Er++;this.clipVertices1[Sr]=Cr;this.clipVertices1[Sr+1]=kr;this.clipVertices1[Sr+2]=Lr}else{Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices1[Sr]=xr+(Cr-xr)*ir;this.clipVertices1[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices1[Sr+2]=Nr+(Lr-Nr)*ir}}else{if(En>0){Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices1[Sr]=xr+(Cr-xr)*ir;this.clipVertices1[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices1[Sr+2]=Nr+(Lr-Nr)*ir;Sr=Er*3;Er++;this.clipVertices1[Sr]=Cr;this.clipVertices1[Sr+1]=kr;this.clipVertices1[Sr+2]=Lr}}xr=Cr;Tr=kr;Nr=Lr;wn=En}wr=Er;if(wr==0)return;Er=0;Sr=(wr-1)*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];wn=(xr-Bn+In)*-On+(Tr-jn+qn)*-Mn+(Nr-Fn+Rn)*-_n;for(Ar=0;Ar<wr;Ar++){Sr=Ar*3;Cr=this.clipVertices1[Sr];kr=this.clipVertices1[Sr+1];Lr=this.clipVertices1[Sr+2];En=(Cr-Bn+In)*-On+(kr-jn+qn)*-Mn+(Lr-Fn+Rn)*-_n;if(wn>0){if(En>0){Sr=Er*3;Er++;this.clipVertices2[Sr]=Cr;this.clipVertices2[Sr+1]=kr;this.clipVertices2[Sr+2]=Lr}else{Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices2[Sr]=xr+(Cr-xr)*ir;this.clipVertices2[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices2[Sr+2]=Nr+(Lr-Nr)*ir}}else{if(En>0){Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices2[Sr]=xr+(Cr-xr)*ir;this.clipVertices2[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices2[Sr+2]=Nr+(Lr-Nr)*ir;Sr=Er*3;Er++;this.clipVertices2[Sr]=Cr;this.clipVertices2[Sr+1]=kr;this.clipVertices2[Sr+2]=Lr}}xr=Cr;Tr=kr;Nr=Lr;wn=En}wr=Er;if(wr==0)return;Er=0;Sr=(wr-1)*3;xr=this.clipVertices2[Sr];Tr=this.clipVertices2[Sr+1];Nr=this.clipVertices2[Sr+2];wn=(xr-Bn+Un)*-Dn+(Tr-jn+zn)*-Pn+(Nr-Fn+Wn)*-Hn;for(Ar=0;Ar<wr;Ar++){Sr=Ar*3;Cr=this.clipVertices2[Sr];kr=this.clipVertices2[Sr+1];Lr=this.clipVertices2[Sr+2];En=(Cr-Bn+Un)*-Dn+(kr-jn+zn)*-Pn+(Lr-Fn+Wn)*-Hn;if(wn>0){if(En>0){Sr=Er*3;Er++;this.clipVertices1[Sr]=Cr;this.clipVertices1[Sr+1]=kr;this.clipVertices1[Sr+2]=Lr}else{Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices1[Sr]=xr+(Cr-xr)*ir;this.clipVertices1[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices1[Sr+2]=Nr+(Lr-Nr)*ir}}else{if(En>0){Sr=Er*3;Er++;ir=wn/(wn-En);this.clipVertices1[Sr]=xr+(Cr-xr)*ir;this.clipVertices1[Sr+1]=Tr+(kr-Tr)*ir;this.clipVertices1[Sr+2]=Nr+(Lr-Nr)*ir;Sr=Er*3;Er++;this.clipVertices1[Sr]=Cr;this.clipVertices1[Sr+1]=kr;this.clipVertices1[Sr+2]=Lr}}xr=Cr;Tr=kr;Nr=Lr;wn=En}wr=Er;if(Xn){var Or=r;r=i;i=Or}if(wr==0)return;if(wr>4){xr=(sr+ar+cr+dr)*.25;Tr=(or+fr+hr+vr)*.25;Nr=(ur+lr+pr+mr)*.25;On=sr-xr;Mn=or-Tr;_n=ur-Nr;Dn=ar-xr;Pn=fr-Tr;Hn=lr-Nr;var Mr=0;var _r=0;var Dr=0;var Pr=0;var Hr=-this.INF;gr=this.INF;for(Ar=0;Ar<wr;Ar++){this.used[Ar]=false;Sr=Ar*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];yr=xr*On+Tr*Mn+Nr*_n;if(yr<gr){gr=yr;Mr=Ar}if(yr>Hr){Hr=yr;Dr=Ar}}this.used[Mr]=true;this.used[Dr]=true;Hr=-this.INF;gr=this.INF;for(Ar=0;Ar<wr;Ar++){if(this.used[Ar])continue;Sr=Ar*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];yr=xr*Dn+Tr*Pn+Nr*Hn;if(yr<gr){gr=yr;_r=Ar}if(yr>Hr){Hr=yr;Pr=Ar}}Sr=Mr*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];yr=(xr-Bn)*kn+(Tr-jn)*Ln+(Nr-Fn)*An;if(yr<0){n.addContactInfo(xr,Tr,Nr,kn,Ln,An,yr,r,i,0,0,false)}Sr=_r*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];yr=(xr-Bn)*kn+(Tr-jn)*Ln+(Nr-Fn)*An;if(yr<0){n.addContactInfo(xr,Tr,Nr,kn,Ln,An,yr,r,i,1,0,false)}Sr=Dr*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];yr=(xr-Bn)*kn+(Tr-jn)*Ln+(Nr-Fn)*An;if(yr<0){n.addContactInfo(xr,Tr,Nr,kn,Ln,An,yr,r,i,2,0,false)}Sr=Pr*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];yr=(xr-Bn)*kn+(Tr-jn)*Ln+(Nr-Fn)*An;if(yr<0){n.addContactInfo(xr,Tr,Nr,kn,Ln,An,yr,r,i,3,0,false)}}else{for(Ar=0;Ar<wr;Ar++){Sr=Ar*3;xr=this.clipVertices1[Sr];Tr=this.clipVertices1[Sr+1];Nr=this.clipVertices1[Sr+2];yr=(xr-Bn)*kn+(Tr-jn)*Ln+(Nr-Fn)*An;if(yr<0){n.addContactInfo(xr,Tr,Nr,kn,Ln,An,yr,r,i,Ar,0,false)}}}};OIMO.BoxCylinderCollisionDetector=function(e){OIMO.CollisionDetector.call(this);this.flip=e};OIMO.BoxCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.BoxCylinderCollisionDetector.prototype.getSep=function(e,t,n,r,i){var s;var o;var u;var a;var f;var l;var c=new OIMO.Vec3;var h;var p;var d;var v;var m;var g;var y;var b=e.position.x;var w=e.position.y;var E=e.position.z;var S=t.position.x;var x=t.position.y;var T=t.position.z;var N=S-b;var C=x-w;var k=T-E;if(N*N+C*C+k*k==0)C=.001;var L=-N;var A=-C;var O=-k;this.supportPointB(e,-L,-A,-O,c);var M=c.x;var _=c.y;var D=c.z;this.supportPointC(t,L,A,O,c);var P=c.x;var H=c.y;var B=c.z;var j=P-M;var F=H-_;var I=B-D;if(j*L+F*A+I*O<=0){return false}L=F*k-I*C;A=I*N-j*k;O=j*C-F*N;if(L*L+A*A+O*O==0){n.init(j-N,F-C,I-k);n.normalize(n);r.init((M+P)*.5,(_+H)*.5,(D+B)*.5);return true}this.supportPointB(e,-L,-A,-O,c);var q=c.x;var R=c.y;var U=c.z;this.supportPointC(t,L,A,O,c);var z=c.x;var W=c.y;var X=c.z;var V=z-q;var $=W-R;var J=X-U;if(V*L+$*A+J*O<=0){return false}s=j-N;o=F-C;u=I-k;a=V-N;f=$-C;l=J-k;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;if(L*N+A*C+O*k>0){s=j;o=F;u=I;j=V;F=$;I=J;V=s;$=o;J=u;s=M;o=_;u=D;M=q;_=R;D=U;q=s;R=o;U=u;s=P;o=H;u=B;P=z;H=W;B=X;z=s;W=o;X=u;L=-L;A=-A;O=-O}var K=0;while(true){if(++K>100){return false}this.supportPointB(e,-L,-A,-O,c);var Q=c.x;var G=c.y;var Y=c.z;this.supportPointC(t,L,A,O,c);var Z=c.x;var et=c.y;var tt=c.z;var nt=Z-Q;var rt=et-G;var it=tt-Y;if(nt*L+rt*A+it*O<=0){return false}if((F*it-I*rt)*N+(I*nt-j*it)*C+(j*rt-F*nt)*k<0){V=nt;$=rt;J=it;q=Q;R=G;U=Y;z=Z;W=et;X=tt;s=j-N;o=F-C;u=I-k;a=nt-N;f=rt-C;l=it-k;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;continue}if((rt*J-it*$)*N+(it*V-nt*J)*C+(nt*$-rt*V)*k<0){j=nt;F=rt;I=it;M=Q;_=G;D=Y;P=Z;H=et;B=tt;s=nt-N;o=rt-C;u=it-k;a=V-N;f=$-C;l=J-k;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;continue}var st=false;while(true){s=V-j;o=$-F;u=J-I;a=nt-j;f=rt-F;l=it-I;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;h=1/Math.sqrt(L*L+A*A+O*O);L*=h;A*=h;O*=h;if(L*j+A*F+O*I>=0&&!st){var ot=(F*J-I*$)*nt+(I*V-j*J)*rt+(j*$-F*V)*it;var ut=(rt*J-it*$)*N+(it*V-nt*J)*C+(nt*$-rt*V)*k;var at=(C*I-k*F)*nt+(k*j-N*I)*rt+(N*F-C*j)*it;var ft=($*I-J*F)*N+(J*j-V*I)*C+(V*F-$*j)*k;var lt=ot+ut+at+ft;if(lt<=0){ot=0;ut=($*it-J*rt)*L+(J*nt-V*it)*A+(V*rt-$*nt)*O;at=(rt*J-it*$)*L+(it*V-nt*J)*A+(nt*$-rt*V)*O;ft=(F*J-I*$)*L+(I*V-j*J)*A+(j*$-F*V)*O;lt=ut+at+ft}var ct=1/lt;p=(b*ot+M*ut+q*at+Q*ft)*ct;d=(w*ot+_*ut+R*at+G*ft)*ct;v=(E*ot+D*ut+U*at+Y*ft)*ct;m=(S*ot+P*ut+z*at+Z*ft)*ct;g=(x*ot+H*ut+W*at+et*ft)*ct;y=(T*ot+B*ut+X*at+tt*ft)*ct;st=true}this.supportPointB(e,-L,-A,-O,c);var ht=c.x;var pt=c.y;var dt=c.z;this.supportPointC(t,L,A,O,c);var vt=c.x;var mt=c.y;var gt=c.z;var yt=vt-ht;var bt=mt-pt;var wt=gt-dt;var Et=-(yt*L+bt*A+wt*O);if((yt-nt)*L+(bt-rt)*A+(wt-it)*O<=.01||Et>=0){if(st){n.init(-L,-A,-O);r.init((p+m)*.5,(d+g)*.5,(v+y)*.5);i.x=Et;return true}return false}if((bt*I-wt*F)*N+(wt*j-yt*I)*C+(yt*F-bt*j)*k<0){if((bt*J-wt*$)*N+(wt*V-yt*J)*C+(yt*$-bt*V)*k<0){j=yt;F=bt;I=wt;M=ht;_=pt;D=dt;P=vt;H=mt;B=gt}else{nt=yt;rt=bt;it=wt;Q=ht;G=pt;Y=dt;Z=vt;et=mt;tt=gt}}else{if((bt*it-wt*rt)*N+(wt*nt-yt*it)*C+(yt*rt-bt*nt)*k<0){V=yt;$=bt;J=wt;q=ht;R=pt;U=dt;z=vt;W=mt;X=gt}else{j=yt;F=bt;I=wt;M=ht;_=pt;D=dt;P=vt;H=mt;B=gt}}}}};OIMO.BoxCylinderCollisionDetector.prototype.supportPointB=function(e,t,n,r,i){var s=e.rotation.elements;var o=s[0]*t+s[3]*n+s[6]*r;var u=s[1]*t+s[4]*n+s[7]*r;var a=s[2]*t+s[5]*n+s[8]*r;var f=e.halfWidth;var l=e.halfHeight;var c=e.halfDepth;var h;var p;var d;if(o<0)h=-f;else h=f;if(u<0)p=-l;else p=l;if(a<0)d=-c;else d=c;o=s[0]*h+s[1]*p+s[2]*d+e.position.x;u=s[3]*h+s[4]*p+s[5]*d+e.position.y;a=s[6]*h+s[7]*p+s[8]*d+e.position.z;i.init(o,u,a)};OIMO.BoxCylinderCollisionDetector.prototype.supportPointC=function(e,t,n,r,i){var s=e.rotation.elements;var o=s[0]*t+s[3]*n+s[6]*r;var u=s[1]*t+s[4]*n+s[7]*r;var a=s[2]*t+s[5]*n+s[8]*r;var f=o;var l=a;var c=f*f+l*l;var h=e.radius;var p=e.halfHeight;var d;var v;var m;if(c==0){if(u<0){d=h;v=-p;m=0}else{d=h;v=p;m=0}}else{c=e.radius/Math.sqrt(c);if(u<0){d=f*c;v=-p;m=l*c}else{d=f*c;v=p;m=l*c}}o=s[0]*d+s[1]*v+s[2]*m+e.position.x;u=s[3]*d+s[4]*v+s[5]*m+e.position.y;a=s[6]*d+s[7]*v+s[8]*m+e.position.z;i.init(o,u,a)};OIMO.BoxCylinderCollisionDetector.prototype.detectCollision=function(e,t,n){var r;var i;if(this.flip){r=t;i=e}else{r=e;i=t}var s=new OIMO.Vec3;var o=new OIMO.Vec3;var u=new OIMO.Vec3;var a;if(!this.getSep(r,i,s,o,u))return;var f=r.position.x;var l=r.position.y;var c=r.position.z;var h=i.position.x;var p=i.position.y;var d=i.position.z;var v=r.halfWidth;var m=r.halfHeight;var g=r.halfDepth;var y=i.halfHeight;var b=i.radius;var w=r.normalDirectionWidth.x;var E=r.normalDirectionWidth.y;var S=r.normalDirectionWidth.z;var x=r.normalDirectionHeight.x;var T=r.normalDirectionHeight.y;var N=r.normalDirectionHeight.z;var C=r.normalDirectionDepth.x;var k=r.normalDirectionDepth.y;var L=r.normalDirectionDepth.z;var A=r.halfDirectionWidth.x;var O=r.halfDirectionWidth.y;var M=r.halfDirectionWidth.z;var _=r.halfDirectionHeight.x;var D=r.halfDirectionHeight.y;var P=r.halfDirectionHeight.z;var H=r.halfDirectionDepth.x;var B=r.halfDirectionDepth.y;var j=r.halfDirectionDepth.z;var F=i.normalDirection.x;var I=i.normalDirection.y;var q=i.normalDirection.z;var R=i.halfDirection.x;var U=i.halfDirection.y;var z=i.halfDirection.z;var W=s.x;var X=s.y;var V=s.z;var $=W*w+X*E+V*S;var J=W*x+X*T+V*N;var K=W*C+X*k+V*L;var Q=W*F+X*I+V*q;var G=$>0;var Y=J>0;var Z=K>0;var et=Q>0;if(!G)$=-$;if(!Y)J=-J;if(!Z)K=-K;if(!et)Q=-Q;var tt=0;if(Q>.999){if($>.999){if($>Q)tt=1;else tt=4}else if(J>.999){if(J>Q)tt=2;else tt=4}else if(K>.999){if(K>Q)tt=3;else tt=4}else tt=4}else{if($>.999)tt=1;else if(J>.999)tt=2;else if(K>.999)tt=3}var nt;var rt;var it;var st;var ot;var ut;var at;var ft;var lt;var ct;var ht;var pt;var dt;var vt;var mt;var gt;var yt;var bt;var wt;var Et;var St;var xt;var Tt;var Nt;var Ct;var kt;var Lt;var At;var Ot;var Mt;var _t;var Dt;var Pt;var Ht;var Bt;var jt;var Ft;var It;var qt;var Rt;var Ut;var zt;var Wt;var Xt;var Vt;var $t;var Jt;var Kt;var Qt;var Gt;var Yt;var Zt;var en;var tn;if(tt==0){n.addContactInfo(o.x,o.y,o.z,W,X,V,u.x,r,i,0,0,false)}else if(tt==4){if(et){st=h-R;ot=p-U;ut=d-z;W=-F;X=-I;V=-q}else{st=h+R;ot=p+U;ut=d+z;W=F;X=I;V=q}var nn;var rn;var sn;var on;var un;var an;var fn;var ln;var cn;var hn;var pn;var dn;var vn;Et=1;tt=0;Wt=w*W+E*X+S*V;if(Wt<Et){Et=Wt;tt=0}if(-Wt<Et){Et=-Wt;tt=1}Wt=x*W+T*X+N*V;if(Wt<Et){Et=Wt;tt=2}if(-Wt<Et){Et=-Wt;tt=3}Wt=C*W+k*X+L*V;if(Wt<Et){Et=Wt;tt=4}if(-Wt<Et){Et=-Wt;tt=5}switch(tt){case 0:vn=r.vertex1;nn=vn.x;rn=vn.y;sn=vn.z;vn=r.vertex3;on=vn.x;un=vn.y;an=vn.z;vn=r.vertex4;fn=vn.x;ln=vn.y;cn=vn.z;vn=r.vertex2;hn=vn.x;pn=vn.y;dn=vn.z;break;case 1:vn=r.vertex6;nn=vn.x;rn=vn.y;sn=vn.z;vn=r.vertex8;on=vn.x;un=vn.y;an=vn.z;vn=r.vertex7;fn=vn.x;ln=vn.y;cn=vn.z;vn=r.vertex5;hn=vn.x;pn=vn.y;dn=vn.z;break;case 2:vn=r.vertex5;nn=vn.x;rn=vn.y;sn=vn.z;vn=r.vertex1;on=vn.x;un=vn.y;an=vn.z;vn=r.vertex2;fn=vn.x;ln=vn.y;cn=vn.z;vn=r.vertex6;hn=vn.x;pn=vn.y;dn=vn.z;break;case 3:vn=r.vertex8;nn=vn.x;rn=vn.y;sn=vn.z;vn=r.vertex4;on=vn.x;un=vn.y;an=vn.z;vn=r.vertex3;fn=vn.x;ln=vn.y;cn=vn.z;vn=r.vertex7;hn=vn.x;pn=vn.y;dn=vn.z;break;case 4:vn=r.vertex5;nn=vn.x;rn=vn.y;sn=vn.z;vn=r.vertex7;on=vn.x;un=vn.y;an=vn.z;vn=r.vertex3;fn=vn.x;ln=vn.y;cn=vn.z;vn=r.vertex1;hn=vn.x;pn=vn.y;dn=vn.z;break;case 5:vn=r.vertex2;nn=vn.x;rn=vn.y;sn=vn.z;vn=r.vertex4;on=vn.x;un=vn.y;an=vn.z;vn=r.vertex8;fn=vn.x;ln=vn.y;cn=vn.z;vn=r.vertex6;hn=vn.x;pn=vn.y;dn=vn.z;break}wt=W*(nn-st)+X*(rn-ot)+V*(sn-ut);if(wt<=0)n.addContactInfo(nn,rn,sn,-W,-X,-V,wt,r,i,5,0,false);wt=W*(on-st)+X*(un-ot)+V*(an-ut);if(wt<=0)n.addContactInfo(on,un,an,-W,-X,-V,wt,r,i,6,0,false);wt=W*(fn-st)+X*(ln-ot)+V*(cn-ut);if(wt<=0)n.addContactInfo(fn,ln,cn,-W,-X,-V,wt,r,i,7,0,false);wt=W*(hn-st)+X*(pn-ot)+V*(dn-ut);if(wt<=0)n.addContactInfo(hn,pn,dn,-W,-X,-V,wt,r,i,8,0,false)}else{switch(tt){case 1:if(G){nt=f+A;rt=l+O;it=c+M;W=w;X=E;V=S}else{nt=f-A;rt=l-O;it=c-M;W=-w;X=-E;V=-S}Jt=x;Kt=T;Qt=N;en=m;Gt=C;Yt=k;Zt=L;tn=g;break;case 2:if(Y){nt=f+_;rt=l+D;it=c+P;W=x;X=T;V=N}else{nt=f-_;rt=l-D;it=c-P;W=-x;X=-T;V=-N}Jt=w;Kt=E;Qt=S;en=v;Gt=C;Yt=k;Zt=L;tn=g;break;case 3:if(Z){nt=f+H;rt=l+B;it=c+j;W=C;X=k;V=L}else{nt=f-H;rt=l-B;it=c-j;W=-C;X=-k;V=-L}Jt=w;Kt=E;Qt=S;en=v;Gt=x;Yt=T;Zt=N;tn=m;break}Et=W*F+X*I+V*q;if(Et<0)St=y;else St=-y;st=h+St*F;ot=p+St*I;ut=d+St*q;if(Q>=.999999){xt=-X;Tt=V;Nt=W}else{xt=W;Tt=X;Nt=V}St=xt*F+Tt*I+Nt*q;kt=St*F-xt;Lt=St*I-Tt;At=St*q-Nt;St=Math.sqrt(kt*kt+Lt*Lt+At*At);if(St==0)return;St=b/St;kt*=St;Lt*=St;At*=St;xt=st+kt;Tt=ot+Lt;Nt=ut+At;if(Et<-.96||Et>.96){at=F*F*1.5-.5;ft=F*I*1.5-q*.866025403;lt=F*q*1.5+I*.866025403;ct=I*F*1.5+q*.866025403;ht=I*I*1.5-.5;pt=I*q*1.5-F*.866025403;dt=q*F*1.5-I*.866025403;vt=q*I*1.5+F*.866025403;mt=q*q*1.5-.5;gt=xt;yt=Tt;bt=Nt;wt=W*(gt-nt)+X*(yt-rt)+V*(bt-it);xt=gt-wt*W-nt;Tt=yt-wt*X-rt;Nt=bt-wt*V-it;It=Jt*xt+Kt*Tt+Qt*Nt;zt=Gt*xt+Yt*Tt+Zt*Nt;if(It<-en)It=-en;else if(It>en)It=en;if(zt<-tn)zt=-tn;else if(zt>tn)zt=tn;xt=It*Jt+zt*Gt;Tt=It*Kt+zt*Yt;Nt=It*Qt+zt*Zt;gt=nt+xt;yt=rt+Tt;bt=it+Nt;n.addContactInfo(gt,yt,bt,W,X,V,wt,r,i,1,0,false);gt=kt*at+Lt*ft+At*lt;yt=kt*ct+Lt*ht+At*pt;bt=kt*dt+Lt*vt+At*mt;gt=(kt=gt)+st;yt=(Lt=yt)+ot;bt=(At=bt)+ut;wt=W*(gt-nt)+X*(yt-rt)+V*(bt-it);if(wt<=0){xt=gt-wt*W-nt;Tt=yt-wt*X-rt;Nt=bt-wt*V-it;It=Jt*xt+Kt*Tt+Qt*Nt;zt=Gt*xt+Yt*Tt+Zt*Nt;if(It<-en)It=-en;else if(It>en)It=en;if(zt<-tn)zt=-tn;else if(zt>tn)zt=tn;xt=It*Jt+zt*Gt;Tt=It*Kt+zt*Yt;Nt=It*Qt+zt*Zt;gt=nt+xt;yt=rt+Tt;bt=it+Nt;n.addContactInfo(gt,yt,bt,W,X,V,wt,r,i,2,0,false)}gt=kt*at+Lt*ft+At*lt;yt=kt*ct+Lt*ht+At*pt;bt=kt*dt+Lt*vt+At*mt;gt=(kt=gt)+st;yt=(Lt=yt)+ot;bt=(At=bt)+ut;wt=W*(gt-nt)+X*(yt-rt)+V*(bt-it);if(wt<=0){xt=gt-wt*W-nt;Tt=yt-wt*X-rt;Nt=bt-wt*V-it;It=Jt*xt+Kt*Tt+Qt*Nt;zt=Gt*xt+Yt*Tt+Zt*Nt;if(It<-en)It=-en;else if(It>en)It=en;if(zt<-tn)zt=-tn;else if(zt>tn)zt=tn;xt=It*Jt+zt*Gt;Tt=It*Kt+zt*Yt;Nt=It*Qt+zt*Zt;gt=nt+xt;yt=rt+Tt;bt=it+Nt;n.addContactInfo(gt,yt,bt,W,X,V,wt,r,i,3,0,false)}}else{Bt=xt;jt=Tt;Ft=Nt;It=W*(Bt-nt)+X*(jt-rt)+V*(Ft-it);Bt-=It*W;jt-=It*X;Ft-=It*V;if(Et>0){qt=xt+R*2;Rt=Tt+U*2;Ut=Nt+z*2}else{qt=xt-R*2;Rt=Tt-U*2;Ut=Nt-z*2}zt=W*(qt-nt)+X*(Rt-rt)+V*(Ut-it);qt-=zt*W;Rt-=zt*X;Ut-=zt*V;Ot=Bt-nt;Mt=jt-rt;_t=Ft-it;Dt=qt-nt;Pt=Rt-rt;Ht=Ut-it;xt=qt-Bt;Tt=Rt-jt;Nt=Ut-Ft;Ct=zt-It;$=Ot*Jt+Mt*Kt+_t*Qt;J=Dt*Jt+Pt*Kt+Ht*Qt;Wt=$-en;Xt=J-en;if(Wt>0){if(Xt>0)return;Vt=Wt/(Wt-Xt);Bt=Bt+xt*Vt;jt=jt+Tt*Vt;Ft=Ft+Nt*Vt;It=It+Ct*Vt;Ot=Bt-nt;Mt=jt-rt;_t=Ft-it;$=Ot*Jt+Mt*Kt+_t*Qt;xt=qt-Bt;Tt=Rt-jt;Nt=Ut-Ft;Ct=zt-It}else if(Xt>0){Vt=Wt/(Wt-Xt);qt=Bt+xt*Vt;Rt=jt+Tt*Vt;Ut=Ft+Nt*Vt;zt=It+Ct*Vt;Dt=qt-nt;Pt=Rt-rt;Ht=Ut-it;J=Dt*Jt+Pt*Kt+Ht*Qt;xt=qt-Bt;Tt=Rt-jt;Nt=Ut-Ft;Ct=zt-It}Wt=$+en;Xt=J+en;if(Wt<0){if(Xt<0)return;Vt=Wt/(Wt-Xt);Bt=Bt+xt*Vt;jt=jt+Tt*Vt;Ft=Ft+Nt*Vt;It=It+Ct*Vt;Ot=Bt-nt;Mt=jt-rt;_t=Ft-it;xt=qt-Bt;Tt=Rt-jt;Nt=Ut-Ft;Ct=zt-It}else if(Xt<0){Vt=Wt/(Wt-Xt);qt=Bt+xt*Vt;Rt=jt+Tt*Vt;Ut=Ft+Nt*Vt;zt=It+Ct*Vt;Dt=qt-nt;Pt=Rt-rt;Ht=Ut-it;xt=qt-Bt;Tt=Rt-jt;Nt=Ut-Ft;Ct=zt-It}$=Ot*Gt+Mt*Yt+_t*Zt;J=Dt*Gt+Pt*Yt+Ht*Zt;Wt=$-tn;Xt=J-tn;if(Wt>0){if(Xt>0)return;Vt=Wt/(Wt-Xt);Bt=Bt+xt*Vt;jt=jt+Tt*Vt;Ft=Ft+Nt*Vt;It=It+Ct*Vt;Ot=Bt-nt;Mt=jt-rt;_t=Ft-it;$=Ot*Gt+Mt*Yt+_t*Zt;xt=qt-Bt;Tt=Rt-jt;Nt=Ut-Ft;Ct=zt-It}else if(Xt>0){Vt=Wt/(Wt-Xt);qt=Bt+xt*Vt;Rt=jt+Tt*Vt;Ut=Ft+Nt*Vt;zt=It+Ct*Vt;Dt=qt-nt;Pt=Rt-rt;Ht=Ut-it;J=Dt*Gt+Pt*Yt+Ht*Zt;xt=qt-Bt;Tt=Rt-jt;Nt=Ut-Ft;Ct=zt-It}Wt=$+tn;Xt=J+tn;if(Wt<0){if(Xt<0)return;Vt=Wt/(Wt-Xt);Bt=Bt+xt*Vt;jt=jt+Tt*Vt;Ft=Ft+Nt*Vt;It=It+Ct*Vt}else if(Xt<0){Vt=Wt/(Wt-Xt);qt=Bt+xt*Vt;Rt=jt+Tt*Vt;Ut=Ft+Nt*Vt;zt=It+Ct*Vt}if(It<0){n.addContactInfo(Bt,jt,Ft,W,X,V,It,r,i,1,0,false)}if(zt<0){n.addContactInfo(qt,Rt,Ut,W,X,V,zt,r,i,4,0,false)}}}};OIMO.CylinderCylinderCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.CylinderCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.CylinderCylinderCollisionDetector.prototype.getSep=function(e,t,n,r,i){var s;var o;var u;var a;var f;var l;var c=new OIMO.Vec3;var h;var p;var d;var v;var m;var g;var y;var b=e.position.x;var w=e.position.y;var E=e.position.z;var S=t.position.x;var x=t.position.y;var T=t.position.z;var N=S-b;var C=x-w;var k=T-E;if(N*N+C*C+k*k==0)C=.001;var L=-N;var A=-C;var O=-k;this.supportPoint(e,-L,-A,-O,c);var M=c.x;var _=c.y;var D=c.z;this.supportPoint(t,L,A,O,c);var P=c.x;var H=c.y;var B=c.z;var j=P-M;var F=H-_;var I=B-D;if(j*L+F*A+I*O<=0){return false}L=F*k-I*C;A=I*N-j*k;O=j*C-F*N;if(L*L+A*A+O*O==0){n.init(j-N,F-C,I-k);n.normalize(n);r.init((M+P)*.5,(_+H)*.5,(D+B)*.5);return true}this.supportPoint(e,-L,-A,-O,c);var q=c.x;var R=c.y;var U=c.z;this.supportPoint(t,L,A,O,c);var z=c.x;var W=c.y;var X=c.z;var V=z-q;var $=W-R;var J=X-U;if(V*L+$*A+J*O<=0){return false}s=j-N;o=F-C;u=I-k;a=V-N;f=$-C;l=J-k;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;if(L*N+A*C+O*k>0){s=j;o=F;u=I;j=V;F=$;I=J;V=s;$=o;J=u;s=M;o=_;u=D;M=q;_=R;D=U;q=s;R=o;U=u;s=P;o=H;u=B;P=z;H=W;B=X;z=s;W=o;X=u;L=-L;A=-A;O=-O}var K=0;while(true){if(++K>100){return false}this.supportPoint(e,-L,-A,-O,c);var Q=c.x;var G=c.y;var Y=c.z;this.supportPoint(t,L,A,O,c);var Z=c.x;var et=c.y;var tt=c.z;var nt=Z-Q;var rt=et-G;var it=tt-Y;if(nt*L+rt*A+it*O<=0){return false}if((F*it-I*rt)*N+(I*nt-j*it)*C+(j*rt-F*nt)*k<0){V=nt;$=rt;J=it;q=Q;R=G;U=Y;z=Z;W=et;X=tt;s=j-N;o=F-C;u=I-k;a=nt-N;f=rt-C;l=it-k;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;continue}if((rt*J-it*$)*N+(it*V-nt*J)*C+(nt*$-rt*V)*k<0){j=nt;F=rt;I=it;M=Q;_=G;D=Y;P=Z;H=et;B=tt;s=nt-N;o=rt-C;u=it-k;a=V-N;f=$-C;l=J-k;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;continue}var st=false;while(true){s=V-j;o=$-F;u=J-I;a=nt-j;f=rt-F;l=it-I;L=o*l-u*f;A=u*a-s*l;O=s*f-o*a;h=1/Math.sqrt(L*L+A*A+O*O);L*=h;A*=h;O*=h;if(L*j+A*F+O*I>=0&&!st){var ot=(F*J-I*$)*nt+(I*V-j*J)*rt+(j*$-F*V)*it;var ut=(rt*J-it*$)*N+(it*V-nt*J)*C+(nt*$-rt*V)*k;var at=(C*I-k*F)*nt+(k*j-N*I)*rt+(N*F-C*j)*it;var ft=($*I-J*F)*N+(J*j-V*I)*C+(V*F-$*j)*k;var lt=ot+ut+at+ft;if(lt<=0){ot=0;ut=($*it-J*rt)*L+(J*nt-V*it)*A+(V*rt-$*nt)*O;at=(rt*J-it*$)*L+(it*V-nt*J)*A+(nt*$-rt*V)*O;ft=(F*J-I*$)*L+(I*V-j*J)*A+(j*$-F*V)*O;lt=ut+at+ft}var ct=1/lt;p=(b*ot+M*ut+q*at+Q*ft)*ct;d=(w*ot+_*ut+R*at+G*ft)*ct;v=(E*ot+D*ut+U*at+Y*ft)*ct;m=(S*ot+P*ut+z*at+Z*ft)*ct;g=(x*ot+H*ut+W*at+et*ft)*ct;y=(T*ot+B*ut+X*at+tt*ft)*ct;st=true}this.supportPoint(e,-L,-A,-O,c);var ht=c.x;var pt=c.y;var dt=c.z;this.supportPoint(t,L,A,O,c);var vt=c.x;var mt=c.y;var gt=c.z;var yt=vt-ht;var bt=mt-pt;var wt=gt-dt;var Et=-(yt*L+bt*A+wt*O);if((yt-nt)*L+(bt-rt)*A+(wt-it)*O<=.01||Et>=0){if(st){n.init(-L,-A,-O);r.init((p+m)*.5,(d+g)*.5,(v+y)*.5);i.x=Et;return true}return false}if((bt*I-wt*F)*N+(wt*j-yt*I)*C+(yt*F-bt*j)*k<0){if((bt*J-wt*$)*N+(wt*V-yt*J)*C+(yt*$-bt*V)*k<0){j=yt;F=bt;I=wt;M=ht;_=pt;D=dt;P=vt;H=mt;B=gt}else{nt=yt;rt=bt;it=wt;Q=ht;G=pt;Y=dt;Z=vt;et=mt;tt=gt}}else{if((bt*it-wt*rt)*N+(wt*nt-yt*it)*C+(yt*rt-bt*nt)*k<0){V=yt;$=bt;J=wt;q=ht;R=pt;U=dt;z=vt;W=mt;X=gt}else{j=yt;F=bt;I=wt;M=ht;_=pt;D=dt;P=vt;H=mt;B=gt}}}}};OIMO.CylinderCylinderCollisionDetector.prototype.supportPoint=function(e,t,n,r,i){var s=e.rotation.elements;var o=s[0]*t+s[3]*n+s[6]*r;var u=s[1]*t+s[4]*n+s[7]*r;var a=s[2]*t+s[5]*n+s[8]*r;var f=o;var l=a;var c=f*f+l*l;var h=e.radius;var p=e.halfHeight;var d;var v;var m;if(c==0){if(u<0){d=h;v=-p;m=0}else{d=h;v=p;m=0}}else{c=e.radius/Math.sqrt(c);if(u<0){d=f*c;v=-p;m=l*c}else{d=f*c;v=p;m=l*c}}o=s[0]*d+s[1]*v+s[2]*m+e.position.x;u=s[3]*d+s[4]*v+s[5]*m+e.position.y;a=s[6]*d+s[7]*v+s[8]*m+e.position.z;i.init(o,u,a)};OIMO.CylinderCylinderCollisionDetector.prototype.detectCollision=function(e,t,n){var r;var i;if(e.id<t.id){r=e;i=t}else{r=t;i=e}var s=r.position;var o=i.position;var u=s.x;var a=s.y;var f=s.z;var l=o.x;var c=o.y;var h=o.z;var p=r.halfHeight;var d=i.halfHeight;var v=r.normalDirection;var m=i.normalDirection;var g=r.halfDirection;var y=i.halfDirection;var b=r.radius;var w=i.radius;var E=v.x;var S=v.y;var x=v.z;var T=m.x;var N=m.y;var C=m.z;var k=g.x;var L=g.y;var A=g.z;var O=y.x;var M=y.y;var _=y.z;var D=u-l;var P=a-c;var H=f-h;var B;var j;var F;var I;var q;var R;var U;var z;var W;var X;var V;var $;var J;var K;var Q;var G;var Y;var Z;var et;var tt;var nt;var rt;var it;var st;var ot=new OIMO.Vec3;var ut=new OIMO.Vec3;var at=new OIMO.Vec3;if(!this.getSep(r,i,ot,ut,at))return;var ft=ot.x*E+ot.y*S+ot.z*x;var lt=ot.x*T+ot.y*N+ot.z*C;var ct=ft>0;var ht=lt>0;if(!ct)ft=-ft;if(!ht)lt=-lt;var pt=0;if(ft>.999||lt>.999){if(ft>lt)pt=1;else pt=2}var dt;var vt;var mt;var gt=at.x;var yt;var bt;var wt;var Et;var St;var xt;var Tt;var Nt;var Ct;var kt;var Lt;var At;var Ot;var Mt;var _t;var Dt;var Pt;dt=ot.x;vt=ot.y;mt=ot.z;switch(pt){case 0:n.addContactInfo(ut.x,ut.y,ut.z,dt,vt,mt,gt,r,i,0,0,false);break;case 1:if(ct){q=u+k;R=a+L;U=f+A;dt=E;vt=S;mt=x}else{q=u-k;R=a-L;U=f-A;dt=-E;vt=-S;mt=-x}rt=dt*T+vt*N+mt*C;if(rt<0)B=d;else B=-d;z=l+B*T;W=c+B*N;X=h+B*C;if(lt>=.999999){V=-vt;$=mt;J=dt}else{V=dt;$=vt;J=mt}B=V*T+$*N+J*C;D=B*T-V;P=B*N-$;H=B*C-J;B=Math.sqrt(D*D+P*P+H*H);if(B==0)break;B=w/B;D*=B;P*=B;H*=B;V=z+D;$=W+P;J=X+H;if(rt<-.96||rt>.96){yt=T*T*1.5-.5;bt=T*N*1.5-C*.866025403;wt=T*C*1.5+N*.866025403;Et=N*T*1.5+C*.866025403;St=N*N*1.5-.5;xt=N*C*1.5-T*.866025403;Tt=C*T*1.5-N*.866025403;Nt=C*N*1.5+T*.866025403;Ct=C*C*1.5-.5;kt=V;Lt=$;At=J;Ot=dt*(kt-q)+vt*(Lt-R)+mt*(At-U);V=kt-Ot*dt-q;$=Lt-Ot*vt-R;J=At-Ot*mt-U;B=V*V+$*$+J*J;if(B>b*b){B=b/Math.sqrt(B);V*=B;$*=B;J*=B}kt=q+V;Lt=R+$;At=U+J;n.addContactInfo(kt,Lt,At,dt,vt,mt,Ot,r,i,1,0,false);kt=D*yt+P*bt+H*wt;Lt=D*Et+P*St+H*xt;At=D*Tt+P*Nt+H*Ct;kt=(D=kt)+z;Lt=(P=Lt)+W;At=(H=At)+X;Ot=dt*(kt-q)+vt*(Lt-R)+mt*(At-U);if(Ot<=0){V=kt-Ot*dt-q;$=Lt-Ot*vt-R;J=At-Ot*mt-U;B=V*V+$*$+J*J;if(B>b*b){B=b/Math.sqrt(B);V*=B;$*=B;J*=B}kt=q+V;Lt=R+$;At=U+J;n.addContactInfo(kt,Lt,At,dt,vt,mt,Ot,r,i,2,0,false)}kt=D*yt+P*bt+H*wt;Lt=D*Et+P*St+H*xt;At=D*Tt+P*Nt+H*Ct;kt=(D=kt)+z;Lt=(P=Lt)+W;At=(H=At)+X;Ot=dt*(kt-q)+vt*(Lt-R)+mt*(At-U);if(Ot<=0){V=kt-Ot*dt-q;$=Lt-Ot*vt-R;J=At-Ot*mt-U;B=V*V+$*$+J*J;if(B>b*b){B=b/Math.sqrt(B);V*=B;$*=B;J*=B}kt=q+V;Lt=R+$;At=U+J;n.addContactInfo(kt,Lt,At,dt,vt,mt,Ot,r,i,3,0,false)}}else{K=V;Q=$;G=J;tt=dt*(K-q)+vt*(Q-R)+mt*(G-U);K-=tt*dt;Q-=tt*vt;G-=tt*mt;if(rt>0){Y=V+T*d*2;Z=$+N*d*2;et=J+C*d*2}else{Y=V-T*d*2;Z=$-N*d*2;et=J-C*d*2}nt=dt*(Y-q)+vt*(Z-R)+mt*(et-U);Y-=nt*dt;Z-=nt*vt;et-=nt*mt;D=q-K;P=R-Q;H=U-G;V=Y-K;$=Z-Q;J=et-G;Mt=D*D+P*P+H*H;_t=D*V+P*$+H*J;Dt=V*V+$*$+J*J;Pt=_t*_t-Dt*(Mt-b*b);if(Pt<0)break;Pt=Math.sqrt(Pt);it=(_t+Pt)/Dt;st=(_t-Pt)/Dt;if(st<it){B=it;it=st;st=B}if(st>1)st=1;if(it<0)it=0;V=K+(Y-K)*it;$=Q+(Z-Q)*it;J=G+(et-G)*it;Y=K+(Y-K)*st;Z=Q+(Z-Q)*st;et=G+(et-G)*st;K=V;Q=$;G=J;B=tt+(nt-tt)*it;nt=tt+(nt-tt)*st;tt=B;if(tt<0){n.addContactInfo(K,Q,G,dt,vt,mt,Ot,r,i,1,0,false)}if(nt<0){n.addContactInfo(Y,Z,et,dt,vt,mt,Ot,r,i,4,0,false)}}break;case 2:if(ht){z=l-O;W=c-M;X=h-_;dt=-T;vt=-N;mt=-C}else{z=l+O;W=c+M;X=h+_;dt=T;vt=N;mt=C}rt=dt*E+vt*S+mt*x;if(rt<0)B=p;else B=-p;q=u+B*E;R=a+B*S;U=f+B*x;if(ft>=.999999){V=-vt;$=mt;J=dt}else{V=dt;$=vt;J=mt}B=V*E+$*S+J*x;D=B*E-V;P=B*S-$;H=B*x-J;B=Math.sqrt(D*D+P*P+H*H);if(B==0)break;B=b/B;D*=B;P*=B;H*=B;V=q+D;$=R+P;J=U+H;if(rt<-.96||rt>.96){yt=E*E*1.5-.5;bt=E*S*1.5-x*.866025403;wt=E*x*1.5+S*.866025403;Et=S*E*1.5+x*.866025403;St=S*S*1.5-.5;xt=S*x*1.5-E*.866025403;Tt=x*E*1.5-S*.866025403;Nt=x*S*1.5+E*.866025403;Ct=x*x*1.5-.5;kt=V;Lt=$;At=J;Ot=dt*(kt-z)+vt*(Lt-W)+mt*(At-X);V=kt-Ot*dt-z;$=Lt-Ot*vt-W;J=At-Ot*mt-X;B=V*V+$*$+J*J;if(B>w*w){B=w/Math.sqrt(B);V*=B;$*=B;J*=B}kt=z+V;Lt=W+$;At=X+J;n.addContactInfo(kt,Lt,At,-dt,-vt,-mt,Ot,r,i,1,0,false);kt=D*yt+P*bt+H*wt;Lt=D*Et+P*St+H*xt;At=D*Tt+P*Nt+H*Ct;kt=(D=kt)+q;Lt=(P=Lt)+R;At=(H=At)+U;Ot=dt*(kt-z)+vt*(Lt-W)+mt*(At-X);if(Ot<=0){V=kt-Ot*dt-z;$=Lt-Ot*vt-W;J=At-Ot*mt-X;B=V*V+$*$+J*J;if(B>w*w){B=w/Math.sqrt(B);V*=B;$*=B;J*=B}kt=z+V;Lt=W+$;At=X+J;n.addContactInfo(kt,Lt,At,-dt,-vt,-mt,Ot,r,i,2,0,false)}kt=D*yt+P*bt+H*wt;Lt=D*Et+P*St+H*xt;At=D*Tt+P*Nt+H*Ct;kt=(D=kt)+q;Lt=(P=Lt)+R;At=(H=At)+U;Ot=dt*(kt-z)+vt*(Lt-W)+mt*(At-X);if(Ot<=0){V=kt-Ot*dt-z;$=Lt-Ot*vt-W;J=At-Ot*mt-X;B=V*V+$*$+J*J;if(B>w*w){B=w/Math.sqrt(B);V*=B;$*=B;J*=B}kt=z+V;Lt=W+$;At=X+J;n.addContactInfo(kt,Lt,At,-dt,-vt,-mt,Ot,r,i,3,0,false)}}else{K=V;Q=$;G=J;tt=dt*(K-z)+vt*(Q-W)+mt*(G-X);K-=tt*dt;Q-=tt*vt;G-=tt*mt;if(rt>0){Y=V+E*p*2;Z=$+S*p*2;et=J+x*p*2}else{Y=V-E*p*2;Z=$-S*p*2;et=J-x*p*2}nt=dt*(Y-z)+vt*(Z-W)+mt*(et-X);Y-=nt*dt;Z-=nt*vt;et-=nt*mt;D=z-K;P=W-Q;H=X-G;V=Y-K;$=Z-Q;J=et-G;Mt=D*D+P*P+H*H;_t=D*V+P*$+H*J;Dt=V*V+$*$+J*J;Pt=_t*_t-Dt*(Mt-w*w);if(Pt<0)break;Pt=Math.sqrt(Pt);it=(_t+Pt)/Dt;st=(_t-Pt)/Dt;if(st<it){B=it;it=st;st=B}if(st>1)st=1;if(it<0)it=0;V=K+(Y-K)*it;$=Q+(Z-Q)*it;J=G+(et-G)*it;Y=K+(Y-K)*st;Z=Q+(Z-Q)*st;et=G+(et-G)*st;K=V;Q=$;G=J;B=tt+(nt-tt)*it;nt=tt+(nt-tt)*st;tt=B;if(tt<0){n.addContactInfo(K,Q,G,-dt,-vt,-mt,tt,r,i,1,0,false)}if(nt<0){n.addContactInfo(Y,Z,et,-dt,-vt,-mt,nt,r,i,4,0,false)}}break}};OIMO.SphereBoxCollisionDetector=function(e){OIMO.CollisionDetector.call(this);this.flip=e};OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(e,t,n){var r;var i;if(this.flip){r=t;i=e}else{r=e;i=t}var s=r.position;var o=s.x;var u=s.y;var a=s.z;var f=i.position;var l=f.x;var c=f.y;var h=f.z;var p=r.radius;var d=i.normalDirectionWidth;var v=i.normalDirectionHeight;var m=i.normalDirectionDepth;var g=i.halfWidth;var y=i.halfHeight;var b=i.halfDepth;var w=o-l;var E=u-c;var S=a-h;var x=d.x*w+d.y*E+d.z*S;var T=v.x*w+v.y*E+v.z*S;var N=m.x*w+m.y*E+m.z*S;var C;var k;var L;var A;var O;var M;var _=0;if(x>g){x=g}else if(x<-g){x=-g}else{_=1}if(T>y){T=y}else if(T<-y){T=-y}else{_|=2}if(N>b){N=b}else if(N<-b){N=-b}else{_|=4}if(_==7){if(x<0){w=g+x}else{w=g-x}if(T<0){E=y+T}else{E=y-T}if(N<0){S=b+N}else{S=b-N}if(w<E){if(w<S){A=w-g;if(x<0){x=-g;w=d.x;E=d.y;S=d.z}else{x=g;w=-d.x;E=-d.y;S=-d.z}}else{A=S-b;if(N<0){N=-b;w=m.x;E=m.y;S=m.z}else{N=b;w=-m.x;E=-m.y;S=-m.z}}}else{if(E<S){A=E-y;if(T<0){T=-y;w=v.x;E=v.y;S=v.z}else{T=y;w=-v.x;E=-v.y;S=-v.z}}else{A=S-b;if(N<0){N=-b;w=m.x;E=m.y;S=m.z}else{N=b;w=-m.x;E=-m.y;S=-m.z}}}C=l+x*d.x+T*v.x+N*m.x;k=c+x*d.y+T*v.y+N*m.y;L=h+x*d.z+T*v.z+N*m.z;n.addContactInfo(o+p*w,u+p*E,a+p*S,w,E,S,A,r,i,0,0,false)}else{C=l+x*d.x+T*v.x+N*m.x;k=c+x*d.y+T*v.y+N*m.y;L=h+x*d.z+T*v.z+N*m.z;w=C-s.x;E=k-s.y;S=L-s.z;A=w*w+E*E+S*S;if(A>0&&A<p*p){A=Math.sqrt(A);O=1/A;w*=O;E*=O;S*=O;n.addContactInfo(o+p*w,u+p*E,a+p*S,w,E,S,A,r,i,0,0,false)}}};OIMO.SphereCylinderCollisionDetector=function(e){OIMO.CollisionDetector.call(this);this.flip=e};OIMO.SphereCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereCylinderCollisionDetector.prototype.detectCollision=function(e,t,n){var r;var i;if(this.flip){r=t;i=e}else{r=e;i=t}var s=r.position;var o=s.x;var u=s.y;var a=s.z;var f=i.position;var l=f.x;var c=f.y;var h=f.z;var p=i.normalDirection.x;var d=i.normalDirection.y;var v=i.normalDirection.z;var m=r.radius;var g=i.radius;var y=m+g;var b=i.halfHeight;var w=o-l;var E=u-c;var S=a-h;var x=w*p+E*d+S*v;if(x<-b-m||x>b+m)return;var T=l+x*p;var N=c+x*d;var C=h+x*v;var k=o-T;var L=u-N;var A=a-C;var O=k*k+L*L+A*A;if(O>y*y)return;if(O>g*g){O=g/Math.sqrt(O);k*=O;L*=O;A*=O}if(x<-b)x=-b;else if(x>b)x=b;T=l+x*p+k;N=c+x*d+L;C=h+x*v+A;w=T-o;E=N-u;S=C-a;O=w*w+E*E+S*S;var M;if(O>0&&O<m*m){O=Math.sqrt(O);M=1/O;w*=M;E*=M;S*=M;n.addContactInfo(o+w*m,u+E*m,a+S*m,w,E,S,O-m,r,i,0,0,false)}};OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(e,t,n){var r=e;var i=t;var s=r.position;var o=i.position;var u=o.x-s.x;var a=o.y-s.y;var f=o.z-s.z;var l=u*u+a*a+f*f;var c=r.radius;var h=i.radius;var p=c+h;if(l>0&&l<p*p){l=Math.sqrt(l);var d=1/l;u*=d;a*=d;f*=d;n.addContactInfo(s.x+u*c,s.y+a*c,s.z+f*c,u,a,f,l-p,r,i,0,0,false)}};OIMO.Pair=function(){this.shape1=null;this.shape2=null};OIMO.Proxy=function(e,t,n,r,i,s){this.minX=e||0;this.maxX=t||0;this.minY=n||0;this.maxY=r||0;this.minZ=i||0;this.maxZ=s||0;this.parent=null};OIMO.Proxy.prototype={constructor:OIMO.Proxy,init:function(e,t,n,r,i,s){this.minX=e||0;this.maxX=t||0;this.minY=n||0;this.maxY=r||0;this.minZ=i||0;this.maxZ=s||0},intersect:function(e){return this.maxX>e.minX&&this.minX<e.maxX&&this.maxY>e.minY&&this.minY<e.maxY&&this.maxZ>e.minZ&&this.minZ<e.maxZ}};OIMO.BroadPhase=function(){this.types=0;this.numPairChecks=0;this.numPairs=0;this.bufferSize=256;this.pairs=[];this.pairs.length=this.bufferSize;for(var e=0;e<this.bufferSize;e++){this.pairs[e]=new OIMO.Pair}};OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(e){throw new Error("Inheritance error.")},addProxy:function(e){throw new Error("Inheritance error.")},removeProxy:function(e){throw new Error("Inheritance error.")},isAvailablePair:function(e,t){var n=e.parent;var r=t.parent;if(n==r||(n.type==OIMO.BODY_STATIC||n.sleeping)&&(r.type==OIMO.BODY_STATIC||r.sleeping)){return false}var i;if(n.numJoints<r.numJoints)i=n.jointList;else i=r.jointList;while(i!=null){var s=i.parent;if(!s.allowCollision&&(s.body1==n&&s.body2==r||s.body1==r&&s.body2==n)){return false}i=i.next}return true},detectPairs:function(){while(this.numPairs>0){var e=this.pairs[--this.numPairs];e.shape1=null;e.shape2=null}this.collectPairs()},collectPairs:function(){throw new Error("Inheritance error.")},addPair:function(e,t){if(this.numPairs==this.bufferSize){var n=this.bufferSize<<1;var r=[];for(var i=0;i<this.bufferSize;i++){r[i]=this.pairs[i]}for(i=this.bufferSize;i<n;i++){r[i]=new OIMO.Pair}this.pairs=r;this.bufferSize=n}var s=this.pairs[this.numPairs++];s.shape1=e;s.shape2=t}};OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=1;this.numProxies=0;this.proxyPool=[];this.proxyPool.length=OIMO.WORLD_MAX_SHAPES};OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.BruteForceBroadPhase.prototype.addProxy=function(e){this.proxyPool[this.numProxies]=e;this.numProxies++};OIMO.BruteForceBroadPhase.prototype.removeProxy=function(e){var t=-1;for(var n=0;n<this.numProxies;n++){if(this.proxyPool[n]==e){t=n;break}}if(t==-1){return}for(var r=t;r<this.numProxies-1;r++){this.proxyPool[r]=this.proxyPool[r+1]}this.proxyPool[this.numProxies]=null;this.numProxies--};OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){this.numPairChecks=this.numProxies*(this.numProxies-1)>>1;for(var e=0;e<this.numProxies;e++){var t=this.proxyPool[e];var n=t.parent;for(var r=e+1;r<this.numProxies;r++){var i=this.proxyPool[r];var s=i.parent;if(t.maxX<i.minX||t.minX>i.maxX||t.maxY<i.minY||t.minY>i.maxY||t.maxZ<i.minZ||t.minZ>i.maxZ||!this.isAvailablePair(n,s)){continue}this.addPair(n,s)}}};OIMO.SweepAndPruneBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=2;this.numProxies=0;this.sortAxis=0;this.proxyPoolAxis=[];this.proxyPoolAxis.length=3;this.proxyPoolAxis[0]=[];this.proxyPoolAxis[1]=[];this.proxyPoolAxis[2]=[];this.proxyPoolAxis[0].length=OIMO.WORLD_MAX_SHAPES;this.proxyPoolAxis[1].length=OIMO.WORLD_MAX_SHAPES;this.proxyPoolAxis[2].length=OIMO.WORLD_MAX_SHAPES};OIMO.SweepAndPruneBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.SweepAndPruneBroadPhase.prototype.addProxy=function(e){this.proxyPoolAxis[0][this.numProxies]=e;this.proxyPoolAxis[1][this.numProxies]=e;this.proxyPoolAxis[2][this.numProxies]=e;this.numProxies++};OIMO.SweepAndPruneBroadPhase.prototype.removeProxy=function(e){this.removeProxyAxis(e,this.proxyPoolAxis[0]);this.removeProxyAxis(e,this.proxyPoolAxis[1]);this.removeProxyAxis(e,this.proxyPoolAxis[2]);this.numProxies--};OIMO.SweepAndPruneBroadPhase.prototype.collectPairs=function(){this.numPairChecks=0;var e=this.proxyPoolAxis[this.sortAxis];var t;if(this.sortAxis==0){this.insertionSortX(e);this.sweepX(e)}else if(this.sortAxis==1){this.insertionSortY(e);this.sweepY(e)}else{this.insertionSortZ(e);this.sweepZ(e)}};OIMO.SweepAndPruneBroadPhase.prototype.sweepX=function(e){var t;var n=0;var r=0;var i=0;var s=0;var o=0;var u=0;var a=1/this.numProxies;var f=OIMO.BODY_STATIC;for(var l=0,c=this.numProxies;l<c;l++){var h=e[l];t=h.minX+h.maxX;n+=t;r+=t*t;t=h.minY+h.maxY;i+=t;s+=t*t;t=h.minZ+h.maxZ;o+=t;u+=t*t;var p=h.parent;for(var d=l+1;d<c;d++){var v=e[d];this.numPairChecks++;if(h.maxX<v.minX){break}var m=v.parent;if(h.maxY<v.minY||h.minY>v.maxY||h.maxZ<v.minZ||h.minZ>v.maxZ||!this.isAvailablePair(p,m)){continue}this.addPair(p,m)}}n=r-n*n*a;i=s-i*i*a;o=u-o*o*a;if(n>i){if(n>o){this.sortAxis=0}else{this.sortAxis=2}}else if(i>o){this.sortAxis=1}else{this.sortAxis=2}};OIMO.SweepAndPruneBroadPhase.prototype.sweepY=function(e){var t;var n=0;var r=0;var i=0;var s=0;var o=0;var u=0;var a=1/this.numProxies;var f=OIMO.BODY_STATIC;for(var l=0,c=this.numProxies;l<c;l++){var h=e[l];t=h.minX+h.maxX;n+=t;r+=t*t;t=h.minY+h.maxY;i+=t;s+=t*t;t=h.minZ+h.maxZ;o+=t;u+=t*t;var p=h.parent;for(var d=l+1;d<c;d++){var v=e[d];this.numPairChecks++;if(h.maxY<v.minY){break}var m=v.parent;if(h.maxX<v.minX||h.minX>v.maxX||h.maxZ<v.minZ||h.minZ>v.maxZ||!this.isAvailablePair(p,m)){continue}this.addPair(p,m)}}n=r-n*n*a;i=s-i*i*a;o=u-o*o*a;if(n>i){if(n>o){this.sortAxis=0}else{this.sortAxis=2}}else if(i>o){this.sortAxis=1}else{this.sortAxis=2}};OIMO.SweepAndPruneBroadPhase.prototype.sweepZ=function(e){var t;var n=0;var r=0;var i=0;var s=0;var o=0;var u=0;var a=1/this.numProxies;var f=OIMO.BODY_STATIC;for(var l=0,c=this.numProxies;l<c;l++){var h=e[l];t=h.minX+h.maxX;n+=t;r+=t*t;t=h.minY+h.maxY;i+=t;s+=t*t;t=h.minZ+h.maxZ;o+=t;u+=t*t;var p=h.parent;for(var d=l+1;d<c;d++){var v=e[d];this.numPairChecks++;if(h.maxZ<v.minZ){break}var m=v.parent;if(h.maxX<v.minX||h.minX>v.maxX||h.maxY<v.minY||h.minY>v.maxY||!this.isAvailablePair(p,m)){continue}this.addPair(p,m)}}n=r-n*n*a;i=s-i*i*a;o=u-o*o*a;if(n>i){if(n>o){this.sortAxis=0}else{this.sortAxis=2}}else if(i>o){this.sortAxis=1}else{this.sortAxis=2}};OIMO.SweepAndPruneBroadPhase.prototype.removeProxyAxis=function(e,t){var n=-1;for(var r=0,i=this.numProxies;r<i;r++){if(t[r]==e){n=r;break}}if(n==-1){return}for(var s=n;s<i-1;s++){t[s]=t[s+1]}t[this.numProxies]=null};OIMO.SweepAndPruneBroadPhase.prototype.insertionSortX=function(e){if(this.numProxies==1)return;for(var t=1,n=this.numProxies;t<n;t++){var r=e[t];if(e[t-1].minX>r.minX){var i=t;do{e[i]=e[i-1];i--}while(i>0&&e[i-1].minX>r.minX);e[i]=r}}};OIMO.SweepAndPruneBroadPhase.prototype.insertionSortY=function(e){if(this.numProxies==1)return;for(var t=1,n=this.numProxies;t<n;t++){var r=e[t];if(e[t-1].minY>r.minY){var i=t;do{e[i]=e[i-1];i--}while(i>0&&e[i-1].minY>r.minY);e[i]=r}}};OIMO.SweepAndPruneBroadPhase.prototype.insertionSortZ=function(e){if(this.numProxies==1)return;for(var t=1,n=this.numProxies;t<n;t++){var r=e[t];if(e[t-1].minZ>r.minZ){var i=t;do{e[i]=e[i-1];i--}while(i>0&&e[i-1].minZ>r.minZ);e[i]=r}}}